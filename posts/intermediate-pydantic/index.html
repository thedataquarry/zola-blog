<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="light dark" name=color-scheme><title>Why Pydantic just keeps getting better | The Data Quarry</title><meta content="Why Pydantic just keeps getting better" property=og:title><meta content="Prashanth Rao" name=author><meta content=en_US property=og:locale><meta content="Understanding the latest features and optimizations of Pydantic v2 that provide a 12x speedup over v1" name=description><meta content="Understanding the latest features and optimizations of Pydantic v2 that provide a 12x speedup over v1" property=og:description><link href=https://thedataquarry.github.io/posts/intermediate-pydantic/ rel=canonical><meta content=https://thedataquarry.github.io/posts/intermediate-pydantic/ property=og:url><meta content="The Data Quarry" property=og:site_name><meta content=https://thedataquarry.github.io/img/dataquarry-banner.png property=og:image><meta content=article property=og:type><meta content=2023-12-02T00:00:00+00:00 property=article:published_time><meta " content=summary_large_image name=twitter:card><meta content=https://thedataquarry.github.io/img/dataquarry-banner.png property=twitter:image><meta content="Why Pydantic just keeps getting better" property=twitter:title><meta content=@tech_optimist name=twitter:site><meta content="Understanding the latest features and optimizations of Pydantic v2 that provide a 12x speedup over v1" name=description><title>Why Pydantic just keeps getting better</title><link href=/img/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/img/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/img/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><style>body{--primary-color:#376dd9;--primary-pale-color:#698bcf1c;--inline-code-color:#444;--text-color:#444;--text-pale-color:#545967;--bg-color:#fff;--highlight-mark-color:#5f75b045;--callout-note-color:#3e70d6;--callout-important-color:#7a46cd;--callout-warning-color:#d3822b;--callout-alert-color:#d43f3f;--callout-question-color:#3089b5;--callout-tip-color:#35a06b;--main-font:"IBMPlexSans",ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--code-font:"IBMPlexMono",ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--homepage-max-width:750px;--main-max-width:750px;--avatar-size:175px;--paragraph-font-size:16px;--paragraph-line-height:1.5em;--aside-font-size:16px;--img-border-radius:4px;--inline-code-border-radius:2px}body.dark{--primary-color:#689afd;--primary-pale-color:#93acdd1c;--inline-code-color:#d2d2d2;--text-color:#ddd;--text-pale-color:#a0a0a0;--bg-color:#202124;--highlight-mark-color:#5f75b045;--callout-note-color:#698bcf;--callout-important-color:#9374c5;--callout-warning-color:#c99054;--callout-alert-color:#d35757;--callout-question-color:#5091b2;--callout-tip-color:#3ea06f}</style><link href=/main.css rel=stylesheet><script async data-website-id=01228822-c189-4b8a-93ba-733d045bf346 src=https://analytics.eu.umami.is/script.js></script><body class=post><script>if(localStorage.getItem('theme')=='dark'){document.body.classList.add('dark');const a=document.querySelector('link#hl');if(a)a.href='/hl-dark.css'}</script><header class=blur><div id=header-wrapper><nav><a href=/>The Data Quarry</a><button aria-label="toggle expand" class=separator id=toggler>::</button><span class="wrap left fold">{</span><a href=/posts>blog</a><span class="wrap-separator fold">,</span><a class=fold href=/talks>talks</a><span class="wrap-separator fold">,</span><a class=fold href=/projects>projects</a><span class="wrap right fold">} ;</span></nav><div id=btns><a rel="noreferrer noopener" aria-label=GitHub href=https://github.com/prrao87 target=_blank> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12" fill=currentColor></path></svg> </a><a rel="noreferrer noopener" aria-label=Twitter href=https://twitter.com/tech_optimist target=_blank> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>Twitter</title><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z" fill=currentColor></path></svg> </a><a rel="noreferrer noopener" aria-label=LinkedIn href=https://www.linkedin.com/in/prrao87 target=_blank> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z" fill=currentColor></path></svg> </a><a aria-label="Buy me a coffee" rel="noreferrer noopener" href=https://www.buymeacoffee.com/prrao87 target=_blank> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>Buy Me A Coffee</title><path d="M20.216 6.415l-.132-.666c-.119-.598-.388-1.163-1.001-1.379-.197-.069-.42-.098-.57-.241-.152-.143-.196-.366-.231-.572-.065-.378-.125-.756-.192-1.133-.057-.325-.102-.69-.25-.987-.195-.4-.597-.634-.996-.788a5.723 5.723 0 00-.626-.194c-1-.263-2.05-.36-3.077-.416a25.834 25.834 0 00-3.7.062c-.915.083-1.88.184-2.75.5-.318.116-.646.256-.888.501-.297.302-.393.77-.177 1.146.154.267.415.456.692.58.36.162.737.284 1.123.366 1.075.238 2.189.331 3.287.37 1.218.05 2.437.01 3.65-.118.299-.033.598-.073.896-.119.352-.054.578-.513.474-.834-.124-.383-.457-.531-.834-.473-.466.074-.96.108-1.382.146-1.177.08-2.358.082-3.536.006a22.228 22.228 0 01-1.157-.107c-.086-.01-.18-.025-.258-.036-.243-.036-.484-.08-.724-.13-.111-.027-.111-.185 0-.212h.005c.277-.06.557-.108.838-.147h.002c.131-.009.263-.032.394-.048a25.076 25.076 0 013.426-.12c.674.019 1.347.067 2.017.144l.228.031c.267.04.533.088.798.145.392.085.895.113 1.07.542.055.137.08.288.111.431l.319 1.484a.237.237 0 01-.199.284h-.003c-.037.006-.075.01-.112.015a36.704 36.704 0 01-4.743.295 37.059 37.059 0 01-4.699-.304c-.14-.017-.293-.042-.417-.06-.326-.048-.649-.108-.973-.161-.393-.065-.768-.032-1.123.161-.29.16-.527.404-.675.701-.154.316-.199.66-.267 1-.069.34-.176.707-.135 1.056.087.753.613 1.365 1.37 1.502a39.69 39.69 0 0011.343.376.483.483 0 01.535.53l-.071.697-1.018 9.907c-.041.41-.047.832-.125 1.237-.122.637-.553 1.028-1.182 1.171-.577.131-1.165.2-1.756.205-.656.004-1.31-.025-1.966-.022-.699.004-1.556-.06-2.095-.58-.475-.458-.54-1.174-.605-1.793l-.731-7.013-.322-3.094c-.037-.351-.286-.695-.678-.678-.336.015-.718.3-.678.679l.228 2.185.949 9.112c.147 1.344 1.174 2.068 2.446 2.272.742.12 1.503.144 2.257.156.966.016 1.942.053 2.892-.122 1.408-.258 2.465-1.198 2.616-2.657.34-3.332.683-6.663 1.024-9.995l.215-2.087a.484.484 0 01.39-.426c.402-.078.787-.212 1.074-.518.455-.488.546-1.124.385-1.766zm-1.478.772c-.145.137-.363.201-.578.233-2.416.359-4.866.54-7.308.46-1.748-.06-3.477-.254-5.207-.498-.17-.024-.353-.055-.47-.18-.22-.236-.111-.71-.054-.995.052-.26.152-.609.463-.646.484-.057 1.046.148 1.526.22.577.088 1.156.159 1.737.212 2.48.226 5.002.19 7.472-.14.45-.06.899-.13 1.345-.21.399-.072.84-.206 1.08.206.166.281.188.657.162.974a.544.544 0 01-.169.364zm-6.159 3.9c-.862.37-1.84.788-3.109.788a5.884 5.884 0 01-1.569-.217l.877 9.004c.065.78.717 1.38 1.5 1.38 0 0 1.243.065 1.658.065.447 0 1.786-.065 1.786-.065.783 0 1.434-.6 1.499-1.38l.94-9.95a3.996 3.996 0 00-1.322-.238c-.826 0-1.491.284-2.26.613z" fill=currentColor></path></svg> </a><button aria-label="theme switch" data-moon-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill="currentColor"></path></svg>' data-sun-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12C18 15.3137 15.3137 18 12 18ZM12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM11 1H13V4H11V1ZM11 20H13V23H11V20ZM3.51472 4.92893L4.92893 3.51472L7.05025 5.63604L5.63604 7.05025L3.51472 4.92893ZM16.9497 18.364L18.364 16.9497L20.4853 19.0711L19.0711 20.4853L16.9497 18.364ZM19.0711 3.51472L20.4853 4.92893L18.364 7.05025L16.9497 5.63604L19.0711 3.51472ZM5.63604 16.9497L7.05025 18.364L4.92893 20.4853L3.51472 19.0711L5.63604 16.9497ZM23 11V13H20V11H23ZM4 11V13H1V11H4Z" fill="currentColor"></path></svg>' id=theme-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill=currentColor></path></svg></button><button aria-label="table of content" id=toc-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M3 4H21V6H3V4ZM3 11H15V13H3V11ZM3 18H21V20H3V18Z" fill=currentColor></path></svg></button></div></div></header><div id=wrapper><div id=blank></div><aside class=blur><nav><ul><li><a class=h2 href=#12x-possible-speedup-over-v1-with-more-to-come>12x possible speedup over v1, with more to come</a><li><a class=h2 href=#uncovering-the-pydantic-stack>Uncovering the Pydantic stack</a> <ul><li><a class=h3 href=#rust-crates>Rust crates</a><li><a class=h3 href=#pyo3>PyO3</a><li><a class=h3 href=#maturin>Maturin</a><li><a class=h3 href=#pydantic>Pydantic</a></ul><li><a class=h2 href=#performance-benchmark>Performance benchmark</a> <ul><li><a class=h3 href=#dataset>Dataset</a><li><a class=h3 href=#simple-validator>Simple validator</a><li><a class=h3 href=#improved-validator>Improved validator</a><li><a class=h3 href=#benchmark-code>Benchmark code</a></ul><li><a class=h2 href=#reasons-for-performance-improvement>Reasons for performance improvement</a> <ul><li><a class=h3 href=#improvements-at-the-rust-level>Improvements at the Rust level</a><li><a class=h3 href=#improvements-at-the-python-level>Improvements at the Python level</a></ul><li><a class=h2 href=#towards-a-nogil-future>Towards a nogil future</a><li><a class=h2 href=#conclusions>Conclusions</a><li><a class=h2 href=#code>Code</a> <ul><li><a class=h3 href=#acknowledgements>Acknowledgements</a></ul></ul></nav><button aria-label="back to top" id=back-to-top><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M11.9997 10.8284L7.04996 15.7782L5.63574 14.364L11.9997 8L18.3637 14.364L16.9495 15.7782L11.9997 10.8284Z" fill=currentColor></path></svg></button></aside><main><div><div data-check-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z" fill="currentColor"></path></svg>' data-copy-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill="currentColor"></path></svg>' id=copy-cfg style=display:none></div><article data-backlink-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M9.41421 8L18.0208 16.6066L16.6066 18.0208L8 9.41421V17H6V6H17V8H9.41421Z" fill="currentColor"></path></svg>' class=prose><h1>Why Pydantic just keeps getting better</h1><div id=post-info><div id=date><span id=publish>2023-12-02</span></div><div id=tags><a href=https://thedataquarry.github.io/tags/pydantic><span>#</span>pydantic</a><a href=https://thedataquarry.github.io/tags/rust><span>#</span>rust</a></div></div><h2 id=12x-possible-speedup-over-v1-with-more-to-come>12x possible speedup over v1, with more to come<a aria-label="Anchor link for: 12x-possible-speedup-over-v1-with-more-to-come" class=zola-anchor href=#12x-possible-speedup-over-v1-with-more-to-come>#</a></h2><p><a rel="nofollow noreferrer" href=https://docs.pydantic.dev/latest/>Pydantic</a> is a data parsing, transformation and validation library for Python that’s become integral to the PyData ecosystem. Version 2 of Pydantic, which came out in June 2023, had its core rewritten in Rust, which I described in some detail in my <a href=../why-pydantic-v2-matters/>previous post</a>.<p>It’s been really fascinating to watch each major release of Pydantic v2 lately, as they’ve been showing incremental performance improvements over prior releases.<figure><img alt="Performance comparison of each successive Pydantic v2 major release" loading=lazy src=pydantic-benchmark-results.png><figcaption>Performance comparison of each successive Pydantic v2 major release</figcaption></figure><p>As can be seen, there’s not only a <strong>12x</strong> speedup over v1.10 in the latest release (2.5.2 as of writing this post) – there’s also a <strong>12%</strong> improvement over the first v2 release. These improvements are likely due to a variety of optimizations and new features at the lower levels in Rust.<p>The goal of this post is to describe the details of the benchmark whose results are shown above, and also to uncover the underlying components of <code>pydantic-core</code> (the part that’s written in Rust) that contribute to the overall performance improvement that we see at the Python level.<blockquote class="callout warning"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M12.865 3.00017L22.3912 19.5002C22.6674 19.9785 22.5035 20.5901 22.0252 20.8662C21.8732 20.954 21.7008 21.0002 21.5252 21.0002H2.47266C1.92037 21.0002 1.47266 20.5525 1.47266 20.0002C1.47266 19.8246 1.51886 19.6522 1.60663 19.5002L11.1329 3.00017C11.4091 2.52187 12.0206 2.358 12.4989 2.63414C12.651 2.72191 12.7772 2.84815 12.865 3.00017ZM4.20471 19.0002H19.7932L11.9989 5.50017L4.20471 19.0002ZM10.9989 16.0002H12.9989V18.0002H10.9989V16.0002ZM10.9989 9.00017H12.9989V14.0002H10.9989V9.00017Z" fill=currentColor></path></svg></div><div class=content><p>It’s assumed you know what the purpose of Pydantic is, and have some familiarity with its API – if not, check out the <a href=../why-pydantic-v2-matters/>first post</a> in this series.</div></blockquote><h2 id=uncovering-the-pydantic-stack>Uncovering the Pydantic stack<a aria-label="Anchor link for: uncovering-the-pydantic-stack" class=zola-anchor href=#uncovering-the-pydantic-stack>#</a></h2><p>Before we go into the benchmark and the reasons for the performance gain, it’s worth spending a bit of time to really understand Pydantic’s internals.<p>As we know, v2 has a new design that splits it up into two Python packages:<ul><li><code>pydantic</code>: Written in Python and is user-facing<li><code>pydantic-core</code>: A base Python package that contains the core functionality for serialization and validation, whose core is based on Rust</ul><p>The Python API we, the end users, are used to interfacing with, is built directly on top of <code>pydantic-core</code>. However, it’s important to understand that <code>pydantic-core</code> itself is not a monolithic entity.<figure><img alt="The multi-layer stack of Pydantic v2" loading=lazy src=pydantic-stack.png><figcaption>The multi-layer stack of Pydantic v2</figcaption></figure><p>The lowest layers of Pydantic are composed of a multitude of Rust crates that form what we know as <code>pydantic-core</code>. The top (user-facing) layer is the Python API. The intermediate layers, PyO3 and <code>maturin</code>, are explained in more detail below.<h3 id=rust-crates>Rust crates<a aria-label="Anchor link for: rust-crates" class=zola-anchor href=#rust-crates>#</a></h3><p><a rel="nofollow noreferrer" href=https://github.com/pydantic/speedate><code>speedate</code></a> is a datetime and time duration parser that functions at the Rust level. <a rel="nofollow noreferrer" href=https://github.com/pydantic/jiter><code>jiter</code></a> is an iterable JSON parser that offers multiple interfaces for handling JSON data (enums, iterators and strings) in Rust. The <a rel="nofollow noreferrer" href=https://github.com/rust-lang/regex>regex</a> crate is the regex engine that’s maintained by the Rust foundation. There are many other base crates as well, coming together to compose what we know as <code>pydantic-core</code>.<p>Earlier versions of Pydantic v2 used <code>orjson</code> (a Python library), which itself depended on the age-old <a rel="nofollow noreferrer" href=https://github.com/serde-rs/json><code>serde_json</code></a> Rust crate for JSON parsing. <code>serde_json</code> is among the most downloaded Rust crates, with almost 200 million downloads as of 2023, so the fact that the Pydantic team decided to move away from such a mature package in the Rust ecosystem to write their own JSON parser indicates how critical this part of the stack is to Pydantic’s performance.<p>As Samuel Colvin, the creator of Pydantic, <a href="https://x.com/samuel_colvin/status/1720153791767429473?s=20" rel="nofollow noreferrer">explains</a>:<blockquote><p><code>orjson</code> uses serde-json, to deserialize JSON, then takes some serious liberties with the Python C API/PyO3 FFI interface for performance. <code>jiter</code>, an alternative to <code>serde_json</code>, is significantly faster, and also allows you to get the position of a value even if JSON parsing passes – so Pydantic validation errors can show the JSON file positions.</blockquote><p>With JSON being the key serialization and deserialization component in Pydantic workflows, and with Pydantic being used to validate ever larger amounts of data, every ounce of performance matters!<h3 id=pyo3>PyO3<a aria-label="Anchor link for: pyo3" class=zola-anchor href=#pyo3>#</a></h3><p><a rel="nofollow noreferrer" href=https://github.com/PyO3/pyo3>PyO3</a> is a Rust crate that allows Rust code to be called from Python, via generated Rust bindings. It’s a fork of <code>rust-cpython</code>, which aims to offer a Rust wrapper around the <code>libpython</code> C API so that Rust code can be called from Python. PyO3 is now a mature project with a large community, and is the most common way to write performant Python extensions in Rust.<p>Recent versions of Pydantic have begun applying <strong>profile-guided optimization</strong> (PGO) during <code>pydantic-core</code> compilation. As described in <a rel="nofollow noreferrer" href=https://doc.rust-lang.org/rustc/profile-guided-optimization.html>the docs</a>, PGO collects data about the typical execution of a binary and uses this data to inform optimizations such as inlining, machine code layout, register allocation, and branch prediction. The result is that the <code>pydantic-core</code> bindings, even prior to being called in Python, are already optimized for the typical execution patterns of Pydantic.<h3 id=maturin>Maturin<a aria-label="Anchor link for: maturin" class=zola-anchor href=#maturin>#</a></h3><p><a rel="nofollow noreferrer" href=https://github.com/PyO3/maturin>Maturin</a> is a utility that’s used to generate native Python modules (wheels) from Rust crates that were built with PyO3. The result of using Maturin is that the underlying Rust code in <code>pydantic-core</code> can be made available as a Python package that’s itself imported into <code>pydantic</code>, to be available to end users.<h3 id=pydantic>Pydantic<a aria-label="Anchor link for: pydantic" class=zola-anchor href=#pydantic>#</a></h3><p>The user-facing part of Pydantic, written in Python, is essentially a wrapper around <code>pydantic-core</code>. None of the heavy-lifting is done at the Python level – all the parsing, validation and serialization is done at the Rust level, so Python users can continue about their business as usual without worrying about Rust.<hr><h2 id=performance-benchmark>Performance benchmark<a aria-label="Anchor link for: performance-benchmark" class=zola-anchor href=#performance-benchmark>#</a></h2><p>This section covers the benchmark that was run to study the performance improvements in each major release of v2, with the reference version (for comparison) being v1.10. The benchmark code is available <a rel="nofollow noreferrer" href=https://github.com/prrao87/pydantic-benchmarks>here</a>.<h3 id=dataset>Dataset<a aria-label="Anchor link for: dataset" class=zola-anchor href=#dataset>#</a></h3><p>The dataset used is a familiar one if you’ve read my previous blogs: A wine reviews dataset from Kaggle. It consists of 129,971 wine reviews from the Wine Enthusiast magazine, made available in newline-delimited JSON as shown below. Refer to the <a rel="nofollow noreferrer" href=https://www.kaggle.com/datasets/zynicide/wine-reviews>Kaggle source</a> for more detailed information on the dataset and how it was scraped.<p>An example JSON line representing a single wine review, when read into Python, is shown below. Note how the comments in each line specify what we <em>want</em>, vs. what’s actually present in the data.<pre class=language-py data-lang=py style=background:#2e3440;color:#d8dee9><code class=language-py data-lang=py><span>{
</span><span>    </span><span style=color:#a3be8c>"id"</span><span style=color:#eceff4>: </span><span style=color:#b48ead>40825</span><span style=color:#eceff4>,  </span><span style=color:#616e88># This field is compulsory (not nullable)
</span><span>    </span><span style=color:#a3be8c>"points"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"90"</span><span style=color:#eceff4>,  </span><span style=color:#616e88># Bad value: This should be an integer
</span><span>    </span><span style=color:#a3be8c>"title"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Castello San Donato in Perano 2009 Riserva  (Chianti Classico)"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"description"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Made from a blend of 85% Sangiovese and 15% Merlot, this ripe wine delivers soft plum, black currants, clove and cracked pepper sensations accented with coffee and espresso notes. A backbone of firm tannins give structure. Drink now through 2019."</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"taster_name"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Kerin O'Keefe"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"taster_twitter_handle"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"@kerinokeefe"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"price"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"30.0"</span><span style=color:#eceff4>,  </span><span style=color:#616e88># Bad value: This should be a float
</span><span>    </span><span style=color:#a3be8c>"designation"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Riserva"</span><span style=color:#eceff4>, </span><span style=color:#616e88># Rename this to "vineyard"
</span><span>    </span><span style=color:#a3be8c>"variety"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Red Blend"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"region_1"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"null"</span><span style=color:#eceff4>, </span><span style=color:#616e88># Drop string 'null' fields
</span><span>    </span><span style=color:#a3be8c>"region_2"</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>None</span><span style=color:#eceff4>, </span><span style=color:#616e88># Drop None fields
</span><span>    </span><span style=color:#a3be8c>"province"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Tuscany"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"country"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Italy"</span><span style=color:#eceff4>,  </span><span style=color:#616e88># Missing country is unacceptable: replace with "Unknown
</span><span>    </span><span style=color:#a3be8c>"winery"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Castello San Donato in Perano"
</span><span>}
</span></code></pre><h3 id=simple-validator>Simple validator<a aria-label="Anchor link for: simple-validator" class=zola-anchor href=#simple-validator>#</a></h3><p>The first benchmark makes use of a simple validator based on familiar Pydantic concepts – fields, validators and models. The validator is shown below.<div class=codeblock-with-filename><div class=filename>schemas.py</div><pre class=language-py data-lang=py style=background:#2e3440;color:#d8dee9><code class=language-py data-lang=py><span style=color:#81a1c1>from </span><span>pydantic </span><span style=color:#81a1c1>import </span><span>BaseModel</span><span style=color:#eceff4>, </span><span>ConfigDict</span><span style=color:#eceff4>, </span><span>Field</span><span style=color:#eceff4>, </span><span>model_validator
</span><span>
</span><span style=color:#81a1c1>class </span><span style=color:#8fbcbb>Wine</span><span>(</span><span style=color:#8fbcbb>BaseModel</span><span>):
</span><span>    model_config </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>ConfigDict</span><span>(
</span><span>        populate_by_name</span><span style=color:#81a1c1>=True</span><span style=color:#eceff4>,
</span><span>        str_strip_whitespace</span><span style=color:#81a1c1>=True</span><span style=color:#eceff4>,
</span><span>    )
</span><span>
</span><span>    </span><span style=font-style:italic;color:#88c0d0>id</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>int
</span><span>    points</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>int
</span><span>    title</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str
</span><span>    description</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><span>    price</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>float | None
</span><span>    variety</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><span>    winery</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><span>    designation</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None = </span><span style=color:#88c0d0>Field</span><span>(</span><span style=color:#81a1c1>None</span><span style=color:#eceff4>, </span><span>alias</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>"vineyard"</span><span>)
</span><span>    country</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><span>    province</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><span>    region_1</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><span>    region_2</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><span>    taster_name</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><span>    taster_twitter_handle</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><span>
</span><span>    </span><span style=color:#d08770>@</span><span>model_validator(mode</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>"before"</span><span>)
</span><span>    </span><span style=color:#81a1c1>def </span><span style=color:#88c0d0>_remove_unknowns</span><span>(cls</span><span style=color:#eceff4>, </span><span>values):
</span><span>        </span><span style=color:#a3be8c>"Set other fields that have the value 'null' as None so that we can throw it away"
</span><span>        </span><span style=color:#81a1c1>for </span><span>field </span><span style=color:#81a1c1>in </span><span>[</span><span style=color:#a3be8c>"region_1"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"region_2"</span><span>]:
</span><span>            </span><span style=color:#81a1c1>if not </span><span>values</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span>(field) </span><span style=color:#81a1c1>or </span><span>values</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span>(field) </span><span style=color:#81a1c1>== </span><span style=color:#a3be8c>"null"</span><span>:
</span><span>                values[field] </span><span style=color:#81a1c1>= None
</span><span>        </span><span style=color:#81a1c1>return </span><span>values
</span><span>
</span><span>    </span><span style=color:#d08770>@</span><span>model_validator(mode</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>"before"</span><span>)
</span><span>    </span><span style=color:#81a1c1>def </span><span style=color:#88c0d0>_fill_country_unknowns</span><span>(cls</span><span style=color:#eceff4>, </span><span>values):
</span><span>        </span><span style=color:#a3be8c>"Fill in missing country values with 'Unknown', as we always want this field to be queryable"
</span><span>        country </span><span style=color:#81a1c1>= </span><span>values</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span>(</span><span style=color:#a3be8c>"country"</span><span>)
</span><span>        </span><span style=color:#81a1c1>if not </span><span>country </span><span style=color:#81a1c1>or </span><span>country </span><span style=color:#81a1c1>== </span><span style=color:#a3be8c>"null"</span><span>:
</span><span>            values[</span><span style=color:#a3be8c>"country"</span><span>] </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>"Unknown"
</span><span>        </span><span style=color:#81a1c1>return </span><span>values
</span></code></pre></div><p>The goal of the validator is to coerce bad data types to the types we want, and to drop fields that we don’t want, or are missing. In addition, the <code>model_config</code> is used to strip whitespace from all string fields, and to populate specific fields by an alias. <code>model_validator</code> class methods are used to modify elements of a dict as they are parsed, before validation.<h3 id=improved-validator>Improved validator<a aria-label="Anchor link for: improved-validator" class=zola-anchor href=#improved-validator>#</a></h3><p>The improved validator makes use of some new features in Pydantic v2 as shown below.<div class=codeblock-with-filename><div class=filename>schemas_improved.py</div><pre class=language-py data-lang=py style=background:#2e3440;color:#d8dee9><code class=language-py data-lang=py><span style=color:#81a1c1>from </span><span>pydantic </span><span style=color:#81a1c1>import </span><span>BeforeValidator</span><span style=color:#eceff4>, </span><span>TypeAdapter</span><span style=color:#eceff4>, </span><span>constr</span><span style=color:#eceff4>, </span><span>field_validator
</span><span style=color:#81a1c1>from </span><span>pydantic_core </span><span style=color:#81a1c1>import </span><span>PydanticOmit
</span><span style=color:#81a1c1>from </span><span>typing_extensions </span><span style=color:#81a1c1>import </span><span>Annotated</span><span style=color:#eceff4>, </span><span>NotRequired</span><span style=color:#eceff4>, </span><span>TypedDict
</span><span>
</span><span>not_required_fields </span><span style=color:#81a1c1>= </span><span>[</span><span style=color:#a3be8c>"region_1"</span><span style=color:#eceff4>,</span><span style=color:#a3be8c>"region_2"</span><span>]
</span><span>
</span><span style=color:#81a1c1>def </span><span style=color:#88c0d0>exclude_none</span><span>(s</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None</span><span>) </span><span style=color:#eceff4>-> </span><span style=color:#81a1c1>str</span><span>:
</span><span>    </span><span style=color:#81a1c1>if </span><span>s </span><span style=color:#81a1c1>is None</span><span>:
</span><span>        </span><span style=color:#616e88># since we want `exclude_none=True` in the end,
</span><span>        </span><span style=color:#616e88># just omit it if it's `None` during validation
</span><span>        </span><span style=color:#81a1c1>raise </span><span>PydanticOmit
</span><span>    </span><span style=color:#81a1c1>else</span><span>:
</span><span>        </span><span style=color:#81a1c1>return </span><span>s
</span><span>
</span><span>ExcludeNoneStr </span><span style=color:#81a1c1>= </span><span>Annotated[</span><span style=color:#81a1c1>str</span><span>, </span><span style=color:#88c0d0>BeforeValidator</span><span>(exclude_none)]
</span><span>
</span><span style=color:#81a1c1>class </span><span style=color:#8fbcbb>Wine</span><span>(</span><span style=color:#8fbcbb>TypedDict</span><span>):
</span><span>    </span><span style=font-style:italic;color:#88c0d0>id</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>int
</span><span>    points</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>int
</span><span>    title</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str
</span><span>    description</span><span style=color:#eceff4>: </span><span>NotRequired[</span><span style=color:#81a1c1>str</span><span>]
</span><span>    price</span><span style=color:#eceff4>: </span><span>NotRequired[</span><span style=color:#81a1c1>float</span><span>]
</span><span>    variety</span><span style=color:#eceff4>: </span><span>NotRequired[</span><span style=color:#81a1c1>str</span><span>]
</span><span>    winery</span><span style=color:#eceff4>: </span><span>NotRequired[</span><span style=color:#81a1c1>str</span><span>]
</span><span>    designation</span><span style=color:#eceff4>: </span><span>NotRequired[</span><span style=color:#88c0d0>constr</span><span>(strip_whitespace</span><span style=color:#81a1c1>=True</span><span>)]
</span><span>    country</span><span style=color:#eceff4>: </span><span>NotRequired[</span><span style=color:#81a1c1>str</span><span>]
</span><span>    province</span><span style=color:#eceff4>: </span><span>NotRequired[</span><span style=color:#81a1c1>str</span><span>]
</span><span>    region_1</span><span style=color:#eceff4>: </span><span>NotRequired[</span><span style=color:#81a1c1>str</span><span>]
</span><span>    region_2</span><span style=color:#eceff4>: </span><span>NotRequired[</span><span style=color:#81a1c1>str</span><span>]
</span><span>    taster_name</span><span style=color:#eceff4>: </span><span>NotRequired[</span><span style=color:#81a1c1>str</span><span>]
</span><span>    taster_twitter_handle</span><span style=color:#eceff4>: </span><span>NotRequired[</span><span style=color:#81a1c1>str</span><span>]
</span><span>
</span><span>    </span><span style=color:#d08770>@</span><span>field_validator(</span><span style=color:#81a1c1>*</span><span>not_required_fields</span><span style=color:#eceff4>, </span><span>mode</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>"before"</span><span>)
</span><span>    </span><span style=color:#81a1c1>def </span><span style=color:#88c0d0>omit_null_none</span><span>(cls</span><span style=color:#eceff4>, </span><span>v):
</span><span>        </span><span style=color:#616e88># type: ignore
</span><span>        </span><span style=color:#81a1c1>if </span><span>v </span><span style=color:#81a1c1>is None or </span><span>v </span><span style=color:#81a1c1>== </span><span style=color:#a3be8c>"null"</span><span>:
</span><span>            </span><span style=color:#81a1c1>raise </span><span>PydanticOmit
</span><span>        </span><span style=color:#81a1c1>else</span><span>:
</span><span>            </span><span style=color:#81a1c1>return </span><span>v
</span><span>
</span><span>    </span><span style=color:#d08770>@</span><span>field_validator(</span><span style=color:#a3be8c>"country"</span><span style=color:#eceff4>, </span><span>mode</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>"before"</span><span>)
</span><span>    </span><span style=color:#81a1c1>def </span><span style=color:#88c0d0>country_unknown</span><span>(cls</span><span style=color:#eceff4>, </span><span>s</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None</span><span>) </span><span style=color:#eceff4>-> </span><span style=color:#81a1c1>str</span><span>:
</span><span>        </span><span style=color:#616e88># type: ignore
</span><span>        </span><span style=color:#81a1c1>if </span><span>s </span><span style=color:#81a1c1>is None or </span><span>s </span><span style=color:#81a1c1>== </span><span style=color:#a3be8c>"null"</span><span>:
</span><span>            </span><span style=color:#81a1c1>return </span><span style=color:#a3be8c>"Unknown"
</span><span>        </span><span style=color:#81a1c1>else</span><span>:
</span><span>            </span><span style=color:#81a1c1>return </span><span>s
</span><span>
</span><span>WinesTypeAdapter </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>TypeAdapter</span><span>(</span><span style=color:#81a1c1>list</span><span>[Wine])
</span></code></pre></div><p>There are a number of differences between this validator and the previous one:<ul><li><p>The <code>Wine</code> model in the improved version is a <a rel="nofollow noreferrer" href=https://docs.python.org/3/library/typing.html#typing.TypedDict><code>TypedDict</code></a> instead of a <code>BaseModel</code>. This is a new feature in Pydantic v2 that allows us to define a schema using Python’s native <code>TypedDict</code> type (which, at runtime, is a plain <code>dict</code>)</p><li><p><code>field_validator</code> is used instead of <code>model_validator</code>. These operate only on specific fields, and we apply the the <code>NotRequired</code> type to all fields that we want to be able to omit from the final output if their value is either <code>None</code> or <code>'null'</code>. This is done via a new exception type <code>PydanticOmit</code></p><li><p>A <code>TypeAdapter</code> is used, which exposes only <a rel="nofollow noreferrer" href=https://docs.pydantic.dev/latest/api/type_adapter/>some of the functionality</a> of <code>BaseModel</code>. This is much more performant, as it avoids the overhead of the <code>BaseModel</code> class when simply performing validation on a <code>dict</code>.</p></ul><p>Because these features listed above are unique to Pydantic v2, the improved validator can only be run on v2.x and not on v1.<blockquote class="callout tip"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M9.97308 18H11V13H13V18H14.0269C14.1589 16.7984 14.7721 15.8065 15.7676 14.7226C15.8797 14.6006 16.5988 13.8564 16.6841 13.7501C17.5318 12.6931 18 11.385 18 10C18 6.68629 15.3137 4 12 4C8.68629 4 6 6.68629 6 10C6 11.3843 6.46774 12.6917 7.31462 13.7484C7.40004 13.855 8.12081 14.6012 8.23154 14.7218C9.22766 15.8064 9.84103 16.7984 9.97308 18ZM10 20V21H14V20H10ZM5.75395 14.9992C4.65645 13.6297 4 11.8915 4 10C4 5.58172 7.58172 2 12 2C16.4183 2 20 5.58172 20 10C20 11.8925 19.3428 13.6315 18.2443 15.0014C17.624 15.7748 16 17 16 18.5V21C16 22.1046 15.1046 23 14 23H10C8.89543 23 8 22.1046 8 21V18.5C8 17 6.37458 15.7736 5.75395 14.9992Z" fill=currentColor></path></svg></div><div class=content><p><strong>Tip</strong><p>As I <a rel="nofollow noreferrer" href=https://github.com/prrao87/pydantic-benchmarks/pull/1>learned from</a> Samuel Colvin himself while making this benchmark, certain validation workflows such as this one, largely spend their time in serialization, i.e., converting a <code>dict</code> to a Pydantic model and back to a <code>dict</code> for downstream use. The model here is also rather simple, with no nested fields or complex validation logic. In such cases, <code>TypedDict</code> coupled with <code>TypeAdapter</code> is a better choice for performance reasons than <code>BaseModel</code>.</div></blockquote><h3 id=benchmark-code>Benchmark code<a aria-label="Anchor link for: benchmark-code" class=zola-anchor href=#benchmark-code>#</a></h3><p>The benchmark is run using <code>pytest-benchmark</code>. The data is first loaded into a test fixture.<pre class=language-py data-lang=py style=background:#2e3440;color:#d8dee9><code class=language-py data-lang=py><span style=color:#81a1c1>from </span><span>typing </span><span style=color:#81a1c1>import </span><span>Any
</span><span style=color:#81a1c1>from </span><span>pathlib </span><span style=color:#81a1c1>import </span><span>Path
</span><span style=color:#81a1c1>from </span><span>util </span><span style=color:#81a1c1>import </span><span>get_json_data  </span><span style=color:#616e88># A helper function to load data via srsly
</span><span>
</span><span style=color:#81a1c1>import </span><span>pytest
</span><span>
</span><span style=color:#d08770>@</span><span>pytest</span><span style=color:#81a1c1>.</span><span>fixture
</span><span style=color:#81a1c1>def </span><span style=color:#88c0d0>data</span><span>() </span><span style=color:#eceff4>-> </span><span style=color:#81a1c1>list</span><span>[</span><span style=color:#81a1c1>dict</span><span>[</span><span style=color:#81a1c1>str</span><span>, Any]]:
</span><span>    </span><span style=color:#616e88>"""Load the data once per session"""
</span><span>    </span><span style=color:#81a1c1>DATA_DIR = </span><span style=color:#88c0d0>Path</span><span>(</span><span style=color:#a3be8c>"/path/to/data"</span><span>)
</span><span>    </span><span style=color:#81a1c1>FILENAME = </span><span style=color:#a3be8c>"winemag-data-130k-v2.jsonl.gz"
</span><span>    data </span><span style=color:#81a1c1>= list</span><span>(</span><span style=color:#88c0d0>get_json_data</span><span>(</span><span style=color:#81a1c1>DATA_DIR</span><span style=color:#eceff4>, </span><span style=color:#81a1c1>FILENAME</span><span>))
</span><span>    </span><span style=color:#81a1c1>return </span><span>data
</span></code></pre><p>The key-value pairs from each JSON record in the dataset are unpacked as <code>kwargs</code> and passed to the validator to produce a Pydantic mode as shown below. The model is then dumped back to a <code>dict</code> via <code>model_dump</code> for downstream use.<div class=codeblock-with-filename><div class=filename>basic_validator</div><pre class=language-py data-lang=py style=background:#2e3440;color:#d8dee9><code class=language-py data-lang=py><span>```py
</span><span style=color:#81a1c1>def </span><span style=color:#88c0d0>validate</span><span>(data):
</span><span>    </span><span style=color:#616e88>"""Validate a list of JSON blobs against the Wine schema"""
</span><span>    validated_data </span><span style=color:#81a1c1>= </span><span>[</span><span style=color:#88c0d0>Wine</span><span>(</span><span style=color:#81a1c1>**</span><span>item)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>model_dump</span><span>(exclude_none</span><span style=color:#81a1c1>=True</span><span style=color:#eceff4>, </span><span>by_alias</span><span style=color:#81a1c1>=True</span><span>) </span><span style=color:#81a1c1>for </span><span>item </span><span style=color:#81a1c1>in </span><span>data]
</span><span>    </span><span style=color:#81a1c1>return </span><span>validated_data
</span><span>
</span><span style=color:#616e88># Run validator
</span><span style=color:#81a1c1>def </span><span style=color:#88c0d0>test_validate</span><span>(benchmark</span><span style=color:#eceff4>, </span><span>data):
</span><span>    </span><span style=color:#616e88>"""Validate the data"""
</span><span>    result </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>benchmark</span><span>(validate</span><span style=color:#eceff4>, </span><span>data)
</span><span>    </span><span style=color:#81a1c1>assert </span><span style=font-style:italic;color:#88c0d0>len</span><span>(result) </span><span style=color:#81a1c1>== </span><span style=font-style:italic;color:#88c0d0>len</span><span>(data)
</span></code></pre></div><p>The improved validator is run directly from the <code>TypeAdapter</code> we defined earlier. Note that we don’t need to unpack the JSON items into a <code>dict</code> and then pass them to the validator, as <code>TypeAdapter</code> can operate directly on a list of <code>dict</code>s, which avoids unnecessary serialization overhead.<div class=codeblock-with-filename><div class=filename>improved_validator</div><pre class=language-py data-lang=py data-linenos style=background:#2e3440;color:#d8dee9><code class=language-py data-lang=py><table><tbody><tr><td>1<td><span style=color:#81a1c1>def </span><span style=color:#88c0d0>test_validate_improved</span><span>(benchmark</span><span style=color:#eceff4>, </span><span>data):
</span><tr><td>2<td><span>    </span><span style=color:#616e88>"""Validate a list of JSON blobs against the Wine schema"""
</span><tr><td><mark style=background:#434c5e52>3</mark><td><mark style=background:#434c5e52><span>    result </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>benchmark</span><span>(WinesTypeAdapter</span><span style=color:#81a1c1>.</span><span>validate_python</span><span style=color:#eceff4>, </span><span>data)
</span></mark><tr><td>4<td><span>    </span><span style=color:#81a1c1>assert </span><span style=font-style:italic;color:#88c0d0>len</span><span>(result) </span><span style=color:#81a1c1>== </span><span style=font-style:italic;color:#88c0d0>len</span><span>(data)
</span></table></code></pre></div><p>Note how the <code>validate_python</code> method is used instead of serializing a <code>dict</code> to a Pydantic model. This is <em>much</em> better for performance, and as a rule of thumb, should be used when the only goal is to validate a <code>dict</code> against a schema.<p>The benchmark is then run via <a rel="nofollow noreferrer" href=https://github.com/prrao87/pydantic-benchmarks/blob/main/v2/benchmark_validator.py><code>benchmark_validator.py</code></a>.<div class=codeblock-with-filename><div class=filename>bash</div><pre class=language-bash data-lang=bash style=background:#2e3440;color:#d8dee9><code class=language-bash data-lang=bash><span style=color:#88c0d0>pytest</span><span> benchmark_validator.py --benchmark-sort</span><span style=color:#81a1c1>=</span><span>fullname --benchmark-warmup-iterations</span><span style=color:#81a1c1>=</span><span>5 --benchmark-min-rounds</span><span style=color:#81a1c1>=</span><span>10
</span></code></pre></div><h2 id=reasons-for-performance-improvement>Reasons for performance improvement<a aria-label="Anchor link for: reasons-for-performance-improvement" class=zola-anchor href=#reasons-for-performance-improvement>#</a></h2><p>The performance improvements can be attributed to multiple causes, broadly categorized as follows:<h3 id=improvements-at-the-rust-level>Improvements at the Rust level<a aria-label="Anchor link for: improvements-at-the-rust-level" class=zola-anchor href=#improvements-at-the-rust-level>#</a></h3><ul><li>PGO applied at the PyO3 level during <code>pydantic-core</code> compilation<li>Usage of a fast, custom JSON parser, <code>jiter</code>, which avoids the <code>serde_json</code> dependency via <code>orjson</code>, and <a href="https://x.com/samuel_colvin/status/1720153791767429473?s=20" rel="nofollow noreferrer">is tuned</a> to Pydantic’s JSON parsing requirements</ul><h3 id=improvements-at-the-python-level>Improvements at the Python level<a aria-label="Anchor link for: improvements-at-the-python-level" class=zola-anchor href=#improvements-at-the-python-level>#</a></h3><ul><li>Using <code>TypedDict</code> and <code>TypeAdapter</code> instead of <code>BaseModel</code> to avoid serialization overhead (transferring the Python <code>dict</code> to be parsed and validated at the Rust level via PyO3 bindings)<li>Using <code>field_validator</code> instead of <code>model_validator</code> to avoid unnecessary validation of all fields when not required<li>Using <code>NotRequired</code> type extensions and a new <code>PydanticOmit</code> exception in v2 to avoid unnecessary serialization of fields that are <code>None</code> or <code>'null'</code>. This is done during the parsing stage, prior to validation, which is faster.</ul><h2 id=towards-a-nogil-future>Towards a nogil future<a aria-label="Anchor link for: towards-a-nogil-future" class=zola-anchor href=#towards-a-nogil-future>#</a></h2><p>Going forward, there are even more improvements happening at a very low level, related to PyO3 and how to work around the Python Global Interpreter Lock (GIL).</p><script async charset=utf-8 src=https://platform.twitter.com/widgets.js></script><div class=twitter><center> <blockquote class=twitter-tweet><a href=https://twitter.com/pydantic/status/1726939559680721200></a></blockquote> </center></div><p>In the near term, an <a rel="nofollow noreferrer" href=https://github.com/PyO3/pyo3/issues/3382>upcoming release</a> of <code>pydantic-core</code> is attempting to port the upcoming improvements to PyO3’s GIL handling. A further <a rel="nofollow noreferrer" href=https://github.com/pydantic/pydantic-core/pull/1085#issuecomment-1820573327>20-30% performance improvement</a> is expected from this, all available to end users for free, with zero code changes required. 🤯<p>Over the longer term, a future release of Python 3.13 that aims to make the GIL completely optional will allow the Python code at the top layer of Pydantic to perform operations within <code>pydantic-core</code> in a way that’s completely free of the GIL. This is fondly referred to as the “nogil” future of Python, and has the potential to be a game-changer for Pydantic, as well as a host of other Python libraries that can benefit from true multi-threaded code execution.<h2 id=conclusions>Conclusions<a aria-label="Anchor link for: conclusions" class=zola-anchor href=#conclusions>#</a></h2><p>Because of these low level developments that are happening silently under the hood, largely at the Rust level, end users can expect to see more-than-subtle performance improvements in their Pydantic code over time. Considering the billions (or trillions) of times a day that Pydantic code executes on servers all over the world, every ounce of efficient computation is a win for companies that run the code, and for the planet as a whole. 🌎<p>I hope this post has gotten you as excited as I am about the future of Pydantic, and, in general, the future of Rust in the PyData ecosystem. A lot of this is enabled by the work of David Hewitt, who <a rel="nofollow noreferrer" href=https://twitter.com/pydantic/status/1671233172867256320>recently joined Pydantic</a>, and is simultaneously pushing the boundaries of what’s possible with PyO3 and Pydantic.<p>Have fun porting your Pydantic code to v2, and let’s keep tracking and celebrating the performance gains! 🚀<h2 id=code>Code<a aria-label="Anchor link for: code" class=zola-anchor href=#code>#</a></h2><p>All code for the benchmarks shown in this post is available <a rel="nofollow noreferrer" href=https://github.com/prrao87/pydantic-benchmarks>here</a>.<h3 id=acknowledgements>Acknowledgements<a aria-label="Anchor link for: acknowledgements" class=zola-anchor href=#acknowledgements>#</a></h3><p>Special thanks to <a href="https://twitter.com/samuel_colvin?lang=en" rel="nofollow noreferrer">Samuel Colvin</a> for taking the time to create <a rel="nofollow noreferrer" href=https://github.com/prrao87/pydantic-benchmarks/pull/1>a PR</a> for the improved validation logic.<blockquote class="callout important"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM11 15H13V17H11V15ZM11 7H13V13H11V7Z" fill=currentColor></path></svg></div><div class=content><p>Open source is truly a wonderful thing, so if you’re a team that hugely benefits from Pydantic, consider <a rel="nofollow noreferrer" href=https://github.com/sponsors/samuelcolvin>sponsoring</a> the project to help it thrive. 🫶🏼</div></blockquote></article><div class=giscus></div><script async crossorigin data-category=General data-category-id=DIC_kwDOKyWhTs4CbUSt data-emit-metadata=0 data-input-position=bottom data-lang=en data-loading=lazy data-mapping=pathname data-reactions-enabled=1 data-repo=thedataquarry/thedataquarry.github.io data-repo-id=R_kgDOKyWhTg data-strict=0 data-theme=preferred_color_scheme src=https://giscus.app/client.js></script></div><footer><div class=copyright><p>© 2024 Prashanth Rao</div><div class=credits>Powered by <a rel="noreferrer noopener" href=https://www.getzola.org target=_blank>zola</a> and <a rel="noreferrer noopener" href=https://github.com/isunjn/serene target=_blank>serene</a></div></footer></main></div><script src=/js/lightense.min.js></script><script src=/js/main.js></script>