<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="light dark" name=color-scheme><title>Embedded databases (2): Kùzu, an extremely fast embedded graph database | The Data Quarry</title><meta content="Embedded databases (2): Kùzu, an extremely fast embedded graph database" property=og:title><meta content="Prashanth Rao" name=author><meta content=en_US property=og:locale><meta content="A benchmark study comparing the performance of Kùzu vs. Neo4j on an artificial social network dataset" name=description><meta content="A benchmark study comparing the performance of Kùzu vs. Neo4j on an artificial social network dataset" property=og:description><link href=https://thedataquarry.github.io/posts/embedded-db-2/ rel=canonical><meta content=https://thedataquarry.github.io/posts/embedded-db-2/ property=og:url><meta content="The Data Quarry" property=og:site_name><meta content=https://thedataquarry.github.io/img/dataquarry-banner.png property=og:image><meta content=article property=og:type><meta content=2023-09-09T00:00:00+00:00 property=article:published_time><meta " content=summary_large_image name=twitter:card><meta content=https://thedataquarry.github.io/img/dataquarry-banner.png property=twitter:image><meta content="Embedded databases (2): Kùzu, an extremely fast embedded graph database" property=twitter:title><meta content=@tech_optimist name=twitter:site><meta content="A benchmark study comparing the performance of Kùzu vs. Neo4j on an artificial social network dataset" name=description><title>Embedded databases (2): Kùzu, an extremely fast embedded graph database</title><link href=/img/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/img/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/img/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><style>body{--primary-color:#376dd9;--primary-pale-color:#698bcf1c;--inline-code-color:#444;--text-color:#444;--text-pale-color:#545967;--bg-color:#fff;--highlight-mark-color:#5f75b045;--callout-note-color:#3e70d6;--callout-important-color:#7a46cd;--callout-warning-color:#d3822b;--callout-alert-color:#d43f3f;--callout-question-color:#3089b5;--callout-tip-color:#35a06b;--main-font:"IBMPlexSans",ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--code-font:"IBMPlexMono",ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--homepage-max-width:750px;--main-max-width:750px;--avatar-size:175px;--paragraph-font-size:16px;--paragraph-line-height:1.5em;--aside-font-size:16px;--img-border-radius:4px;--inline-code-border-radius:2px}body.dark{--primary-color:#689afd;--primary-pale-color:#93acdd1c;--inline-code-color:#d2d2d2;--text-color:#ddd;--text-pale-color:#a0a0a0;--bg-color:#202124;--highlight-mark-color:#5f75b045;--callout-note-color:#698bcf;--callout-important-color:#9374c5;--callout-warning-color:#c99054;--callout-alert-color:#d35757;--callout-question-color:#5091b2;--callout-tip-color:#3ea06f}</style><link href=/main.css rel=stylesheet><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css integrity=sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI rel=stylesheet><script crossorigin defer integrity=sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js></script><script crossorigin defer integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:'$$',right:'$$',display:true},{left:'$',right:'$',display:false},{left:'\\(',right:'\\)',display:false},{left:'\\[',right:'\\]',display:true}],throwOnError:false})})</script><script async data-website-id=01228822-c189-4b8a-93ba-733d045bf346 src=https://analytics.eu.umami.is/script.js></script><body class=post><script>if(localStorage.getItem('theme')=='dark'){document.body.classList.add('dark');const a=document.querySelector('link#hl');if(a)a.href='/hl-dark.css'}</script><header class=blur><div id=header-wrapper><nav><a href=/>The Data Quarry</a><button aria-label="toggle expand" class=separator id=toggler>::</button><span class="wrap left fold">{</span><a href=/posts>blog</a><span class="wrap-separator fold">,</span><a class=fold href=/talks>talks</a><span class="wrap-separator fold">,</span><a class=fold href=/projects>projects</a><span class="wrap right fold">} ;</span></nav><div id=btns><a rel="noreferrer noopener" aria-label=GitHub href=https://github.com/prrao87 target=_blank> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12" fill=currentColor></path></svg> </a><a rel="noreferrer noopener" aria-label=Twitter href=https://twitter.com/tech_optimist target=_blank> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>Twitter</title><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z" fill=currentColor></path></svg> </a><a rel="noreferrer noopener" aria-label=LinkedIn href=https://www.linkedin.com/in/prrao87 target=_blank> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z" fill=currentColor></path></svg> </a><a aria-label="Buy me a coffee" rel="noreferrer noopener" href=https://www.buymeacoffee.com/prrao87 target=_blank> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>Buy Me A Coffee</title><path d="M20.216 6.415l-.132-.666c-.119-.598-.388-1.163-1.001-1.379-.197-.069-.42-.098-.57-.241-.152-.143-.196-.366-.231-.572-.065-.378-.125-.756-.192-1.133-.057-.325-.102-.69-.25-.987-.195-.4-.597-.634-.996-.788a5.723 5.723 0 00-.626-.194c-1-.263-2.05-.36-3.077-.416a25.834 25.834 0 00-3.7.062c-.915.083-1.88.184-2.75.5-.318.116-.646.256-.888.501-.297.302-.393.77-.177 1.146.154.267.415.456.692.58.36.162.737.284 1.123.366 1.075.238 2.189.331 3.287.37 1.218.05 2.437.01 3.65-.118.299-.033.598-.073.896-.119.352-.054.578-.513.474-.834-.124-.383-.457-.531-.834-.473-.466.074-.96.108-1.382.146-1.177.08-2.358.082-3.536.006a22.228 22.228 0 01-1.157-.107c-.086-.01-.18-.025-.258-.036-.243-.036-.484-.08-.724-.13-.111-.027-.111-.185 0-.212h.005c.277-.06.557-.108.838-.147h.002c.131-.009.263-.032.394-.048a25.076 25.076 0 013.426-.12c.674.019 1.347.067 2.017.144l.228.031c.267.04.533.088.798.145.392.085.895.113 1.07.542.055.137.08.288.111.431l.319 1.484a.237.237 0 01-.199.284h-.003c-.037.006-.075.01-.112.015a36.704 36.704 0 01-4.743.295 37.059 37.059 0 01-4.699-.304c-.14-.017-.293-.042-.417-.06-.326-.048-.649-.108-.973-.161-.393-.065-.768-.032-1.123.161-.29.16-.527.404-.675.701-.154.316-.199.66-.267 1-.069.34-.176.707-.135 1.056.087.753.613 1.365 1.37 1.502a39.69 39.69 0 0011.343.376.483.483 0 01.535.53l-.071.697-1.018 9.907c-.041.41-.047.832-.125 1.237-.122.637-.553 1.028-1.182 1.171-.577.131-1.165.2-1.756.205-.656.004-1.31-.025-1.966-.022-.699.004-1.556-.06-2.095-.58-.475-.458-.54-1.174-.605-1.793l-.731-7.013-.322-3.094c-.037-.351-.286-.695-.678-.678-.336.015-.718.3-.678.679l.228 2.185.949 9.112c.147 1.344 1.174 2.068 2.446 2.272.742.12 1.503.144 2.257.156.966.016 1.942.053 2.892-.122 1.408-.258 2.465-1.198 2.616-2.657.34-3.332.683-6.663 1.024-9.995l.215-2.087a.484.484 0 01.39-.426c.402-.078.787-.212 1.074-.518.455-.488.546-1.124.385-1.766zm-1.478.772c-.145.137-.363.201-.578.233-2.416.359-4.866.54-7.308.46-1.748-.06-3.477-.254-5.207-.498-.17-.024-.353-.055-.47-.18-.22-.236-.111-.71-.054-.995.052-.26.152-.609.463-.646.484-.057 1.046.148 1.526.22.577.088 1.156.159 1.737.212 2.48.226 5.002.19 7.472-.14.45-.06.899-.13 1.345-.21.399-.072.84-.206 1.08.206.166.281.188.657.162.974a.544.544 0 01-.169.364zm-6.159 3.9c-.862.37-1.84.788-3.109.788a5.884 5.884 0 01-1.569-.217l.877 9.004c.065.78.717 1.38 1.5 1.38 0 0 1.243.065 1.658.065.447 0 1.786-.065 1.786-.065.783 0 1.434-.6 1.499-1.38l.94-9.95a3.996 3.996 0 00-1.322-.238c-.826 0-1.491.284-2.26.613z" fill=currentColor></path></svg> </a><button aria-label="theme switch" data-moon-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill="currentColor"></path></svg>' data-sun-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12C18 15.3137 15.3137 18 12 18ZM12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM11 1H13V4H11V1ZM11 20H13V23H11V20ZM3.51472 4.92893L4.92893 3.51472L7.05025 5.63604L5.63604 7.05025L3.51472 4.92893ZM16.9497 18.364L18.364 16.9497L20.4853 19.0711L19.0711 20.4853L16.9497 18.364ZM19.0711 3.51472L20.4853 4.92893L18.364 7.05025L16.9497 5.63604L19.0711 3.51472ZM5.63604 16.9497L7.05025 18.364L4.92893 20.4853L3.51472 19.0711L5.63604 16.9497ZM23 11V13H20V11H23ZM4 11V13H1V11H4Z" fill="currentColor"></path></svg>' id=theme-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill=currentColor></path></svg></button><button aria-label="table of content" id=toc-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M3 4H21V6H3V4ZM3 11H15V13H3V11ZM3 18H21V20H3V18Z" fill=currentColor></path></svg></button></div></div></header><div id=wrapper><div id=blank></div><aside class=blur><nav><ul><li><a class=h2 href=#benchmarking-kuzu-vs-neo4j-on-a-social-network-dataset>Benchmarking Kùzu vs. Neo4j on a social network dataset</a> <ul><li><a class=h3 href=#what-makes-kuzu-different>What makes Kùzu different?</a></ul><li><a class=h2 href=#dataset>Dataset</a><li><a class=h2 href=#data-ingestion>Data ingestion</a> <ul><li><a class=h3 href=#performance>Performance</a></ul><li><a class=h2 href=#queries>Queries</a> <ul><li><a class=h3 href=#notes-on-query-timing>Notes on query timing</a><li><a class=h3 href=#performance-1>Performance</a></ul><li><a class=h2 href=#why-was-kuzu-faster-than-neo4j>Why was Kùzu faster than Neo4j?</a> <ul><li><a class=h3 href=#vectorized-execution>Vectorized execution</a><li><a class=h3 href=#multi-threaded-execution>Multi-threaded execution</a><li><a class=h3 href=#worst-case-optimal-joins-wcoj>Worst-case optimal joins (WCOJ)</a><li><a class=h3 href=#factorized-execution>Factorized execution</a></ul><li><a class=h2 href=#conclusions>Conclusions</a><li><a class=h2 href=#code>Code</a> <ul><li><a class=h3 href=#additional-resources>Additional resources</a></ul></ul></nav><button aria-label="back to top" id=back-to-top><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M11.9997 10.8284L7.04996 15.7782L5.63574 14.364L11.9997 8L18.3637 14.364L16.9495 15.7782L11.9997 10.8284Z" fill=currentColor></path></svg></button></aside><main><div><div data-check-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z" fill="currentColor"></path></svg>' data-copy-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill="currentColor"></path></svg>' id=copy-cfg style=display:none></div><article data-backlink-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M9.41421 8L18.0208 16.6066L16.6066 18.0208L8 9.41421V17H6V6H17V8H9.41421Z" fill="currentColor"></path></svg>' class=prose><h1>Embedded databases (2): Kùzu, an extremely fast embedded graph database</h1><div id=post-info><div id=date><span id=publish>2023-09-09</span></div><div id=tags><a href=https://thedataquarry.github.io/tags/embedded-db><span>#</span>embedded-db</a><a href=https://thedataquarry.github.io/tags/graph-db><span>#</span>graph-db</a></div></div><h2 id=benchmarking-kuzu-vs-neo4j-on-a-social-network-dataset>Benchmarking Kùzu vs. Neo4j on a social network dataset<a aria-label="Anchor link for: benchmarking-kuzu-vs-neo4j-on-a-social-network-dataset" class=zola-anchor href=#benchmarking-kuzu-vs-neo4j-on-a-social-network-dataset>#</a></h2><p>Embedded databases have been experiencing something of a renaissance lately. In the <a href=../embedded-db-1/>first post</a> in this series, I gave a detailed overview of this fascinating landscape, breaking it down into domains. This second post goes deeper into the graph domain – in particular, <a rel="nofollow noreferrer" href=https://github.com/kuzudb/kuzu>Kùzu</a>, a modern, lightweight, blazing fast embedded graph database written in C++ that’s emerging as a powerful option for analytically querying very large graphs.<p>Because it’s hard to gauge performance in isolation, this study compares Kùzu’s performance to the community edition of <a rel="nofollow noreferrer" href=https://github.com/neo4j/neo4j>Neo4j</a>, a well-known and mature graph database already in widespread use. The study involves querying an artificial social network dataset that’s hand-constructed to possess interesting graph structures, while also being large enough to measure performance in a meaningful manner.<blockquote class="callout warning"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M12.865 3.00017L22.3912 19.5002C22.6674 19.9785 22.5035 20.5901 22.0252 20.8662C21.8732 20.954 21.7008 21.0002 21.5252 21.0002H2.47266C1.92037 21.0002 1.47266 20.5525 1.47266 20.0002C1.47266 19.8246 1.51886 19.6522 1.60663 19.5002L11.1329 3.00017C11.4091 2.52187 12.0206 2.358 12.4989 2.63414C12.651 2.72191 12.7772 2.84815 12.865 3.00017ZM4.20471 19.0002H19.7932L11.9989 5.50017L4.20471 19.0002ZM10.9989 16.0002H12.9989V18.0002H10.9989V16.0002ZM10.9989 9.00017H12.9989V14.0002H10.9989V9.00017Z" fill=currentColor></path></svg></div><div class=content><p><strong>Note</strong><p>The aim of this post is <strong>NOT</strong> to state that one database is better or worse than the other. Please take this as a <em>purely informative exercise</em>, and come to your own conclusions by testing out such a workflow on your own data.</div></blockquote><h3 id=what-makes-kuzu-different>What makes Kùzu different?<a aria-label="Anchor link for: what-makes-kuzu-different" class=zola-anchor href=#what-makes-kuzu-different>#</a></h3><p>Having been a graph data scientist and practitioner for several years, I can say I’ve experimented with my fair share of options. The standout feature of Kùzu that sets it apart from all the others is its embedded architecture – Kùzu is natively designed to run in-process, tightly integrated with the application code written in your language of choice. In a blog post outlining Kùzu’s vision<sup class=footnote-reference><a href=#1>1</a></sup>, its makers very explicitly state their goal of replicating in the graph world what DuckDB has done for relational DBs.<p>In my opinion, there are a few other design decisions of Kùzu that make it particularly interesting and useful for a wide variety of practitioners.<ol><li>First-class support for the labelled property graph (LPG) model, which was popularized by Neo4j and is now more or less the de-facto standard for graph databases in industry. <ul><li>However, this doesn’t mean that RDF graphs are not supported – this is ongoing work and is part of the Kùzu roadmap<sup class=footnote-reference><a href=#2>2</a></sup>.</ul><li>Embracing <a rel="nofollow noreferrer" href=https://opencypher.org/>openCypher</a> as its query language, which is the most widely adopted, fully-specified, declarative and open graph query language. <ul><li>One of the main focuses of Kùzu is to achieve near-full feature parity with Neo4j’s implementation of Cypher, and the current version of Kùzu is already quite close to this goal.</ul><li>Built for vectorized execution of OLAP-type queries, which means that Kùzu is optimized for running expensive, multi-hop queries on very large graphs.<li>Designed to be the storage layer of choice for graph machine learning applications, with a high degree of interoperability with geometric deep learning frameworks like PyG and DGL, as well as graph analytics frameworks like NetworkX.</ol><figure><img alt="Where Kùzu sits in the graph analytics value chain" loading=lazy src=../embedded-db-1/embedded-db-kuzudb.png><figcaption>Where Kùzu sits in the graph analytics value chain</figcaption></figure><h2 id=dataset>Dataset<a aria-label="Anchor link for: dataset" class=zola-anchor href=#dataset>#</a></h2><p>Graph databases, and graph data structures in general, are ideally suited to analyze highly-connected data like social networks or financial transactions. If done in a relational (SQL) database, this could involve expensive or recursive joins on numerous data points that may have many-to-many relationships.<p>The artificial dataset used in this study contains data for 100,000 persons that “follow” each other, with roughly 2.4 million edges between them, as well as their interests and the locations in which they live. To keep things simple, only three countries and their cities are in the dataset – United States 🇺🇸, United Kingdom 🇬🇧 and Canada 🇨🇦. The schema for this graph is shown below.<figure><img loading=lazy src=kuzudb-graph-schema.png></figure><ul><li><code>Person</code> node <code>FOLLOWS</code> another <code>Person</code> node<li><code>Person</code> node <code>LIVES_IN</code> a <code>City</code> node<li><code>Person</code> node <code>HAS_INTEREST</code> towards an <code>Interest</code> node<li><code>City</code> node is <code>CITY_IN</code> a <code>State</code> node<li><code>State</code> node is <code>STATE_IN</code> a <code>Country</code> node</ul><p>To make the graph more interesting, a small subset (~0.5%) of the <code>Person</code> nodes are considered “hubs”, i.e., they are connected to up to 5% of all the other persons in the graph. This is to simulate the fact that in real-world social networks, there’s a small fraction of people who are <em>very</em> well-connected and have a large number of followers.<p>As a result, the generated graph between persons has some interesting structures, like cliques, trees and cycles, and is visualized below.<figure><img alt="Cliques, trees and cycles in the graph of connected persons" loading=lazy src=person-person.png><figcaption>Cliques, trees and cycles in the graph of connected persons</figcaption></figure><p>A detailed explanation on the dataset generation is shown in this project’s <a rel="nofollow noreferrer" href=https://github.com/prrao87/kuzudb-study/tree/main/data>GitHub repo</a>. Note that the data is generated using a fixed random seed, so <strong>it is fully reproducible</strong>, and the number of artificial nodes and edges generated can be scaled up or down, reproducibly, as needed.<h2 id=data-ingestion>Data ingestion<a aria-label="Anchor link for: data-ingestion" class=zola-anchor href=#data-ingestion>#</a></h2><p>The data for the artificially generated nodes and edges are saves to parquet format, transformed to a list of dictionaries in Python, and ingested to either DB.<ul><li>Data is ingested to Neo4j via the async API of the <a rel="nofollow noreferrer" href=https://github.com/neo4j/neo4j-python-driver>Neo4j Python client</a>. <ul><li>Best practices as per the Neo4j docs for data ingestion via Python are followed, such as setting uniqueness constraints on node IDs, and using <code>UNWIND</code> to ingest data in batches.</ul><li>Kùzu, being an embedded database, comes with a Python API that can be accessed by simply using <code>pip install kuzu</code>, and ingested directly from parquet via its bulk loader.</ul><p>The code for data ingestion is in the files <code>build_graph.py</code> in either directory of the <a rel="nofollow noreferrer" href=https://github.com/prrao87/kuzudb-study>GitHub repo</a>.<h3 id=performance>Performance<a aria-label="Anchor link for: performance" class=zola-anchor href=#performance>#</a></h3><p>In total, ~100K nodes and ~2.5 million edges are ingested <strong>~18x</strong> faster in Kùzu than in Neo4j.<figure><img alt="When ingesting data via their Python clients, Kùzu is ~18x faster than Neo4j for this dataset" loading=lazy src=kuzudb-neo4j-ingestion-perf.png><figcaption>When ingesting data via their Python clients, Kùzu is ~18x faster than Neo4j for this dataset</figcaption></figure><blockquote class="callout tip"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M9.97308 18H11V13H13V18H14.0269C14.1589 16.7984 14.7721 15.8065 15.7676 14.7226C15.8797 14.6006 16.5988 13.8564 16.6841 13.7501C17.5318 12.6931 18 11.385 18 10C18 6.68629 15.3137 4 12 4C8.68629 4 6 6.68629 6 10C6 11.3843 6.46774 12.6917 7.31462 13.7484C7.40004 13.855 8.12081 14.6012 8.23154 14.7218C9.22766 15.8064 9.84103 16.7984 9.97308 18ZM10 20V21H14V20H10ZM5.75395 14.9992C4.65645 13.6297 4 11.8915 4 10C4 5.58172 7.58172 2 12 2C16.4183 2 20 5.58172 20 10C20 11.8925 19.3428 13.6315 18.2443 15.0014C17.624 15.7748 16 17 16 18.5V21C16 22.1046 15.1046 23 14 23H10C8.89543 23 8 22.1046 8 21V18.5C8 17 6.37458 15.7736 5.75395 14.9992Z" fill=currentColor></path></svg></div><div class=content><p><strong>Note</strong><p>In all fairness, it’s definitely possible to further speed up data ingestion in Neo4j through tricks like <code>apoc.periodic.iterate</code>, using the Java API, or the <code>neo4j-admin</code> import tool, but these methods require CSV as the input format, and would also need glue code to integrate the data loading with an otherwise Python-based workflow. As such, this benchmark aims to use Python to do everything end-to-end, as is commonly done in real-world data engineering workflows.</div></blockquote><p>Data loading performance isn’t the main focus of this study, so we can leave this topic here and move on to the more interesting part – querying the graph!<h2 id=queries>Queries<a aria-label="Anchor link for: queries" class=zola-anchor href=#queries>#</a></h2><p>In order to run a reasonable benchmark, it’s necessary to test a broad variety of queries on the dataset. This section walks through the queries that were chosen for this study, the rationale behind them, as well as the results obtained from either graph database. To make the results easier to read, the query results are fetched from each database in question, materialized to memory and transformed to a Polars DataFrame for display.<p>The conditions for the query benchmark are shown below.<ul><li>Macbook Pro M2, 16 GB RAM<li>Neo4j version: <code>5.11.0</code><li>Kùzu version: <code>0.0.8</code><li>Tests are run using <code>pytest-benchmark</code></ul><h3 id=notes-on-query-timing>Notes on query timing<a aria-label="Anchor link for: notes-on-query-timing" class=zola-anchor href=#notes-on-query-timing>#</a></h3><p>The benchmarks are run via the <code>pytest-benchmark</code> library for the query scripts for either DB. <code>pytest-benchmark</code>, which is built on top of <code>pytest</code>, attaches each set of runs to a timer. It uses the Python time module’s <a rel="nofollow noreferrer" href=https://docs.python.org/3/library/time.html#time.perf_counter><code>time.perfcounter</code></a>, which has a resolution of 500 ns, smaller than the run time of the fastest query in this dataset.<ul><li>5 warmup runs are performed to prime query cache and ensure byte code compilation prior to measuring the run times<li>Each query is run for a <strong>minimum of 5 rounds</strong>, so the run times shown in each section below as the <strong>average over a minimum of 5 rounds</strong>, and as many as 80-90 rounds. <ul><li>Long-running queries (where the total run time exceeds 1 sec) are run for at least 5 rounds.<li>Short-running queries (of the order of milliseconds) will run as many times as fits into a period of 1 second, so the fastest queries run more than <strong>80</strong> rounds.</ul><li>Python’s own GC overhead can obscure true run times, so it’s disabled for the runtime computation</ul><p>See the <a rel="nofollow noreferrer" href=https://pytest-benchmark.readthedocs.io/en/latest/calibration.html><code>pytest-benchmark</code> docs</a> to see how they calibrate their timer and group the rounds.<h3 id=performance-1>Performance<a aria-label="Anchor link for: performance-1" class=zola-anchor href=#performance-1>#</a></h3><p>The Kùzu Cypher queries run are shown below. The Neo4j queries are identical, except for the fact that the labels and relationship types are capitalized, as is the convention in Neo4j.<h4 id=query-1>Query 1<a aria-label="Anchor link for: query-1" class=zola-anchor href=#query-1>#</a></h4><p><strong>Who are the top 3 most-followed persons?</strong><pre class=language-sql data-lang=sql style=background:#2e3440;color:#d8dee9><code class=language-sql data-lang=sql><span>MATCH (follower:Person)</span><span style=color:#81a1c1>-</span><span>[:Follows]</span><span style=color:#81a1c1>-></span><span>(person:Person)
</span><span>RETURN
</span><span>    person.id </span><span style=color:#81a1c1>AS</span><span> personID,
</span><span>    person.name </span><span style=color:#81a1c1>AS</span><span> name,
</span><span>    </span><span style=color:#88c0d0>COUNT</span><span>(follower.id) </span><span style=color:#81a1c1>AS</span><span> numFollowers
</span><span style=color:#81a1c1>ORDER BY</span><span> numFollowers </span><span style=color:#81a1c1>DESC LIMIT </span><span style=color:#b48ead>3
</span></code></pre><p>This query is a simple aggregation that counts the number of persons that have a “follows” relationship with other persons, and returns the top 3 persons with the most followers. The results are shown below.<pre class=language-sh data-lang=sh style=background:#2e3440;color:#d8dee9><code class=language-sh data-lang=sh><span style=color:#88c0d0>Top</span><span> 3 most-followed persons:
</span><span style=color:#88c0d0>shape:</span><span> (3, 3)
</span><span style=color:#88c0d0>┌──────────┬────────────────┬──────────────┐
</span><span style=color:#88c0d0>│</span><span> personID ┆ name           ┆ numFollowers │
</span><span style=color:#88c0d0>│</span><span> ---      ┆ ---            ┆ ---          │
</span><span style=color:#88c0d0>│</span><span> i64      ┆ str            ┆ i64          │
</span><span style=color:#88c0d0>╞══════════╪════════════════╪══════════════╡
</span><span style=color:#88c0d0>│</span><span> 85723    ┆ Rachel Cooper  ┆ 4998         │
</span><span style=color:#88c0d0>│</span><span> 68753    ┆ Claudia Booker ┆ 4985         │
</span><span style=color:#88c0d0>│</span><span> 54696    ┆ Brian Burgess  ┆ 4976         │
</span><span style=color:#88c0d0>└──────────┴────────────────┴──────────────┘
</span></code></pre><table><thead><tr><th style=text-align:center>Query<th style=text-align:right>Neo4j (sec)<th style=text-align:right>Kùzu (sec)<th style=text-align:center>Speedup factor<tbody><tr><td style=text-align:center>1<td style=text-align:right>1.8899<td style=text-align:right>0.1193300<td style=text-align:center>15.8</table><h4 id=query-2>Query 2<a aria-label="Anchor link for: query-2" class=zola-anchor href=#query-2>#</a></h4><p><strong>In which city does the most-followed person live?</strong><pre class=language-sql data-lang=sql style=background:#2e3440;color:#d8dee9><code class=language-sql data-lang=sql><span>MATCH (follower:Person)</span><span style=color:#81a1c1>-</span><span>[:Follows]</span><span style=color:#81a1c1>-></span><span>(person:Person)
</span><span style=color:#81a1c1>WITH</span><span> person, </span><span style=color:#88c0d0>COUNT</span><span>(follower.id) </span><span style=color:#81a1c1>as</span><span> numFollowers
</span><span style=color:#81a1c1>ORDER BY</span><span> numFollowers </span><span style=color:#81a1c1>DESC LIMIT </span><span style=color:#b48ead>1
</span><span>MATCH (person) </span><span style=color:#81a1c1>-</span><span>[:LivesIn]</span><span style=color:#81a1c1>-></span><span> (city:City)
</span><span>RETURN
</span><span>  person.name </span><span style=color:#81a1c1>AS</span><span> name,
</span><span>  numFollowers,
</span><span>  city.city </span><span style=color:#81a1c1>AS</span><span> city,
</span><span>  city.state </span><span style=color:#81a1c1>AS</span><span> state,
</span><span>  city.country </span><span style=color:#81a1c1>AS</span><span> country
</span></code></pre><p>Query 2 is very similar to query 1, but it attaches a subquery to find the city in which the most-followed person lives.<pre class=language-sh data-lang=sh style=background:#2e3440;color:#d8dee9><code class=language-sh data-lang=sh><span style=color:#88c0d0>City</span><span> in which most-followed person lives:
</span><span style=color:#88c0d0>shape:</span><span> (1, 5)
</span><span style=color:#88c0d0>┌───────────────┬──────────────┬────────┬───────┬───────────────┐
</span><span style=color:#88c0d0>│</span><span> name          ┆ numFollowers ┆ city   ┆ state ┆ country       │
</span><span style=color:#88c0d0>│</span><span> ---           ┆ ---          ┆ ---    ┆ ---   ┆ ---           │
</span><span style=color:#88c0d0>│</span><span> str           ┆ i64          ┆ str    ┆ str   ┆ str           │
</span><span style=color:#88c0d0>╞═══════════════╪══════════════╪════════╪═══════╪═══════════════╡
</span><span style=color:#88c0d0>│</span><span> Rachel Cooper ┆ 4998         ┆ Austin ┆ Texas ┆ United States │
</span><span style=color:#88c0d0>└───────────────┴──────────────┴────────┴───────┴───────────────┘
</span></code></pre><table><thead><tr><th style=text-align:center>Query<th style=text-align:right>Neo4j (sec)<th style=text-align:right>Kùzu (sec)<th style=text-align:center>Speedup factor<tbody><tr><td style=text-align:center>2<td style=text-align:right>0.6936<td style=text-align:right>0.1259888<td style=text-align:center>5.5</table><h4 id=query-3>Query 3<a aria-label="Anchor link for: query-3" class=zola-anchor href=#query-3>#</a></h4><p><strong>Which 5 cities in a particular country have the lowest average age in the network?</strong><pre class=language-sql data-lang=sql style=background:#2e3440;color:#d8dee9><code class=language-sql data-lang=sql><span>MATCH (p:Person) </span><span style=color:#81a1c1>-</span><span>[:LivesIn]</span><span style=color:#81a1c1>-></span><span> (c:City) </span><span style=color:#81a1c1>-</span><span>[</span><span style=color:#81a1c1>*</span><span style=color:#b48ead>1</span><span>..</span><span style=color:#b48ead>2</span><span>]</span><span style=color:#81a1c1>-></span><span> (co:Country)
</span><span style=color:#81a1c1>WHERE </span><span>co.country </span><span style=color:#81a1c1>=</span><span> $country
</span><span>RETURN c.city </span><span style=color:#81a1c1>AS</span><span> city, </span><span style=color:#88c0d0>AVG</span><span>(p.age) </span><span style=color:#81a1c1>AS</span><span> averageAge
</span><span style=color:#81a1c1>ORDER BY</span><span> averageAge </span><span style=color:#81a1c1>LIMIT </span><span style=color:#b48ead>5
</span></code></pre><p>This query performs a relatively simple multi-hop traversal to locate countries in which people live, groups them by city and computes the average age of persons in each city.<pre class=language-sh data-lang=sh style=background:#2e3440;color:#d8dee9><code class=language-sh data-lang=sh><span style=color:#88c0d0>Cities</span><span> with lowest average age in United States:
</span><span style=color:#88c0d0>shape:</span><span> (5, 2)
</span><span style=color:#88c0d0>┌───────────────┬────────────┐
</span><span style=color:#88c0d0>│</span><span> city          ┆ averageAge │
</span><span style=color:#88c0d0>│</span><span> ---           ┆ ---        │
</span><span style=color:#88c0d0>│</span><span> str           ┆ f64        │
</span><span style=color:#88c0d0>╞═══════════════╪════════════╡
</span><span style=color:#88c0d0>│</span><span> Louisville    ┆ 37.099473  │
</span><span style=color:#88c0d0>│</span><span> Denver        ┆ 37.202703  │
</span><span style=color:#88c0d0>│</span><span> San Francisco ┆ 37.26213   │
</span><span style=color:#88c0d0>│</span><span> Tampa         ┆ 37.327765  │
</span><span style=color:#88c0d0>│</span><span> Nashville     ┆ 37.343006  │
</span><span style=color:#88c0d0>└───────────────┴────────────┘
</span></code></pre><table><thead><tr><th style=text-align:center>Query<th style=text-align:right>Neo4j (sec)<th style=text-align:right>Kùzu (sec)<th style=text-align:center>Speedup factor<tbody><tr><td style=text-align:center>3<td style=text-align:right>0.0442<td style=text-align:right>0.0081799<td style=text-align:center>5.4</table><h4 id=query-4>Query 4<a aria-label="Anchor link for: query-4" class=zola-anchor href=#query-4>#</a></h4><p><strong>How many persons between ages 30-40 are there in each country?</strong><pre class=language-sql data-lang=sql style=background:#2e3440;color:#d8dee9><code class=language-sql data-lang=sql><span>MATCH (p:Person)</span><span style=color:#81a1c1>-</span><span>[:LivesIn]</span><span style=color:#81a1c1>-></span><span>(ci:City)</span><span style=color:#81a1c1>-</span><span>[</span><span style=color:#81a1c1>*</span><span style=color:#b48ead>1</span><span>..</span><span style=color:#b48ead>2</span><span>]</span><span style=color:#81a1c1>-></span><span>(country:Country)
</span><span style=color:#81a1c1>WHERE </span><span>p.age </span><span style=color:#81a1c1>>=</span><span> $age_lower </span><span style=color:#81a1c1>AND </span><span>p.age </span><span style=color:#81a1c1><=</span><span> $age_upper
</span><span>RETURN country.country </span><span style=color:#81a1c1>AS</span><span> countries, </span><span style=color:#88c0d0>COUNT</span><span>(country) </span><span style=color:#81a1c1>AS</span><span> personCounts
</span><span style=color:#81a1c1>ORDER BY</span><span> personCounts </span><span style=color:#81a1c1>DESC LIMIT </span><span style=color:#b48ead>3
</span></code></pre><p>Query 4 is a multi-hop traversal that counts the number of persons in each country that are between the ages of 30 and 40.<pre class=language-sh data-lang=sh style=background:#2e3440;color:#d8dee9><code class=language-sh data-lang=sh><span style=color:#88c0d0>Persons</span><span> between ages 30-40 in each country:
</span><span style=color:#88c0d0>shape:</span><span> (3, 2)
</span><span style=color:#88c0d0>┌────────────────┬──────────────┐
</span><span style=color:#88c0d0>│</span><span> countries      ┆ personCounts │
</span><span style=color:#88c0d0>│</span><span> ---            ┆ ---          │
</span><span style=color:#88c0d0>│</span><span> str            ┆ i64          │
</span><span style=color:#88c0d0>╞════════════════╪══════════════╡
</span><span style=color:#88c0d0>│</span><span> United States  ┆ 30473        │
</span><span style=color:#88c0d0>│</span><span> Canada         ┆ 3064         │
</span><span style=color:#88c0d0>│</span><span> United Kingdom ┆ 1873         │
</span><span style=color:#88c0d0>└────────────────┴──────────────┘
</span></code></pre><table><thead><tr><th style=text-align:center>Query<th style=text-align:right>Neo4j (sec)<th style=text-align:right>Kùzu (sec)<th style=text-align:center>Speedup factor<tbody><tr><td style=text-align:center>4<td style=text-align:right>0.0473<td style=text-align:right>0.0078041<td style=text-align:center>6.1</table><h4 id=query-5>Query 5<a aria-label="Anchor link for: query-5" class=zola-anchor href=#query-5>#</a></h4><p><strong>How many men in London, United Kingdom have an interest in fine dining?</strong><pre class=language-sql data-lang=sql style=background:#2e3440;color:#d8dee9><code class=language-sql data-lang=sql><span>MATCH (p:Person)</span><span style=color:#81a1c1>-</span><span>[:HasInterest]</span><span style=color:#81a1c1>-></span><span>(i:Interest)
</span><span style=color:#81a1c1>WHERE </span><span style=color:#88c0d0>lower</span><span>(i.interest) </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>lower</span><span>($interest)
</span><span style=color:#81a1c1>AND </span><span style=color:#88c0d0>lower</span><span>(p.gender) </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>lower</span><span>($gender)
</span><span style=color:#81a1c1>WITH</span><span> p, i
</span><span>MATCH (p)</span><span style=color:#81a1c1>-</span><span>[:LivesIn]</span><span style=color:#81a1c1>-></span><span>(c:City)
</span><span style=color:#81a1c1>WHERE </span><span>c.city </span><span style=color:#81a1c1>=</span><span> $city </span><span style=color:#81a1c1>AND </span><span>c.country </span><span style=color:#81a1c1>=</span><span> $country
</span><span>RETURN </span><span style=color:#88c0d0>COUNT</span><span>(p) </span><span style=color:#81a1c1>AS</span><span> numPersons
</span></code></pre><p>Query 5 combines the results from different paths, first between persons (men) who are interested in fine dining, followed by matching the cities in which these men live.<pre class=language-sh data-lang=sh style=background:#2e3440;color:#d8dee9><code class=language-sh data-lang=sh><span style=color:#88c0d0>Number</span><span> of male users in London, United Kingdom who have an interest in fine dining:
</span><span style=color:#88c0d0>shape:</span><span> (1, 1)
</span><span style=color:#88c0d0>┌────────────┐
</span><span style=color:#88c0d0>│</span><span> numPersons │
</span><span style=color:#88c0d0>│</span><span> ---        │
</span><span style=color:#88c0d0>│</span><span> i64        │
</span><span style=color:#88c0d0>╞════════════╡
</span><span style=color:#88c0d0>│</span><span> 52         │
</span><span style=color:#88c0d0>└────────────┘
</span></code></pre><table><thead><tr><th style=text-align:center>Query<th style=text-align:right>Neo4j (sec)<th style=text-align:right>Kùzu (sec)<th style=text-align:center>Speedup factor<tbody><tr><td style=text-align:center>5<td style=text-align:right>0.0086<td style=text-align:right>0.0046616<td style=text-align:center>1.8</table><h4 id=query-6>Query 6<a aria-label="Anchor link for: query-6" class=zola-anchor href=#query-6>#</a></h4><p><strong>Which city has the maximum number of women that like Tennis?</strong><pre class=language-sql data-lang=sql style=background:#2e3440;color:#d8dee9><code class=language-sql data-lang=sql><span>MATCH (p:Person)</span><span style=color:#81a1c1>-</span><span>[:HasInterest]</span><span style=color:#81a1c1>-></span><span>(i:Interest)
</span><span style=color:#81a1c1>WHERE </span><span style=color:#88c0d0>lower</span><span>(i.interest) </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>lower</span><span>($interest)
</span><span style=color:#81a1c1>AND </span><span style=color:#88c0d0>lower</span><span>(p.gender) </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>lower</span><span>($gender)
</span><span style=color:#81a1c1>WITH</span><span> p, i
</span><span>MATCH (p)</span><span style=color:#81a1c1>-</span><span>[:LivesIn]</span><span style=color:#81a1c1>-></span><span>(c:City)
</span><span>RETURN </span><span style=color:#88c0d0>COUNT</span><span>(p.id) </span><span style=color:#81a1c1>AS</span><span> numPersons, c.city </span><span style=color:#81a1c1>AS</span><span> city, c.country </span><span style=color:#81a1c1>AS</span><span> country
</span><span style=color:#81a1c1>ORDER BY</span><span> numPersons </span><span style=color:#81a1c1>DESC LIMIT </span><span style=color:#b48ead>5
</span></code></pre><p>Query 6 is similar to query 5, but shows the cities aggregated by the number of women interested in Tennis.<pre class=language-sh data-lang=sh style=background:#2e3440;color:#d8dee9><code class=language-sh data-lang=sh><span style=color:#88c0d0>City</span><span> with the most female users who have an interest in tennis:
</span><span style=color:#88c0d0>shape:</span><span> (5, 3)
</span><span style=color:#88c0d0>┌────────────┬────────────┬────────────────┐
</span><span style=color:#88c0d0>│</span><span> numPersons ┆ city       ┆ country        │
</span><span style=color:#88c0d0>│</span><span> ---        ┆ ---        ┆ ---            │
</span><span style=color:#88c0d0>│</span><span> i64        ┆ str        ┆ str            │
</span><span style=color:#88c0d0>╞════════════╪════════════╪════════════════╡
</span><span style=color:#88c0d0>│</span><span> 66         ┆ Birmingham ┆ United Kingdom │
</span><span style=color:#88c0d0>│</span><span> 66         ┆ Houston    ┆ United States  │
</span><span style=color:#88c0d0>│</span><span> 65         ┆ Raleigh    ┆ United States  │
</span><span style=color:#88c0d0>│</span><span> 64         ┆ Montreal   ┆ Canada         │
</span><span style=color:#88c0d0>│</span><span> 62         ┆ Phoenix    ┆ United States  │
</span><span style=color:#88c0d0>└────────────┴────────────┴────────────────┘
</span></code></pre><table><thead><tr><th style=text-align:center>Query<th style=text-align:right>Neo4j (sec)<th style=text-align:right>Kùzu (sec)<th style=text-align:center>Speedup factor<tbody><tr><td style=text-align:center>6<td style=text-align:right>0.0226<td style=text-align:right>0.0127203<td style=text-align:center>1.8</table><h4 id=query-7>Query 7<a aria-label="Anchor link for: query-7" class=zola-anchor href=#query-7>#</a></h4><p><strong>Which U.S. state has the maximum number of persons between the age 23-30 who enjoy photography?</strong><pre class=language-sql data-lang=sql style=background:#2e3440;color:#d8dee9><code class=language-sql data-lang=sql><span>MATCH (p:Person)</span><span style=color:#81a1c1>-</span><span>[:LivesIn]</span><span style=color:#81a1c1>-></span><span>(:City)</span><span style=color:#81a1c1>-</span><span>[:CityIn]</span><span style=color:#81a1c1>-></span><span>(s:State)
</span><span style=color:#81a1c1>WHERE </span><span>p.age </span><span style=color:#81a1c1>>=</span><span> $age_lower </span><span style=color:#81a1c1>AND </span><span>p.age </span><span style=color:#81a1c1><=</span><span> $age_upper </span><span style=color:#81a1c1>AND </span><span>s.country </span><span style=color:#81a1c1>=</span><span> $country
</span><span style=color:#81a1c1>WITH</span><span> p, s
</span><span>MATCH (p)</span><span style=color:#81a1c1>-</span><span>[:HasInterest]</span><span style=color:#81a1c1>-></span><span>(i:Interest)
</span><span style=color:#81a1c1>WHERE </span><span style=color:#88c0d0>lower</span><span>(i.interest) </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>lower</span><span>($interest)
</span><span>RETURN </span><span style=color:#88c0d0>COUNT</span><span>(p.id) </span><span style=color:#81a1c1>AS</span><span> numPersons, s.state </span><span style=color:#81a1c1>AS</span><span> state, s.country </span><span style=color:#81a1c1>AS</span><span> country
</span><span style=color:#81a1c1>ORDER BY</span><span> numPersons </span><span style=color:#81a1c1>DESC LIMIT </span><span style=color:#b48ead>1
</span></code></pre><p>This query first performs a multi-hop traversal to find the states in which persons live, and then filters them by the age range 23-30 and interest, photography.<pre class=language-sh data-lang=sh style=background:#2e3440;color:#d8dee9><code class=language-sh data-lang=sh><span style=color:#88c0d0>State</span><span> in United States with the most users between ages 23-30 who have an interest in photography:
</span><span style=color:#88c0d0>shape:</span><span> (1, 3)
</span><span style=color:#88c0d0>┌────────────┬────────────┬───────────────┐
</span><span style=color:#88c0d0>│</span><span> numPersons ┆ state      ┆ country       │
</span><span style=color:#88c0d0>│</span><span> ---        ┆ ---        ┆ ---           │
</span><span style=color:#88c0d0>│</span><span> i64        ┆ str        ┆ str           │
</span><span style=color:#88c0d0>╞════════════╪════════════╪═══════════════╡
</span><span style=color:#88c0d0>│</span><span> 170        ┆ California ┆ United States │
</span><span style=color:#88c0d0>└────────────┴────────────┴───────────────┘
</span></code></pre><table><thead><tr><th style=text-align:center>Query<th style=text-align:right>Neo4j (sec)<th style=text-align:right>Kùzu (sec)<th style=text-align:center>Speedup factor<tbody><tr><td style=text-align:center>7<td style=text-align:right>0.1625<td style=text-align:right>0.0067574<td style=text-align:center>24.1</table><h4 id=query-8>Query 8<a aria-label="Anchor link for: query-8" class=zola-anchor href=#query-8>#</a></h4><p><strong>How many second-degree paths exist in the graph?</strong><pre class=language-sql data-lang=sql style=background:#2e3440;color:#d8dee9><code class=language-sql data-lang=sql><span>MATCH (a:Person)</span><span style=color:#81a1c1>-</span><span>[r1:Follows]</span><span style=color:#81a1c1>-></span><span>(b:Person)</span><span style=color:#81a1c1>-</span><span>[r2:Follows]</span><span style=color:#81a1c1>-></span><span>(c:Person)
</span><span>RETURN </span><span style=color:#88c0d0>COUNT</span><span>(</span><span style=color:#81a1c1>*</span><span>) </span><span style=color:#81a1c1>AS</span><span> numPaths
</span></code></pre><p>Path-finding queries are generally very expensive, especially when they involve multi-hop traversals. Query 8 is a simple path-finding query that counts the number of second-degree paths in the graph.<pre class=language-sh data-lang=sh style=background:#2e3440;color:#d8dee9><code class=language-sh data-lang=sh><span style=color:#88c0d0>Number</span><span> of second-degree paths:
</span><span style=color:#88c0d0>shape:</span><span> (1, 1)
</span><span style=color:#88c0d0>┌──────────┐
</span><span style=color:#88c0d0>│</span><span> numPaths │
</span><span style=color:#88c0d0>│</span><span> ---      │
</span><span style=color:#88c0d0>│</span><span> i64      │
</span><span style=color:#88c0d0>╞══════════╡
</span><span style=color:#88c0d0>│</span><span> 58431994 │
</span><span style=color:#88c0d0>└──────────┘
</span></code></pre><table><thead><tr><th style=text-align:center>Query<th style=text-align:right>Neo4j (sec)<th style=text-align:right>Kùzu (sec)<th style=text-align:center>Speedup factor<tbody><tr><td style=text-align:center>8<td style=text-align:right>3.4529<td style=text-align:right>0.0191212<td style=text-align:center>180.5</table><p>This is interesting! Because the number of paths explode in complexity when it comes to multi-hop traversals, the speedup factor for Kùzu is higher than for the other queries. This is mainly due to the fact that Kùzu implements factorized query execution, which we will explore more in the <a href=https://thedataquarry.github.io/posts/embedded-db-2/#vectorized-execution>discussions</a>.<h4 id=query-9>Query 9<a aria-label="Anchor link for: query-9" class=zola-anchor href=#query-9>#</a></h4><p><strong>How many paths exist in the graph through persons age 50 to persons above age 25?</strong><pre class=language-sql data-lang=sql style=background:#2e3440;color:#d8dee9><code class=language-sql data-lang=sql><span>MATCH (a:Person)</span><span style=color:#81a1c1>-</span><span>[r1:Follows]</span><span style=color:#81a1c1>-></span><span>(b:Person)</span><span style=color:#81a1c1>-</span><span>[r2:Follows]</span><span style=color:#81a1c1>-></span><span>(c:Person)
</span><span style=color:#81a1c1>WHERE </span><span>b.age </span><span style=color:#81a1c1><</span><span> $age_1 </span><span style=color:#81a1c1>AND </span><span>c.age </span><span style=color:#81a1c1>></span><span> $age_2
</span><span>RETURN </span><span style=color:#88c0d0>COUNT</span><span>(</span><span style=color:#81a1c1>*</span><span>) </span><span style=color:#81a1c1>as</span><span> numPaths
</span></code></pre><p>This query is similar to query 8, but adds filters on the age of persons in the paths obtained.<pre class=language-sh data-lang=sh style=background:#2e3440;color:#d8dee9><code class=language-sh data-lang=sh><span style=color:#88c0d0>Number</span><span> of paths through persons below 50 to persons above 25:
</span><span style=color:#88c0d0>shape:</span><span> (1, 1)
</span><span style=color:#88c0d0>┌──────────┐
</span><span style=color:#88c0d0>│</span><span> numPaths │
</span><span style=color:#88c0d0>│</span><span> ---      │
</span><span style=color:#88c0d0>│</span><span> i64      │
</span><span style=color:#88c0d0>╞══════════╡
</span><span style=color:#88c0d0>│</span><span> 45632026 │
</span><span style=color:#88c0d0>└──────────┘
</span></code></pre><table><thead><tr><th style=text-align:center>Query<th style=text-align:right>Neo4j (sec)<th style=text-align:right>Kùzu (sec)<th style=text-align:center>Speedup factor<tbody><tr><td style=text-align:center>9<td style=text-align:right>4.2707<td style=text-align:right>0.0226162<td style=text-align:center>188.7</table><p>As can be seen, the speedup is even greater than the previous query, because filtering on node properties for paths that explode in complexity can incur a significant overhead in large graphs.<h2 id=why-was-kuzu-faster-than-neo4j>Why was Kùzu faster than Neo4j?<a aria-label="Anchor link for: why-was-kuzu-faster-than-neo4j" class=zola-anchor href=#why-was-kuzu-faster-than-neo4j>#</a></h2><p>It’s worth digging a bit deeper into some of the key innovations in Kùzu that allow it to achieve this level of blazing fast 🔥 performance. To start with, let’s summarize the query benchmark results – the numbers next to each bar represent the speedup factors of Kùzu over Neo4j for each query.<figure><img alt="Kùzu's <a href='https://github.com/prrao87/kuzudb-study'>speedup</a> over Neo4j over 9 distinct queries<br/><b>Note:</b> more recent versions of either DB may show different numbers" loading=lazy src=kuzudb-neo4j-query-perf-multi-threaded.png><figcaption>Kùzu's <a href=https://github.com/prrao87/kuzudb-study>speedup</a> over Neo4j over 9 distinct queries<br><b>Note:</b> more recent versions of either DB may show different numbers</figcaption></figure><p>There are a multitude of reasons why Kùzu is faster than Neo4j in all queries, and they can be a bit tricky to tease apart. Let’s go through them one by one.<h4 id=vectorized-execution>Vectorized execution<a aria-label="Anchor link for: vectorized-execution" class=zola-anchor href=#vectorized-execution>#</a></h4><p>Kùzu executes queries in a vectorized fashion, enabled by the fact that data is stored natively in a column-oriented manner and accessed in batches. This is a similar approach as used by numerous other OLAP DBMSs such as DuckDB<sup class=footnote-reference><a href=#3>3</a></sup> and ClickHouse<sup class=footnote-reference><a href=#4>4</a></sup>. In modern hardware, column-oriented storage allows more cache locality, while also allowing CPU optimizations that take advantage of SIMD, a type of parallel processing that performs the same operation on multiple data points via a single instruction.<h4 id=multi-threaded-execution>Multi-threaded execution<a aria-label="Anchor link for: multi-threaded-execution" class=zola-anchor href=#multi-threaded-execution>#</a></h4><p>Query execution is multi-threaded via “morsel-driven parallelism”<sup class=footnote-reference><a href=#5>5</a></sup> – in this approach, the query workload is divided into several small parts (morsels) that are dynamically distributed between threads during runtime. Each thread takes its own morsel as far through the pipeline as possible, only stopping & synchronizing with other threads when absolutely needed.<h4 id=worst-case-optimal-joins-wcoj>Worst-case optimal joins (WCOJ)<a aria-label="Anchor link for: worst-case-optimal-joins-wcoj" class=zola-anchor href=#worst-case-optimal-joins-wcoj>#</a></h4><p>WCOJ algorithms are a class of join algorithms for queries involving cyclic joins (involving cycles or cliques) over many-to-many relationships in a graph, that are evaluated a <em>column</em> at a time (multi-way), instead of a table at a time (binary). Kùzu generates query plans that seamlessly combine binary joins and WCOJ-style multiway intersections, as described in their blog<sup class=footnote-reference><a href=#6>6</a></sup>. When the query has a strong cyclic component involving many-to-many relationships, WCOJ really speeds up execution, whereas for queries that are more acyclic, binary joins are the go-to.<h4 id=factorized-execution>Factorized execution<a aria-label="Anchor link for: factorized-execution" class=zola-anchor href=#factorized-execution>#</a></h4><p>Factorization is perhaps the most significant contributor to performance, explaining why queries 8 and 9, specifically, show such a huge speedup over Neo4j. Factorization is a compression technique used by query processors to compress intermediate results when evaluating many-to-many joins. This results in an exponential reduction in the ultimate result set size, allowing massive performance gains in queries that involve multi-hop traversals across nodes that possess many-to-many relationships.<p>Queries 8 and 9 specifically demonstrate the power of factorization, because in this social network graph, finding paths between intermediate nodes can become <em>really</em> expensive at multiple levels of depth due to the presence of “super nodes”, i.e., persons who are followed by thousands of other persons.<p>Recall that query 9 attempts to find the number of paths to second-degree connections via filters as follows:<pre class=language-sql data-lang=sql style=background:#2e3440;color:#d8dee9><code class=language-sql data-lang=sql><span>MATCH (a:Person)</span><span style=color:#81a1c1>-</span><span>[r1:Follows]</span><span style=color:#81a1c1>-></span><span>(b:Person)</span><span style=color:#81a1c1>-</span><span>[r2:Follows]</span><span style=color:#81a1c1>-></span><span>(c:Person)
</span><span style=color:#81a1c1>WHERE </span><span>b.age </span><span style=color:#81a1c1>< </span><span style=color:#b48ead>50 </span><span style=color:#81a1c1>AND </span><span>c.age </span><span style=color:#81a1c1>> </span><span style=color:#b48ead>25
</span><span>RETURN </span><span style=color:#88c0d0>COUNT</span><span>(</span><span style=color:#81a1c1>*</span><span>) </span><span style=color:#81a1c1>as</span><span> numPaths
</span></code></pre><p>To analyze what Kùzu’s query planner is doing, we will consider two nodes <code>b</code> of type <code>Person</code> that sit in the middle of the second-degree paths, having 100 incoming edges and 100 outgoing edges. This can be represented graphically as follows.<figure><img loading=lazy src=kuzudb-factorization-graph.png></figure><p>During query processing, the information that flows between pipeline operators consists of flat tuples, so the graph above will essentially be transformed to sets of redundantly stored tuples with a lot of data repetition. The aim of factorization is to compress this intermediate result set as much as possible, avoiding unnecessary repeated computations at each stage in the query pipeline.<figure><img alt="Image inspired by this excellent Kùzu <a href='https://kuzudb.com/docusaurus/blog/factorization'>technical blogpost</a>" loading=lazy src=kuzudb-factorization-table.png><figcaption>Image inspired by this excellent Kùzu <a href=https://kuzudb.com/docusaurus/blog/factorization>technical blogpost</a></figcaption></figure><p>As can be seen, the initial flat representation in this simple example had $2 \times (100 \times 100) = 20000$ tuples. However, after factorization, the number of tuples is reduced to $2 \times (100 + 100) = 400$ tuples. This is a <strong>50x</strong> reduction in the number of tuples that need to be processed by the query engine, which is already huge. In the real dataset, the data reduction due to factorization is more like <strong>100x</strong>, and this only grows as we traverse greater depths in the graph, explaining why these sorts of multi-hop path-finding queries are so much faster in Kùzu than in Neo4j.<h2 id=conclusions>Conclusions<a aria-label="Anchor link for: conclusions" class=zola-anchor href=#conclusions>#</a></h2><p>I hope this post made it clear why Kùzu is such an exciting graph database. Its embedded nature makes it extremely easy to integrate with existing data workflows, with minimal infrastructure setup. Most importantly, it aims to scale to very large graphs via its key innovations in query processing and performance, which is the main bottleneck in graph analytics today. Another key advantage of embedded databases like Kùzu is the additional reduction in latency due to the fact that queries run within the application layer itself, eliminating the serialization/deserialization overhead of passing blobs of data from a remote server to the application instance.<p>Even though Kùzu is designed to run in-process on a single node, it follows the DuckDB philosophy of doing the most work possible while utilizing multiple threads and as much memory as is available, so it’s possible to get a lot more done than one might imagine on a single node. This is a very different approach from Neo4j’s approach to scalability, which uses a “fabric” architecture, requiring far more complex infrastructure, not to mention that it’s a lot more expensive to run.<p>If you’ve read along this far, you may be wondering, how large of a graph can one analyze in Kùzu? Based on my conversations with the Kùzu team over the last several months, it’s amply clear that Kùzu can scale to graphs that contain hundreds of millions of nodes and billions of edges. In fact, Kùzu is regularly tested on the <a rel="nofollow noreferrer" href=https://ldbcouncil.org/benchmarks/snb/>LDBC SF100</a> graph benchmark, i.e., the 100 Gb variant of this dataset that contains ~280M nodes and 1.7B edges.<p>Kùzu’s ability to perform OLAP-querying on large graphs makes a lot of sense in production, especially for datasets containing many-to-many relationships and a large number of cliques/cycles. The added bonus is that it’s a lot easier for graph data scientists and machine learning practitioners to connect their Kùzu graph to ML libraries like Pytorch Geometric (all it takes is <code>pip install kuzu</code>, without any added infrastructure).<p>Thanks for reading this far, and consider going to Kuzu’s <a rel="nofollow noreferrer" href=https://github.com/kuzudb/kuzu>GitHub repo</a> and giving them a star ⭐️!<p>Other posts in this series:<ul><li><a href=../embedded-db-1>Embedded databases (1): The harmony of DuckDB, Kùzu and LanceDB</a><li><a href=../embedded-db-3>Embedded databases (3): LanceDB and the modular data stack</a></ul><h2 id=code>Code<a aria-label="Anchor link for: code" class=zola-anchor href=#code>#</a></h2><p>All the code required to reproduce the results shown in this case study is available <a rel="nofollow noreferrer" href=https://github.com/prrao87/kuzudb-study>on GitHub</a>. I’d love to hear from anybody who uses a similar approach on their own data for even larger graphs, so do reach out if you’ve had success!<h3 id=additional-resources>Additional resources<a aria-label="Anchor link for: additional-resources" class=zola-anchor href=#additional-resources>#</a></h3><ul><li>Kùzu <a rel="nofollow noreferrer" href=https://kuzudb.com/chat>Discord</a>: Discuss ideas, use cases and issues with the developers and the user community<li>Kùzu <a rel="nofollow noreferrer" href=https://kuzudb.com/docusaurus/blog/>Blog</a>: Learn about the latest developments and the tool’s internals at a deeper technical level</ul><hr><div class=footnote-definition id=1><sup class=footnote-definition-label>1</sup><p>What every competent graph database management system should do, <a rel="nofollow noreferrer" href=https://kuzudb.com/docusaurus/blog/what-every-gdbms-should-do-and-vision/>Kùzu blog</a></div><div class=footnote-definition id=2><sup class=footnote-definition-label>2</sup><p>RDF support roadmap, <a rel="nofollow noreferrer" href=https://github.com/kuzudb/kuzu/issues/1570>Kùzu GitHub</a></div><div class=footnote-definition id=3><sup class=footnote-definition-label>3</sup><p>Why DuckDB, <a rel="nofollow noreferrer" href=https://duckdb.org/why_duckdb.html>DuckDB docs</a></div><div class=footnote-definition id=4><sup class=footnote-definition-label>4</sup><p>Why is ClickHouse so fast? <a rel="nofollow noreferrer" href=https://clickhouse.com/docs/zh/faq/general/why-clickhouse-is-so-fast>ClickHouse FAQ</a></div><div class=footnote-definition id=5><sup class=footnote-definition-label>5</sup><p>Morsel-Driven Parallelism, <a rel="nofollow noreferrer" href=https://dl.acm.org/doi/10.1145/2588555.2610507>Leis et al.</a></div><div class=footnote-definition id=6><sup class=footnote-definition-label>6</sup><p>Why graph DBMSs need new join algorithms, <a rel="nofollow noreferrer" href=https://kuzudb.com/docusaurus/blog/wcoj>Kùzu blog</a></div></article><div class=giscus></div><script async crossorigin data-category=General data-category-id=DIC_kwDOKyWhTs4CbUSt data-emit-metadata=0 data-input-position=bottom data-lang=en data-loading=lazy data-mapping=pathname data-reactions-enabled=1 data-repo=thedataquarry/thedataquarry.github.io data-repo-id=R_kgDOKyWhTg data-strict=0 data-theme=preferred_color_scheme src=https://giscus.app/client.js></script></div><footer><div class=copyright><p>© 2024 Prashanth Rao</div><div class=credits>Powered by <a rel="noreferrer noopener" href=https://www.getzola.org target=_blank>zola</a> and <a rel="noreferrer noopener" href=https://github.com/isunjn/serene target=_blank>serene</a></div></footer></main></div><script src=/js/lightense.min.js></script><script src=/js/main.js></script>