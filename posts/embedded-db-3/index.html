<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="light dark" name=color-scheme><title>Embedded databases (3): LanceDB and the modular data stack | The Data Quarry</title><meta content="Embedded databases (3): LanceDB and the modular data stack" property=og:title><meta content="Prashanth Rao" name=author><meta content=en_US property=og:locale><meta content="A case study of LanceDB, an embedded vector DB for full-text, SQL and semantic search" name=description><meta content="A case study of LanceDB, an embedded vector DB for full-text, SQL and semantic search" property=og:description><link href=https://thedataquarry.github.io/posts/embedded-db-3/ rel=canonical><meta content=https://thedataquarry.github.io/posts/embedded-db-3/ property=og:url><meta content="The Data Quarry" property=og:site_name><meta content=https://thedataquarry.github.io/img/dataquarry-banner.png property=og:image><meta content=article property=og:type><meta content=2023-11-20T00:00:00+00:00 property=article:published_time><meta " content=summary_large_image name=twitter:card><meta content=https://thedataquarry.github.io/img/dataquarry-banner.png property=twitter:image><meta content="Embedded databases (3): LanceDB and the modular data stack" property=twitter:title><meta content=@tech_optimist name=twitter:site><meta content="A case study of LanceDB, an embedded vector DB for full-text, SQL and semantic search" name=description><title>Embedded databases (3): LanceDB and the modular data stack</title><link href=/img/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/img/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/img/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><style>body{--primary-color:#376dd9;--primary-pale-color:#698bcf1c;--inline-code-color:#444;--text-color:#444;--text-pale-color:#545967;--bg-color:#fff;--highlight-mark-color:#5f75b045;--callout-note-color:#3e70d6;--callout-important-color:#7a46cd;--callout-warning-color:#d3822b;--callout-alert-color:#d43f3f;--callout-question-color:#3089b5;--callout-tip-color:#35a06b;--main-font:"IBMPlexSans",ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--code-font:"IBMPlexMono",ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--homepage-max-width:750px;--main-max-width:750px;--avatar-size:175px;--paragraph-font-size:16px;--paragraph-line-height:1.5em;--aside-font-size:16px;--img-border-radius:4px;--inline-code-border-radius:2px}body.dark{--primary-color:#689afd;--primary-pale-color:#93acdd1c;--inline-code-color:#d2d2d2;--text-color:#ddd;--text-pale-color:#a0a0a0;--bg-color:#202124;--highlight-mark-color:#5f75b045;--callout-note-color:#698bcf;--callout-important-color:#9374c5;--callout-warning-color:#c99054;--callout-alert-color:#d35757;--callout-question-color:#5091b2;--callout-tip-color:#3ea06f}</style><link href=/main.css rel=stylesheet><script async data-website-id=01228822-c189-4b8a-93ba-733d045bf346 src=https://analytics.eu.umami.is/script.js></script><body class=post><script>if(localStorage.getItem('theme')=='dark'){document.body.classList.add('dark');const a=document.querySelector('link#hl');if(a)a.href='/hl-dark.css'}</script><header class=blur><div id=header-wrapper><nav><a href=/>The Data Quarry</a><button aria-label="toggle expand" class=separator id=toggler>::</button><span class="wrap left fold">{</span><a href=/posts>blog</a><span class="wrap-separator fold">,</span><a class=fold href=/talks>talks</a><span class="wrap-separator fold">,</span><a class=fold href=/projects>projects</a><span class="wrap right fold">} ;</span></nav><div id=btns><a rel="noreferrer noopener" aria-label=GitHub href=https://github.com/prrao87 target=_blank> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12" fill=currentColor></path></svg> </a><a rel="noreferrer noopener" aria-label=Twitter href=https://twitter.com/tech_optimist target=_blank> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>Twitter</title><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z" fill=currentColor></path></svg> </a><a rel="noreferrer noopener" aria-label=LinkedIn href=https://www.linkedin.com/in/prrao87 target=_blank> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z" fill=currentColor></path></svg> </a><a aria-label="Buy me a coffee" rel="noreferrer noopener" href=https://www.buymeacoffee.com/prrao87 target=_blank> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>Buy Me A Coffee</title><path d="M20.216 6.415l-.132-.666c-.119-.598-.388-1.163-1.001-1.379-.197-.069-.42-.098-.57-.241-.152-.143-.196-.366-.231-.572-.065-.378-.125-.756-.192-1.133-.057-.325-.102-.69-.25-.987-.195-.4-.597-.634-.996-.788a5.723 5.723 0 00-.626-.194c-1-.263-2.05-.36-3.077-.416a25.834 25.834 0 00-3.7.062c-.915.083-1.88.184-2.75.5-.318.116-.646.256-.888.501-.297.302-.393.77-.177 1.146.154.267.415.456.692.58.36.162.737.284 1.123.366 1.075.238 2.189.331 3.287.37 1.218.05 2.437.01 3.65-.118.299-.033.598-.073.896-.119.352-.054.578-.513.474-.834-.124-.383-.457-.531-.834-.473-.466.074-.96.108-1.382.146-1.177.08-2.358.082-3.536.006a22.228 22.228 0 01-1.157-.107c-.086-.01-.18-.025-.258-.036-.243-.036-.484-.08-.724-.13-.111-.027-.111-.185 0-.212h.005c.277-.06.557-.108.838-.147h.002c.131-.009.263-.032.394-.048a25.076 25.076 0 013.426-.12c.674.019 1.347.067 2.017.144l.228.031c.267.04.533.088.798.145.392.085.895.113 1.07.542.055.137.08.288.111.431l.319 1.484a.237.237 0 01-.199.284h-.003c-.037.006-.075.01-.112.015a36.704 36.704 0 01-4.743.295 37.059 37.059 0 01-4.699-.304c-.14-.017-.293-.042-.417-.06-.326-.048-.649-.108-.973-.161-.393-.065-.768-.032-1.123.161-.29.16-.527.404-.675.701-.154.316-.199.66-.267 1-.069.34-.176.707-.135 1.056.087.753.613 1.365 1.37 1.502a39.69 39.69 0 0011.343.376.483.483 0 01.535.53l-.071.697-1.018 9.907c-.041.41-.047.832-.125 1.237-.122.637-.553 1.028-1.182 1.171-.577.131-1.165.2-1.756.205-.656.004-1.31-.025-1.966-.022-.699.004-1.556-.06-2.095-.58-.475-.458-.54-1.174-.605-1.793l-.731-7.013-.322-3.094c-.037-.351-.286-.695-.678-.678-.336.015-.718.3-.678.679l.228 2.185.949 9.112c.147 1.344 1.174 2.068 2.446 2.272.742.12 1.503.144 2.257.156.966.016 1.942.053 2.892-.122 1.408-.258 2.465-1.198 2.616-2.657.34-3.332.683-6.663 1.024-9.995l.215-2.087a.484.484 0 01.39-.426c.402-.078.787-.212 1.074-.518.455-.488.546-1.124.385-1.766zm-1.478.772c-.145.137-.363.201-.578.233-2.416.359-4.866.54-7.308.46-1.748-.06-3.477-.254-5.207-.498-.17-.024-.353-.055-.47-.18-.22-.236-.111-.71-.054-.995.052-.26.152-.609.463-.646.484-.057 1.046.148 1.526.22.577.088 1.156.159 1.737.212 2.48.226 5.002.19 7.472-.14.45-.06.899-.13 1.345-.21.399-.072.84-.206 1.08.206.166.281.188.657.162.974a.544.544 0 01-.169.364zm-6.159 3.9c-.862.37-1.84.788-3.109.788a5.884 5.884 0 01-1.569-.217l.877 9.004c.065.78.717 1.38 1.5 1.38 0 0 1.243.065 1.658.065.447 0 1.786-.065 1.786-.065.783 0 1.434-.6 1.499-1.38l.94-9.95a3.996 3.996 0 00-1.322-.238c-.826 0-1.491.284-2.26.613z" fill=currentColor></path></svg> </a><button aria-label="theme switch" data-moon-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill="currentColor"></path></svg>' data-sun-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12C18 15.3137 15.3137 18 12 18ZM12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM11 1H13V4H11V1ZM11 20H13V23H11V20ZM3.51472 4.92893L4.92893 3.51472L7.05025 5.63604L5.63604 7.05025L3.51472 4.92893ZM16.9497 18.364L18.364 16.9497L20.4853 19.0711L19.0711 20.4853L16.9497 18.364ZM19.0711 3.51472L20.4853 4.92893L18.364 7.05025L16.9497 5.63604L19.0711 3.51472ZM5.63604 16.9497L7.05025 18.364L4.92893 20.4853L3.51472 19.0711L5.63604 16.9497ZM23 11V13H20V11H23ZM4 11V13H1V11H4Z" fill="currentColor"></path></svg>' id=theme-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill=currentColor></path></svg></button><button aria-label="table of content" id=toc-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M3 4H21V6H3V4ZM3 11H15V13H3V11ZM3 18H21V20H3V18Z" fill=currentColor></path></svg></button></div></div></header><div id=wrapper><div id=blank></div><aside class=blur><nav><ul><li><a class=h2 href=#an-evolving-hardware-landscape>An evolving hardware landscape</a> <ul><li><a class=h3 href=#towards-deconstructed-databases>Towards “deconstructed databases”</a></ul><li><a class=h2 href=#the-composition-of-lancedb>The composition of LanceDB</a> <ul><li><a class=h3 href=#lance>Lance</a><li><a class=h3 href=#arrow>Arrow</a><li><a class=h3 href=#datafusion>DataFusion</a><li><a class=h3 href=#tantivy>Tantivy</a></ul><li><a class=h2 href=#embedded-vs-serverless>Embedded vs. serverless</a><li><a class=h2 href=#benchmark-full-text-and-vector-search>Benchmark: Full-text and vector search</a> <ul><li><a class=h3 href=#dataset>Dataset</a><li><a class=h3 href=#full-text-search-fts-queries>Full-text search (FTS) queries</a><li><a class=h3 href=#vector-search-queries>Vector search queries</a><li><a class=h3 href=#serial-benchmark>Serial benchmark</a><li><a class=h3 href=#concurrent-benchmark>Concurrent benchmark</a></ul><li><a class=h2 href=#results>Results</a> <ul><li><a class=h3 href=#qualitative-inspection>Qualitative inspection</a><li><a class=h3 href=#throughput>Throughput</a></ul><li><a class=h2 href=#composable-systems-improve-nonlinearly>Composable systems improve nonlinearly</a><li><a class=h2 href=#future-developments-in-the-lance-ecosystem>Future developments in the Lance ecosystem</a><li><a class=h2 href=#code>Code</a></ul></nav><button aria-label="back to top" id=back-to-top><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M11.9997 10.8284L7.04996 15.7782L5.63574 14.364L11.9997 8L18.3637 14.364L16.9495 15.7782L11.9997 10.8284Z" fill=currentColor></path></svg></button></aside><main><div><div data-check-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z" fill="currentColor"></path></svg>' data-copy-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill="currentColor"></path></svg>' id=copy-cfg style=display:none></div><article data-backlink-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M9.41421 8L18.0208 16.6066L16.6066 18.0208L8 9.41421V17H6V6H17V8H9.41421Z" fill="currentColor"></path></svg>' class=prose><h1>Embedded databases (3): LanceDB and the modular data stack</h1><div id=post-info><div id=date><span id=publish>2023-11-20</span></div><div id=tags><a href=https://thedataquarry.github.io/tags/embedded-db><span>#</span>embedded-db</a><a href=https://thedataquarry.github.io/tags/vector-db><span>#</span>vector-db</a></div></div><h2 id=an-evolving-hardware-landscape>An evolving hardware landscape<a aria-label="Anchor link for: an-evolving-hardware-landscape" class=zola-anchor href=#an-evolving-hardware-landscape>#</a></h2><p>In September 2023, Wes McKinney, creator of the Pandas library, published an illuminating <a rel="nofollow noreferrer" href=https://wesmckinney.com/blog/looking-back-15-years/>blog post</a> describing his thoughts on 15 years of evolution in data management systems. In particular, he highlights the impact of modern hardware in pushing the industry towards a more modular, composable data stack. It’s no wonder, then, that his friend, colleague and co-author of Pandas, <a rel="nofollow noreferrer" href=https://github.com/changhiskhan>Chang She</a> happens to be the founder of LanceDB, a developer-friendly embedded vector database that aligns very well with this vision, and is the focus of the third post in <a rel="nofollow noreferrer" href=https://thedataquarry.com/tags/embedded-db/>this series</a>.<p>LanceDB is an open source, embedded and developer-friendly vector database. Some of its key features (among many others) that make it different from a number of existing solutions are listed below:<ul><li>Incredibly lightweight (no DB servers to manage), because it is entirely in-process<li>Extremely scalable from development to production<li>Ability to perform full-text search (FTS), SQL search and vector search<li>Multi-modal data support (images, text, video, audio, point-clouds, etc.)<li>Zero-copy (via Arrow) with automatic versioning of data</ul><p>The aim of this post is to understand the internals of LanceDB, and to showcase its performance on full-text and vector search via serial and concurrent workflows.<h3 id=towards-deconstructed-databases>Towards “deconstructed databases”<a aria-label="Anchor link for: towards-deconstructed-databases" class=zola-anchor href=#towards-deconstructed-databases>#</a></h3><p>The term <em>deconstructed database</em><sup class=footnote-reference><a href=#1>1</a></sup> was coined in 2019 by Julien Le Dem, one of the original designers of the Parquet file format and Arrow specification. These database systems deviate from the well-known vertically-integrated systems that have dominated the DB landscape for decades. Instead, they are built from a collection of modular, reusable components, each of which can be developed and optimized by entirely separate groups of people, typically as open source projects.<p>In his blog<sup class=footnote-reference><a href=#2>2</a></sup>, Wes points out that today’s compute hardware is radically different from what it was in 2013, when Parquet was conceived. In particular, the availability of blazing fast SSDs and NVMe drives have led to a shift in thinking toward designing systems that can store and query specialized data types like vectors and time series at scale. This explains the development of Lance, a new data format for the age of AI.<h2 id=the-composition-of-lancedb>The composition of LanceDB<a aria-label="Anchor link for: the-composition-of-lancedb" class=zola-anchor href=#the-composition-of-lancedb>#</a></h2><p>With these ideas in mind, let’s deconstruct LanceDB. On the <em>surface</em>, it is a vector database written in Rust, but <em>underneath</em>, it’s a collection of specialized modular components which are themselves independent components of the Rust 🦀 tooling ecosystem.<figure><img alt="The modular components of LanceDB" loading=lazy src=lancedb-components.png><figcaption>The modular components of LanceDB</figcaption></figure><p>LanceDB implements its own vector index on top of the underlying <a rel="nofollow noreferrer" href=https://lancedb.github.io/lance/>Lance</a> data format, which is an IVF-PQ disk-based index. Tantivy is an open source full-text search engine incorporated to allow keyword-based search via BM25. DataFusion, an embeddable SQL query engine, is used to power the full-text/vector search queries via a SQL interface. The Apache arrow format is used to allow a smooth transition between in-memory and on-disk data storage, and also for seamless interoperability with other data formats from systems like DuckDB, Pandas or Polars.<h3 id=lance>Lance<a aria-label="Anchor link for: lance" class=zola-anchor href=#lance>#</a></h3><p><a rel="nofollow noreferrer" href=https://github.com/lancedb/lance>Lance</a> is the persistent storage format used in LanceDB. It is optimized for machine learning datasets and workflows, and can be thought of as an alternative to Parquet that’s highly optimized for ultra fast scans and random access on vectors. In addition, it has great support for multi-modal data (images, text, video, audio, point-clouds, etc.) in a zero-copy manner, thanks to its integration with the Arrow ecosystem.<h3 id=arrow>Arrow<a aria-label="Anchor link for: arrow" class=zola-anchor href=#arrow>#</a></h3><p>It’s impossible to overstate the impact that Apache Arrow<sup class=footnote-reference><a href=#2>2</a></sup> has had on the consolidation of analytical tooling in the industry, due to the way it connects disparate portions of the data stack via an in-memory, language-agnostic specification. The following key features of Arrow<sup class=footnote-reference><a href=#2>2</a></sup> are relevant:<ul><li>Column-oriented in-memory operation optimized for fast analytical processing<li><a rel="nofollow noreferrer" href=https://en.wikipedia.org/wiki/Zero-copy>Zero-copy</a>, chunk-oriented data layer designed for moving and accessing large amounts of data from disparate storage layers<li>Extensible type metadata for describing a wide variety of flat and nested data types occurring in real-world systems, with support for user-defined types</ul><p>Lance is based on the Rust implementation of Arrow, <a rel="nofollow noreferrer" href=https://github.com/apache/arrow-rs><code>arrow-rs</code></a>, and was itself rewritten from the ground up in Rust in 2023<sup class=footnote-reference><a href=#3>3</a></sup> (having originally been written in C++).<h3 id=datafusion>DataFusion<a aria-label="Anchor link for: datafusion" class=zola-anchor href=#datafusion>#</a></h3><p><a rel="nofollow noreferrer" href=https://github.com/apache/arrow-datafusion>DataFusion</a> is a fast, extensible, embeddable query engine that supports a SQL API, and can be used to query data stored in Arrow and Lance. In recent times, it has become the standard for building domain-specific query engines that are decoupled from the storage layer, and because it’s written in Rust, performance is excellent despite not being natively integrated with the storage layer. Due to its extensibility, DataFusion has been re-purposed to generate optimized query plans for LanceDB for full-text/vector search via a unified SQL interface.<h3 id=tantivy>Tantivy<a aria-label="Anchor link for: tantivy" class=zola-anchor href=#tantivy>#</a></h3><p><a rel="nofollow noreferrer" href=https://github.com/quickwit-oss/tantivy>Tantivy</a> is a full-text search engine library written in Rust. It’s very similar to Apache Lucene (which is written in Java), but Tantivy is faster<sup class=footnote-reference><a href=#4>4</a></sup> and more memory efficient. Just like Lucene, Tantivy is not intended to be user-facing, but rather, is used as the basis of a downstream system such as LanceDB. Tantivy uses the BM25 algorithm for scoring documents, and supports boolean queries, phrase queries, fuzzy queries, and range queries. Incorporating Tantivy into LanceDB allows for full-text search queries that run directly on a Lance dataset.<blockquote class="callout note"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM11 7H13V9H11V7ZM11 11H13V17H11V11Z" fill=currentColor></path></svg></div><div class=content><p>Based on the components listed above, we can see how LanceDB is a byproduct of multiple modular systems that come together to create a powerful vector database system with in-built data versioning and fast performance, while exposing interfaces for full-text, SQL and semantic search queries.</div></blockquote><h2 id=embedded-vs-serverless>Embedded vs. serverless<a aria-label="Anchor link for: embedded-vs-serverless" class=zola-anchor href=#embedded-vs-serverless>#</a></h2><p>It’s rather common to see the terms “embedded” and “serverless” used interchangeably, but for a database, they are not the same architecturally. LanceDB is available to users in more than one flavour:<ul><li>Open source LanceDB is <em>embedded</em>, meaning that the storage layer and the application layer are tightly coupled, and are typically on the same instance/machine<li>LanceDB Cloud & LanceDB Enterprise (both commercial products) are <em>serverless</em>, meaning that storage and compute are clearly separated. This is done by connecting the application client to a remote database via a network connection, with the application layer and storage layer being scaled independently of one another.</ul><h2 id=benchmark-full-text-and-vector-search>Benchmark: Full-text and vector search<a aria-label="Anchor link for: benchmark-full-text-and-vector-search" class=zola-anchor href=#benchmark-full-text-and-vector-search>#</a></h2><p>Studying the performance of any tool in isolation doesn’t make much sense, so for the sake of comparison, an Elasticsearch workflow is provided in this repo. Elasticsearch is a popular full-text and vector search engine based on Lucene (which Tantivy is inspired by), so this makes it a meaningful comparison for a benchmark.<blockquote class="callout important"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM11 15H13V17H11V15ZM11 7H13V13H11V7Z" fill=currentColor></path></svg></div><div class=content><p><strong>Note</strong><p>This is a preliminary analysis designed to test the quality and throughput of FTS and vector search, so the results of the benchmarks are inspected on both these counts. It is expected that <strong>the numbers shown below for LanceDB will continually improve</strong> as new versions are released, and as each underlying system improves. As always, any benchmark should be performed on your own data and hardware to get a sense for your use case.</div></blockquote><h3 id=dataset>Dataset<a aria-label="Anchor link for: dataset" class=zola-anchor href=#dataset>#</a></h3><p>The dataset used is the same one I’ve used in prior blogs, i.e., a wine reviews dataset from Kaggle. It consists of 129,971 wine reviews from the Wine Enthusiast magazine, made available in newline-delimited JSON as shown below. Refer to the <a rel="nofollow noreferrer" href=https://www.kaggle.com/datasets/zynicide/wine-reviews>Kaggle source</a> for more detailed information on the dataset and how it was scraped.<p>An example JSON line containing a wine review and its metadata is shown below.<pre class=language-json data-lang=json style=background:#2e3440;color:#d8dee9><code class=language-json data-lang=json><span>{
</span><span>    </span><span style=color:#a3be8c>"id"</span><span style=color:#eceff4>: </span><span style=color:#b48ead>40825</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"points"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"90"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"title"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Castello San Donato in Perano 2009 Riserva  (Chianti Classico)"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"description"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Made from a blend of 85% Sangiovese and 15% Merlot, this ripe wine delivers soft plum, black currants, clove and cracked pepper sensations accented with coffee and espresso notes. A backbone of firm tannins give structure. Drink now through 2019."</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"taster_name"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Kerin O'Keefe"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"taster_twitter_handle"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"@kerinokeefe"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"price"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"30.0"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"designation"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Riserva"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"variety"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Red Blend"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"region_1"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"null"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"region_2"</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>null</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"province"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Tuscany"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"country"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Italy"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"winery"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Castello San Donato in Perano"
</span><span>}
</span></code></pre><h3 id=full-text-search-fts-queries>Full-text search (FTS) queries<a aria-label="Anchor link for: full-text-search-fts-queries" class=zola-anchor href=#full-text-search-fts-queries>#</a></h3><p>Tantivy supports the same syntax as the <a rel="nofollow noreferrer" href=https://lucene.apache.org/core/2_9_4/queryparsersyntax.html>Lucene query parser</a>, in which the <code>+</code> symbol represents the <code>AND</code> boolean operator. The following ten keyword-based queries are used to search the <code>description</code> field of the dataset. For example, the first query below searches for documents that contain both the words <em>apple</em> and <em>pear</em> in the <code>description</code> field.<pre class=language-txt data-lang=txt style=background:#2e3440;color:#d8dee9><code class=language-txt data-lang=txt><span>+apple +pear
</span><span>"tropical fruit"
</span><span>+citrus +almond
</span><span>+orange +grapefruit
</span><span>+full +bodied
</span><span>"citrus acidity"
</span><span>+blueberry +mint
</span><span>+beef +lamb
</span><span>+shellfish +seafood
</span><span>+vegetable +fish
</span></code></pre><h3 id=vector-search-queries>Vector search queries<a aria-label="Anchor link for: vector-search-queries" class=zola-anchor href=#vector-search-queries>#</a></h3><p>Ten vector search queries are defined as shown below. The first query below searches for documents whose <code>description</code> fields are similar to the vector representation of the words <em>vanilla</em> and <em>smoky</em>. The second query searches for descriptions similar to <em>dessert</em>, <em>sweetness</em> and <em>tartness</em> in vector space. You get the idea!<pre class=language-txt data-lang=txt style=background:#2e3440;color:#d8dee9><code class=language-txt data-lang=txt><span>vanilla and a hint of smokiness
</span><span>rich and sweet dessert wine with balanced tartness
</span><span>cherry and plum aromas
</span><span>right balance of citrus acidity
</span><span>grassy aroma with apple and tropical fruit
</span><span>bitter with a dry aftertaste
</span><span>sweet with a hint of chocolate and berry flavor
</span><span>acidic on the palate with oak aromas
</span><span>balanced tannins and dry and fruity composition
</span><span>peppery undertones that pairs with steak or barbecued meat
</span></code></pre><h3 id=serial-benchmark>Serial benchmark<a aria-label="Anchor link for: serial-benchmark" class=zola-anchor href=#serial-benchmark>#</a></h3><p>The serial benchmark involves sequentially running up to 10,000 randomly sampled queries in a Python <code>for</code> loop. This isn’t representative of a realistic use case in production, but is useful to understand the throughput potential when submitting a batch of queries sequentially.<p>We first randomly sample the FTS and vector search queries, with repetition, to generate a list of queries to run sequentially.<pre class=language-python data-lang=python style=background:#2e3440;color:#d8dee9><code class=language-python data-lang=python><span style=color:#81a1c1>import </span><span>random
</span><span>
</span><span style=color:#616e88># Generate a list of 10,000 randomly sampled queries from the existing list of queries
</span><span>random_choice_queries </span><span style=color:#81a1c1>= </span><span>[random</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>choice</span><span>(queries) </span><span style=color:#81a1c1>for _ in </span><span style=font-style:italic;color:#88c0d0>range</span><span>(</span><span style=color:#b48ead>10_000</span><span>)]
</span></code></pre><p>These are run in a <code>for</code> loop for the serial benchmark:<pre class=language-python data-lang=python style=background:#2e3440;color:#d8dee9><code class=language-python data-lang=python><span style=color:#616e88># args.search is either "fts" or "vector"
</span><span style=color:#616e88># Searches a LanceDB Table
</span><span style=color:#81a1c1>for </span><span>query </span><span style=color:#81a1c1>in </span><span>random_choice_queries:
</span><span>    </span><span style=color:#81a1c1>if </span><span>args</span><span style=color:#81a1c1>.</span><span>search </span><span style=color:#81a1c1>== </span><span style=color:#a3be8c>"fts"</span><span>:
</span><span>        </span><span style=color:#88c0d0>fts_search</span><span>(tbl</span><span style=color:#eceff4>, </span><span>query)
</span><span>    </span><span style=color:#81a1c1>else</span><span>:
</span><span>        </span><span style=color:#616e88># MODEL is an embedding model that converts the text query to a vector
</span><span>        </span><span style=color:#88c0d0>vector_search</span><span>(</span><span style=color:#81a1c1>MODEL</span><span style=color:#eceff4>, </span><span>tbl</span><span style=color:#eceff4>, </span><span>query)
</span></code></pre><p>The script <code>benchmark_serial.py</code> is run with the following command line arguments:<div class=codeblock-with-filename><div class=filename>bash</div><pre class=language-bash data-lang=bash style=background:#2e3440;color:#d8dee9><code class=language-bash data-lang=bash><span style=color:#88c0d0>python</span><span> benchmark_serial.py --search fts --limit 10
</span><span style=color:#88c0d0>python</span><span> benchmark_serial.py --search fts --limit 100
</span><span style=color:#88c0d0>python</span><span> benchmark_serial.py --search fts --limit 1000
</span><span style=color:#88c0d0>python</span><span> benchmark_serial.py --search fts --limit 10000
</span></code></pre></div><h3 id=concurrent-benchmark>Concurrent benchmark<a aria-label="Anchor link for: concurrent-benchmark" class=zola-anchor href=#concurrent-benchmark>#</a></h3><p>Concurrent requests are a much more realistic use case, for example, when an application sends multiple query requests to the database at the same time. The concurrency approach is different between LanceDB and Elasticsearch, due to the fact that LanceDB is embedded and runs in-process, whereas Elasticsearch has a client/server architecture and implements an asynchronous, non-blocking connection via a REST API.<p>In Elasticsearch, concurrent FTS and vector searches are performed by using its official async (non-blocking) Python client, as per <code>app.py</code> <a rel="nofollow noreferrer" href=https://github.com/prrao87/lancedb-study/blob/d4b89d85b13812a46b2b42cb4a0328a1aff3b952/elasticsearch/app.py>in the repo</a>.<p>To run queries concurrently LanceDB, a FastAPI app is built on top of the in-process database, and the <code>concurrent.futures.ThreadPoolExecutor</code> is used to allow the user to run multiple concurrent queries via the thread pool. See the code for the FastAPI app that’s built on top of LanceDB <a rel="nofollow noreferrer" href=https://github.com/prrao87/lancedb-study/blob/main/lancedb/app.py>here</a>.<blockquote class="callout warning"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M12.865 3.00017L22.3912 19.5002C22.6674 19.9785 22.5035 20.5901 22.0252 20.8662C21.8732 20.954 21.7008 21.0002 21.5252 21.0002H2.47266C1.92037 21.0002 1.47266 20.5525 1.47266 20.0002C1.47266 19.8246 1.51886 19.6522 1.60663 19.5002L11.1329 3.00017C11.4091 2.52187 12.0206 2.358 12.4989 2.63414C12.651 2.72191 12.7772 2.84815 12.865 3.00017ZM4.20471 19.0002H19.7932L11.9989 5.50017L4.20471 19.0002ZM10.9989 16.0002H12.9989V18.0002H10.9989V16.0002ZM10.9989 9.00017H12.9989V14.0002H10.9989V9.00017Z" fill=currentColor></path></svg></div><div class=content><p>The LanceDB FastAPI app’s thread pool is limited to 4 threads in this study. It’s recommended to experiment with increasing the number of threads up to 32 to find the optimal number for your use case.</div></blockquote><p>The FTS search takes in a FastAPI <code>Request</code> object and the search query, and returns a list of <code>SearchResult</code> objects, which are Pydantic models that contain specific fields that are validated prior to returning the response.<pre class=language-python data-lang=python style=background:#2e3440;color:#d8dee9><code class=language-python data-lang=python><span style=color:#81a1c1>def </span><span style=color:#88c0d0>_fts_search</span><span>(request</span><span style=color:#eceff4>: </span><span>Request</span><span style=color:#eceff4>, </span><span>terms</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str</span><span>) </span><span style=color:#eceff4>-> </span><span style=color:#81a1c1>list</span><span>[SearchResult] </span><span style=color:#81a1c1>| None</span><span>:
</span><span>    </span><span style=color:#616e88># In FTS, we limit to a max of 10K points to be more in line with Elasticsearch
</span><span>    search_result </span><span style=color:#81a1c1>= </span><span>(
</span><span>        request</span><span style=color:#81a1c1>.</span><span>app</span><span style=color:#81a1c1>.</span><span>table</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>search</span><span>(terms</span><span style=color:#eceff4>, </span><span>vector_column_name</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>"description"</span><span>)
</span><span>        </span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>select</span><span>([</span><span style=color:#a3be8c>"id"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"title"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"description"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"country"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"variety"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"price"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"points"</span><span>])
</span><span>        </span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>limit</span><span>(</span><span style=color:#b48ead>10</span><span>)
</span><span>    )</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_pydantic</span><span>(SearchResult)
</span><span>    </span><span style=color:#81a1c1>if not </span><span>search_result:
</span><span>        </span><span style=color:#81a1c1>return None
</span><span>    </span><span style=color:#81a1c1>return </span><span>search_result
</span></code></pre><p>The vector search is performed the same way, except that we first convert the query to a vector representation using the embedding model. The query then specifies the number of probes to divide the search space into, for the IVF-PQ index. Just like in the FTS case, the result is converted to a Pydantic model and returned as JSON via the REST endpoint.<pre class=language-python data-lang=python style=background:#2e3440;color:#d8dee9><code class=language-python data-lang=python><span style=color:#81a1c1>def </span><span style=color:#88c0d0>_vector_search</span><span>(
</span><span>    request</span><span style=color:#eceff4>: </span><span>Request</span><span style=color:#eceff4>,
</span><span>    terms</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str</span><span style=color:#eceff4>,
</span><span>) </span><span style=color:#eceff4>-> </span><span style=color:#81a1c1>list</span><span>[SearchResult] </span><span style=color:#81a1c1>| None</span><span>:
</span><span>    query_vector </span><span style=color:#81a1c1>= </span><span>request</span><span style=color:#81a1c1>.</span><span>app</span><span style=color:#81a1c1>.</span><span>model</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>encode</span><span>(terms</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>lower</span><span>())
</span><span>    search_result </span><span style=color:#81a1c1>= </span><span>(
</span><span>        request</span><span style=color:#81a1c1>.</span><span>app</span><span style=color:#81a1c1>.</span><span>table</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>search</span><span>(query_vector)
</span><span>        </span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>metric</span><span>(</span><span style=color:#a3be8c>"cosine"</span><span>)
</span><span>        </span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>nprobes</span><span>(</span><span style=color:#b48ead>20</span><span>)
</span><span>        </span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>select</span><span>([</span><span style=color:#a3be8c>"id"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"title"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"description"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"country"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"variety"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"price"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"points"</span><span>])
</span><span>        </span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>limit</span><span>(</span><span style=color:#b48ead>10</span><span>)
</span><span>    )</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_pydantic</span><span>(SearchResult)
</span><span>
</span><span>    </span><span style=color:#81a1c1>if not </span><span>search_result:
</span><span>        </span><span style=color:#81a1c1>return None
</span><span>    </span><span style=color:#81a1c1>return </span><span>search_result
</span></code></pre><p>The script <code>benchmark_concurrent.py</code> is run with the following command line arguments:<div class=codeblock-with-filename><div class=filename>bash</div><pre class=language-bash data-lang=bash style=background:#2e3440;color:#d8dee9><code class=language-bash data-lang=bash><span style=color:#88c0d0>python</span><span> benchmark_concurrent.py --search fts --limit 10
</span><span style=color:#88c0d0>python</span><span> benchmark_concurrent.py --search fts --limit 100
</span><span style=color:#88c0d0>python</span><span> benchmark_concurrent.py --search fts --limit 1000
</span><span style=color:#88c0d0>python</span><span> benchmark_concurrent.py --search fts --limit 10000
</span></code></pre></div><h2 id=results>Results<a aria-label="Anchor link for: results" class=zola-anchor href=#results>#</a></h2><p>The conditions for the benchmark are below:<ul><li>The timing numbers below are from a 2022 M2 Macbook Pro with 16GB RAM<li>The dimensionality of the embeddings is <strong>384</strong> (<code>BAAI/bge-small-en-v1.5</code>)<li>The distance metric for vector search is <strong>cosine similarity</strong> in either DB<li>Vector search in Elasticsearch is based on <strong>HNSW</strong>, and in LanceDB, is based on <strong>IVF-PQ</strong></ul><h3 id=qualitative-inspection>Qualitative inspection<a aria-label="Anchor link for: qualitative-inspection" class=zola-anchor href=#qualitative-inspection>#</a></h3><p>The first thing to check is whether each set of queries return sensible results. The results are inspected qualitatively, by checking that the top result (based on either FTS or vector similarity score) is similar to the query. This is done for both LanceDB and Elasticsearch via the script <code>query.py</code>. Switch between the tabs below to see the results for either solution.<div class=codeblock-with-filename><div class=filename>LanceDB</div><pre class=language-txt data-lang=txt style=background:#2e3440;color:#d8dee9><code class=language-txt data-lang=txt><span>Query [+apple +pear]: The pear, apple and apple skin aromas are light. The palate brings just off-dry pear flavors with a full feel.
</span><span>Query ["tropical fruit"]: Plump tropical fruit aromas show on the nose. A fruity but not complex palate deals short melon and tropical-fruit flavors prior to a briny finish.
</span><span>Query [+citrus +almond]: Inviting aromas of butter, almond and citrus open into a rich, thickly textured wine studded with peach, almond butter and citrus pith. The slightly bitter notes echo through the finish, providing a welcome sense of balance to round mouthfeel and fatty flavors.
</span><span>Query [+orange +grapefruit]: Made from Cabernet Sauvignon, this has funky, yeasty aromas of pink grapefruit and passion fruit that turn citrusy and briny if given time. On the palate, this recalls orange juice. Orange, grapefruit and generic tang proceed from the flavor profile to the finish.
</span><span>Query [+full +bodied]: Produced from organically grown grapes, this wine is full of fragrant, clean red-fruit flavors. It is ripe and full bodied—perhaps too full-bodied for a really fresh rosé. It does have all the fruit, generous and with a soft aftertaste.
</span><span>Query ["citrus acidity"]: This soft, ripe wine has good apricot and peach flavors alongside the crisper citrus acidity. It is spicy, fruity and ready to drink.
</span><span>Query [+blueberry +mint]: Exotic aromas of cardamom, blueberry and spiced currant filter onto a fresh but wide-bodied palate with raspberry, blueberry, herb and spice flavors. The finish is intriguing due to a reprise of notes like anise, mint and herbal berry flavors.
</span><span>Query [+beef +lamb]: Tarry, savory notes of dried beef, soy, charred lamb and underlying blackberry combine for a nose that screams umami. The palate carries a similar effect of grilled, lavender-covered lamb shank, black peppercorns and black sesame.
</span><span>Query [+shellfish +seafood]: Really? A five-buck Oregon Riesling? It's light, lemony and tart, but it's real wine, simple and plain, yet fine with shellfish or other light seafood.
</span><span>Query [+vegetable +fish]: Clean mineral notes blend nicely with fresh berry fruit, red rose and raspberry. This is a simple but genuine wine that would pair with roasted fish or vegetable risotto.
</span></code></pre></div><div class=codeblock-with-filename><div class=filename>Elasticsearch</div><pre class=language-txt data-lang=txt style=background:#2e3440;color:#d8dee9><code class=language-txt data-lang=txt><span>Query [+apple +pear]: The pear, apple and apple skin aromas are light. The palate brings just off-dry pear flavors with a full feel.
</span><span>Query ["tropical fruit"]: Plump tropical fruit aromas show on the nose. A fruity but not complex palate deals short melon and tropical-fruit flavors prior to a briny finish.
</span><span>Query [+citrus +almond]: Inviting aromas of butter, almond and citrus open into a rich, thickly textured wine studded with peach, almond butter and citrus pith. The slightly bitter notes echo through the finish, providing a welcome sense of balance to round mouthfeel and fatty flavors.
</span><span>Query [+orange +grapefruit]: Made from Cabernet Sauvignon, this has funky, yeasty aromas of pink grapefruit and passion fruit that turn citrusy and briny if given time. On the palate, this recalls orange juice. Orange, grapefruit and generic tang proceed from the flavor profile to the finish.
</span><span>Query [+full +bodied]: Produced from organically grown grapes, this wine is full of fragrant, clean red-fruit flavors. It is ripe and full bodied—perhaps too full-bodied for a really fresh rosé. It does have all the fruit, generous and with a soft aftertaste.
</span><span>Query ["citrus acidity"]: This soft, ripe wine has good apricot and peach flavors alongside the crisper citrus acidity. It is spicy, fruity and ready to drink.
</span><span>Query [+blueberry +mint]: Exotic aromas of cardamom, blueberry and spiced currant filter onto a fresh but wide-bodied palate with raspberry, blueberry, herb and spice flavors. The finish is intriguing due to a reprise of notes like anise, mint and herbal berry flavors.
</span><span>Query [+beef +lamb]: Tarry, savory notes of dried beef, soy, charred lamb and underlying blackberry combine for a nose that screams umami. The palate carries a similar effect of grilled, lavender-covered lamb shank, black peppercorns and black sesame.
</span><span>Query [+shellfish +seafood]: Really? A five-buck Oregon Riesling? It's light, lemony and tart, but it's real wine, simple and plain, yet fine with shellfish or other light seafood.
</span><span>Query [+vegetable +fish]: Clean mineral notes blend nicely with fresh berry fruit, red rose and raspberry. This is a simple but genuine wine that would pair with roasted fish or vegetable risotto.
</span></code></pre></div><p>As can be seen, the FTS results for LanceDB and Elasticsearch are identical to one another, which is heartening, considering that we had to do <strong>zero</strong> work to set up the search index via Tantivy. In Elasticsearch, we had to define the index settings via <a rel="nofollow noreferrer" href=https://github.com/prrao87/lancedb-study/blob/main/elasticsearch/mapping/mapping.json><code>mappings.json</code></a>, which adds a bit of a learning curve and boilerplate.<p>The vector search results are also inspected the same way. Switch between the tabs below to see the results for either solution.<div class=codeblock-with-filename><div class=filename>LanceDB</div><pre class=language-txt data-lang=txt style=background:#2e3440;color:#d8dee9><code class=language-txt data-lang=txt><span>Query [vanilla and a hint of smokiness]: Drenched in luxurious, almost sweet fruit flavors, this tempting and delicious wine is full bodied. Ripe in aromas and on the palate, it creates a vivid and warming cherry-pie effect on the senses, and is undeniably tasty.
</span><span>Query [rich and sweet dessert wine with balanced tartness]: Not a lot of wood scents are showing, though the aging took place in roughly 50% new oak barrels. This has forward, pretty black fruits, juicy acids, some still-unresolved astringency, and aromatically it incorporates a nice herbal note, reminiscent of green tea. Still too young to drink, and the rating could go higher with more bottle age.
</span><span>Query [cherry and plum aromas]: Part of the select group of impressive wines from this year, this wine is ripe, rich and firmly structured. Black-currant fruitiness forms the base for solid tannins and a concentrated texture. The hints of wood-aging need to soften. Drink from 2022.
</span><span>Query [right balance of citrus acidity]: This straightforward wine isn't particularly Cabernet-like, but it is good and sound. With furry tannins, it has a distinct sweetness of raisins and blackberry jam, as well as lots of brambly Zinny spices. Drink up.
</span><span>Query [grassy aroma with apple and tropical fruit]: This is the finest Cheval Blanc for many years. It is, quite simply, magnificent. The wine shows the greatness of Cabernet Franc in the vintage, with 57% of the variety in the blend. It is beautifully structured and perfumed, with velvety tannins, balanced acidity and swathes of black-currant and black-cherry fruits. It's well on course to becoming a legendary wine.
</span><span>Query [bitter with a dry aftertaste]: The wine is firm with tannins as well as black-currant fruit. It does have a juicy edge that will develop well as it matures. Drink this potentially attractive wine from 2018.
</span><span>Query [sweet with a hint of chocolate and berry flavor]: Exotic, complex and vivid aromas, rich and fulfilling fruit flavors and a hefty structure form a great package in this full-bodied and extroverted wine. The winemaker allowed wild yeast and kept 30% whole clusters in the fermentation, then aged it in neutral barrels.
</span><span>Query [acidic on the palate with oak aromas]: A lovely young Cab, rich and balanced, and with the elegance you expect from this producer. Made from all 5 Bordeaux varieties, with a drop of Syrah, the wine is potent in red and black currant, blackberry and new oak flavors, with sweetly ripe tannins. Delicious now, it should develop through 2015.
</span><span>Query [balanced tannins and dry and fruity composition]: A 100% varietal Pinot, this wine has a faint bouquet of ripe black cherry and blackberry, exuding full flavor and body. Smooth, the oak is low impact, providing extra weight and sustenance while remaining balanced with the fruit.
</span><span>Query [peppery undertones that pairs with steak or barbecued meat]: This arresting wine has aromas of forest floor, strawberry and cola. It's light and lithe in feel yet still richly flavored with a lingering finish.
</span></code></pre></div><div class=codeblock-with-filename><div class=filename>Elasticsearch</div><pre class=language-txt data-lang=txt style=background:#2e3440;color:#d8dee9><code class=language-txt data-lang=txt><span>Query [vanilla and a hint of smokiness]: Vanilla and maple aromas lead to overtly fruity red cherry flavors with a touch of sweetness and a soft texture. It's pleasant to drink for those looking for a soft touch, with very mild acidity and no tannin to speak of.
</span><span>Query [rich and sweet dessert wine with balanced tartness]: This richly extracted dessert wine boasts a dark, inky appearance and aromas of exotic spice, nutmeg, cinnamon, dark chocolate, carob, roasted chestnut and mature blackberries. It is smooth, well textured and exceedingly rich on the close with loads of power, personality and persistency.
</span><span>Query [cherry and plum aromas]: Earthy, herbal aromas of cherry and plum come with a funky note of wet dog fur. Hailing from a cool, wet vintage, this is showing shearing acidity and abrasiveness. Quick-hitting raspberry, plum and red-currant flavors end with edginess and snap. This is 40% each Cabernets Sauvignon and Franc, with 20% Monastrell.
</span><span>Query [right balance of citrus acidity]: True to its name, this blend is tangy in acidity. Flavorwise, it's simple, with pleasant orange, peach, lemon and vanilla flavors that finish a little sweet.
</span><span>Query [grassy aroma with apple and tropical fruit]: Spring flower aromas mingle with a hint of orchard fruit. On the lean, extremely simple palate, yellow apple fruit mixes with a lemon zest note.
</span><span>Query [bitter with a dry aftertaste]: Even at a considerable 15 g/l of residual sugar, this wine comes across as almost dry, thanks to its crisp acidity. Scents of petrichor, green apple and lime start things off, while those razor-sharp acids show up on the finish. Drink now.
</span><span>Query [sweet with a hint of chocolate and berry flavor]: A bouquet of cherry, white chocolate and juniper berry sets the stage for flavors of raspberry, blackberry, blueberry pie and baking spices. It is smooth in the mouth, with a sense of soft sweetness that is neither overpowering nor cloying, bolstered by a pervasive backbone of acidity.
</span><span>Query [acidic on the palate with oak aromas]: The oaky smoke is quite powerful on the nose, which also shows vanilla dust and lime juice. The palate is anything but austere, full of toast, caramelized apples and smoked fruits. A line of citrus acidity stops it from becoming flabby, but this is definitely for the oak lovers crowd.
</span><span>Query [balanced tannins and dry and fruity composition]: There is a good core of tannin here, the fruit sweet plums and ripe tannins, relatively soft and easy. Only that kernel of tannin offers some aging possibility.
</span><span>Query [peppery undertones that pairs with steak or barbecued meat]: An easy red blend, this would pair well with hamburgers or grilled meats. Notes of cherry and blackberry accent the palate.
</span></code></pre></div><p>Due to differences in the underlying vector index: IVF-PQ for LanceDB and HNSW for Elasticsearch, there are minor differences in the vector search results, which is expected. However, the results make qualitative sense and either solution can be further tuned (to improve recall) by adjusting the hyperparameters of the underlying vector index.<h3 id=throughput>Throughput<a aria-label="Anchor link for: throughput" class=zola-anchor href=#throughput>#</a></h3><p>Because the Lance format is optimized for disk-based I/O and random access, LanceDB is capable of handling a much higher throughput than Elasticsearch for vector search. The results of the serial and concurrent benchmarks are shown below.<figure><img alt="QPS for 10,000 randomly sampled FTS and vector search queries" loading=lazy src=lancedb-perf-results.png><figcaption>QPS for 10,000 randomly sampled FTS and vector search queries</figcaption></figure><p>The speedup factor over a single-node Elasticsearch deployment when using LanceDB is shown below.<ul><li>FTS (serial): <strong>1.2x</strong><li>FTS (concurrent): <strong>0.3x</strong><li>Vector search (serial): <strong>4.5x</strong><li>Vector search (concurrent): <strong>1.4x</strong></ul><p>For vector search, it is clear LanceDB is faster than Elasticsearch in both serial and concurrent scenarios. Elasticsearch uses Lucene’s HNSW implementation, which has known performance issues<sup class=footnote-reference><a href=#5>5</a></sup>. Additionally, the client/server nature of Elasticsearch can involve an incremental serialization/deserialization overhead as data passes through the network.<p>It is, of course, possible to improve the throughput of Elasticsearch with more compute resources, a larger cluster, and careful tuning of its HNSW index settings, but that’s just as true for the IVF-PQ settings in LanceDB. The difference is that LanceDB is likely to perform on par with or better than Elasticsearch, with far fewer resources on a single node.<blockquote class="callout warning"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M12.865 3.00017L22.3912 19.5002C22.6674 19.9785 22.5035 20.5901 22.0252 20.8662C21.8732 20.954 21.7008 21.0002 21.5252 21.0002H2.47266C1.92037 21.0002 1.47266 20.5525 1.47266 20.0002C1.47266 19.8246 1.51886 19.6522 1.60663 19.5002L11.1329 3.00017C11.4091 2.52187 12.0206 2.358 12.4989 2.63414C12.651 2.72191 12.7772 2.84815 12.865 3.00017ZM4.20471 19.0002H19.7932L11.9989 5.50017L4.20471 19.0002ZM10.9989 16.0002H12.9989V18.0002H10.9989V16.0002ZM10.9989 9.00017H12.9989V14.0002H10.9989V9.00017Z" fill=currentColor></path></svg></div><div class=content><p><strong>Note</strong><p>The surprising result in FTS is that LanceDB is only about 30% as fast as Elasticsearch in the concurrent FTS case, while being 1.2x faster in the serial case. The performance drop of LanceDB in the concurrent FTS case is likely due to the overhead of Python multi-threaded REST API calls, and not due to the underlying search engine, Tantivy, which is implemented in Rust. In addition, Elasticsearch implements an efficient non-blocking async client, which explains its good performance in either FTS case.</div></blockquote><p>As mentioned before, increasing the number of concurrent worker threads in the FastAPI application could improve FTS performance (up to a limit). Future LanceDB SDKs that support async requests could also prove to be more efficient at context-switching in such hybrid CPU-bound + IO-bound scenarios.<h2 id=composable-systems-improve-nonlinearly>Composable systems improve nonlinearly<a aria-label="Anchor link for: composable-systems-improve-nonlinearly" class=zola-anchor href=#composable-systems-improve-nonlinearly>#</a></h2><p>The biggest finding from from this study (other than the possible performance gains), is how composing multiple modular components in an effective manner can lead to a <em>nonlinear improvement</em> in the performance of the overall system. That is, improvements at the lower levels of the stack can result in an rapid, outsized improvement in the upper level at which the database sits.<p>As can be seen below, LanceDB is composed of the following key components of the Rust ecosystem (not counting foundation crates like <code>serde</code> for serialization/deserialization or <code>tokio</code> for async). The effects of each of these projects propagate up the stack to the Lance storage layer, and ultimately, the database itself.<figure><img alt="Composing multiple powerful Rust-based systems in LanceDB" loading=lazy src=lancedb-deconstructed.png><figcaption>Composing multiple powerful Rust-based systems in LanceDB</figcaption></figure><p>Because <code>arrow-rs</code> is a key foundational project that develops rapidly on its own via the thriving open source ecosystem it’s part of, it ultimately impacts other key projects downstream like Parquet, DataFusion and Lance. Tantivy, which is an independent open source project that specializes in its domain, will also improve with time as its use becomes more widespread in other search tools. The developers of LanceDB can thus focus on building out their core functionality, which is to provide a powerful vector DB with modern vector indexes and data versioning with scalability and performance in mind, while also leveraging the larger developments in the Arrow-enabled analytical tooling ecosystem.<h2 id=future-developments-in-the-lance-ecosystem>Future developments in the Lance ecosystem<a aria-label="Anchor link for: future-developments-in-the-lance-ecosystem" class=zola-anchor href=#future-developments-in-the-lance-ecosystem>#</a></h2><p>As described in this post, LanceDB is an exciting addition to the vector database landscape because of its refreshingly different internals, and its interesting approach to composability. As of writing this post, there are already numerous developments ongoing in both open source (OSS) LanceDB, as well as its commercial product, LanceDB Cloud. Its adoption will no doubt increase over time as more and more developers discover the ease of use and its lightweight nature. Of all the features on its roadmap, I’m particularly looking forward to the following:<ul><li>Async support for all its client APIs<li>Support for disk-based or hybrid vector indexes<li>Hybrid search features that combine the benefits of keyword-based and semantic search<li>Faster vectorization and data loading via async/multi-processing task pipelines<li>Support for upserts and easy updates/deletes for vectors whose representations change over time<li>Direct full-text search on object storage (e.g., S3) <a rel="nofollow noreferrer" href=https://blog.lancedb.com/s3-backed-full-text-search-with-tantivy-part-1-ac653017068b>via Tantivy</a></ul><p>I highly recommend giving out LanceDB a try on your own data, and to keep an eye on its development in the coming months. Give both <a rel="nofollow noreferrer" href=https://github.com/lancedb/lance>Lance</a> and <a rel="nofollow noreferrer" href=https://github.com/lancedb/lancedb>LanceDB</a> a ⭐️ on GitHub and show them some ❤️ on <a rel="nofollow noreferrer" href=https://discord.gg/zMM32dvNtd>Discord</a>.<p>Other posts in this series:<ul><li><a href=../embedded-db-1>Embedded databases (1): The harmony of DuckDB, Kùzu and LanceDB</a><li><a href=../embedded-db-2>Embedded databases (2): Kùzu, an extremely fast, embedded graph database</a></ul><h2 id=code>Code<a aria-label="Anchor link for: code" class=zola-anchor href=#code>#</a></h2><p>All the code required to reproduce the results from the benchmark is available <a rel="nofollow noreferrer" href=https://github.com/prrao87/lancedb-study>here</a>.<hr><div class=footnote-definition id=1><sup class=footnote-definition-label>1</sup><p>How Apache Arrow Is Changing the Big Data Ecosystem, <a rel="nofollow noreferrer" href=https://thenewstack.io/how-apache-arrow-is-changing-the-big-data-ecosystem/>thenewstack.io</a></div><div class=footnote-definition id=2><sup class=footnote-definition-label>2</sup><p>The Road to Composable Data Systems: Thoughts on the Last 15 Years and the Future, <a rel="nofollow noreferrer" href=https://wesmckinney.com/blog/looking-back-15-years/>wesmckinney.com</a></div><div class=footnote-definition id=3><sup class=footnote-definition-label>3</sup><p><em>Please pardon our appearance during renovations</em>, by Chang She, <a rel="nofollow noreferrer" href=https://blog.lancedb.com/please-pardon-our-appearance-during-renovations-da8c8f49b383>LanceDB blog</a></div><div class=footnote-definition id=4><sup class=footnote-definition-label>4</sup><p><em>Search benchmark, the game</em>, <a rel="nofollow noreferrer" href=https://tantivy-search.github.io/bench/>Tantivy blog</a></div><div class=footnote-definition id=5><sup class=footnote-definition-label>5</sup><p>Make HNSW merges faster, <a rel="nofollow noreferrer" href=https://github.com/apache/lucene/issues/12440>Lucene GitHub</a></div></article><div class=giscus></div><script async crossorigin data-category=General data-category-id=DIC_kwDOKyWhTs4CbUSt data-emit-metadata=0 data-input-position=bottom data-lang=en data-loading=lazy data-mapping=pathname data-reactions-enabled=1 data-repo=thedataquarry/thedataquarry.github.io data-repo-id=R_kgDOKyWhTg data-strict=0 data-theme=preferred_color_scheme src=https://giscus.app/client.js></script></div><footer><div class=copyright><p>© 2024 Prashanth Rao</div><div class=credits>Powered by <a rel="noreferrer noopener" href=https://www.getzola.org target=_blank>zola</a> and <a rel="noreferrer noopener" href=https://github.com/isunjn/serene target=_blank>serene</a></div></footer></main></div><script src=/js/lightense.min.js></script><script src=/js/main.js></script>