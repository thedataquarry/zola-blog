<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="light dark" name=color-scheme><title>Obtain a 5x speedup for free by upgrading to Pydantic v2 | The Data Quarry</title><meta content="Obtain a 5x speedup for free by upgrading to Pydantic v2" property=og:title><meta content="Prashanth Rao" name=author><meta content=en_US property=og:locale><meta content="Why Pydantic v2 being written in Rust matters, and how it's MUCH faster" name=description><meta content="Why Pydantic v2 being written in Rust matters, and how it's MUCH faster" property=og:description><link href=https://thedataquarry.github.io/posts/why-pydantic-v2-matters/ rel=canonical><meta content=https://thedataquarry.github.io/posts/why-pydantic-v2-matters/ property=og:url><meta content="The Data Quarry" property=og:site_name><meta content=https://thedataquarry.github.io/img/dataquarry-banner.png property=og:image><meta content=article property=og:type><meta content=2023-07-01T00:00:00+00:00 property=article:published_time><meta " content=summary_large_image name=twitter:card><meta content=https://thedataquarry.github.io/img/dataquarry-banner.png property=twitter:image><meta content="Obtain a 5x speedup for free by upgrading to Pydantic v2" property=twitter:title><meta content=@tech_optimist name=twitter:site><meta content="Why Pydantic v2 being written in Rust matters, and how it's MUCH faster" name=description><title>Obtain a 5x speedup for free by upgrading to Pydantic v2</title><link href=/img/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/img/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/img/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><style>body{--primary-color:#376dd9;--primary-pale-color:#698bcf1c;--inline-code-color:#444;--text-color:#444;--text-pale-color:#545967;--bg-color:#fff;--highlight-mark-color:#5f75b045;--callout-note-color:#3e70d6;--callout-important-color:#7a46cd;--callout-warning-color:#d3822b;--callout-alert-color:#d43f3f;--callout-question-color:#3089b5;--callout-tip-color:#35a06b;--main-font:"IBMPlexSans",ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--code-font:"IBMPlexMono",ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--homepage-max-width:750px;--main-max-width:750px;--avatar-size:175px;--paragraph-font-size:16px;--paragraph-line-height:1.5em;--aside-font-size:16px;--img-border-radius:4px;--inline-code-border-radius:2px}body.dark{--primary-color:#689afd;--primary-pale-color:#93acdd1c;--inline-code-color:#d2d2d2;--text-color:#ddd;--text-pale-color:#a0a0a0;--bg-color:#202124;--highlight-mark-color:#5f75b045;--callout-note-color:#698bcf;--callout-important-color:#9374c5;--callout-warning-color:#c99054;--callout-alert-color:#d35757;--callout-question-color:#5091b2;--callout-tip-color:#3ea06f}</style><link href=/main.css rel=stylesheet><script async data-website-id=01228822-c189-4b8a-93ba-733d045bf346 src=https://analytics.eu.umami.is/script.js></script><body class=post><script>if(localStorage.getItem('theme')=='dark'){document.body.classList.add('dark');const a=document.querySelector('link#hl');if(a)a.href='/hl-dark.css'}</script><header class=blur><div id=header-wrapper><nav><a href=/>The Data Quarry</a><button aria-label="toggle expand" class=separator id=toggler>::</button><span class="wrap left fold">{</span><a href=/posts>blog</a><span class="wrap-separator fold">,</span><a class=fold href=/talks>talks</a><span class="wrap-separator fold">,</span><a class=fold href=/projects>projects</a><span class="wrap right fold">} ;</span></nav><div id=btns><a rel="noreferrer noopener" aria-label=GitHub href=https://github.com/prrao87 target=_blank> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12" fill=currentColor></path></svg> </a><a rel="noreferrer noopener" aria-label=Twitter href=https://twitter.com/tech_optimist target=_blank> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>Twitter</title><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z" fill=currentColor></path></svg> </a><a rel="noreferrer noopener" aria-label=LinkedIn href=https://www.linkedin.com/in/prrao87 target=_blank> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z" fill=currentColor></path></svg> </a><a aria-label="Buy me a coffee" rel="noreferrer noopener" href=https://www.buymeacoffee.com/prrao87 target=_blank> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>Buy Me A Coffee</title><path d="M20.216 6.415l-.132-.666c-.119-.598-.388-1.163-1.001-1.379-.197-.069-.42-.098-.57-.241-.152-.143-.196-.366-.231-.572-.065-.378-.125-.756-.192-1.133-.057-.325-.102-.69-.25-.987-.195-.4-.597-.634-.996-.788a5.723 5.723 0 00-.626-.194c-1-.263-2.05-.36-3.077-.416a25.834 25.834 0 00-3.7.062c-.915.083-1.88.184-2.75.5-.318.116-.646.256-.888.501-.297.302-.393.77-.177 1.146.154.267.415.456.692.58.36.162.737.284 1.123.366 1.075.238 2.189.331 3.287.37 1.218.05 2.437.01 3.65-.118.299-.033.598-.073.896-.119.352-.054.578-.513.474-.834-.124-.383-.457-.531-.834-.473-.466.074-.96.108-1.382.146-1.177.08-2.358.082-3.536.006a22.228 22.228 0 01-1.157-.107c-.086-.01-.18-.025-.258-.036-.243-.036-.484-.08-.724-.13-.111-.027-.111-.185 0-.212h.005c.277-.06.557-.108.838-.147h.002c.131-.009.263-.032.394-.048a25.076 25.076 0 013.426-.12c.674.019 1.347.067 2.017.144l.228.031c.267.04.533.088.798.145.392.085.895.113 1.07.542.055.137.08.288.111.431l.319 1.484a.237.237 0 01-.199.284h-.003c-.037.006-.075.01-.112.015a36.704 36.704 0 01-4.743.295 37.059 37.059 0 01-4.699-.304c-.14-.017-.293-.042-.417-.06-.326-.048-.649-.108-.973-.161-.393-.065-.768-.032-1.123.161-.29.16-.527.404-.675.701-.154.316-.199.66-.267 1-.069.34-.176.707-.135 1.056.087.753.613 1.365 1.37 1.502a39.69 39.69 0 0011.343.376.483.483 0 01.535.53l-.071.697-1.018 9.907c-.041.41-.047.832-.125 1.237-.122.637-.553 1.028-1.182 1.171-.577.131-1.165.2-1.756.205-.656.004-1.31-.025-1.966-.022-.699.004-1.556-.06-2.095-.58-.475-.458-.54-1.174-.605-1.793l-.731-7.013-.322-3.094c-.037-.351-.286-.695-.678-.678-.336.015-.718.3-.678.679l.228 2.185.949 9.112c.147 1.344 1.174 2.068 2.446 2.272.742.12 1.503.144 2.257.156.966.016 1.942.053 2.892-.122 1.408-.258 2.465-1.198 2.616-2.657.34-3.332.683-6.663 1.024-9.995l.215-2.087a.484.484 0 01.39-.426c.402-.078.787-.212 1.074-.518.455-.488.546-1.124.385-1.766zm-1.478.772c-.145.137-.363.201-.578.233-2.416.359-4.866.54-7.308.46-1.748-.06-3.477-.254-5.207-.498-.17-.024-.353-.055-.47-.18-.22-.236-.111-.71-.054-.995.052-.26.152-.609.463-.646.484-.057 1.046.148 1.526.22.577.088 1.156.159 1.737.212 2.48.226 5.002.19 7.472-.14.45-.06.899-.13 1.345-.21.399-.072.84-.206 1.08.206.166.281.188.657.162.974a.544.544 0 01-.169.364zm-6.159 3.9c-.862.37-1.84.788-3.109.788a5.884 5.884 0 01-1.569-.217l.877 9.004c.065.78.717 1.38 1.5 1.38 0 0 1.243.065 1.658.065.447 0 1.786-.065 1.786-.065.783 0 1.434-.6 1.499-1.38l.94-9.95a3.996 3.996 0 00-1.322-.238c-.826 0-1.491.284-2.26.613z" fill=currentColor></path></svg> </a><button aria-label="theme switch" data-moon-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill="currentColor"></path></svg>' data-sun-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12C18 15.3137 15.3137 18 12 18ZM12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM11 1H13V4H11V1ZM11 20H13V23H11V20ZM3.51472 4.92893L4.92893 3.51472L7.05025 5.63604L5.63604 7.05025L3.51472 4.92893ZM16.9497 18.364L18.364 16.9497L20.4853 19.0711L19.0711 20.4853L16.9497 18.364ZM19.0711 3.51472L20.4853 4.92893L18.364 7.05025L16.9497 5.63604L19.0711 3.51472ZM5.63604 16.9497L7.05025 18.364L4.92893 20.4853L3.51472 19.0711L5.63604 16.9497ZM23 11V13H20V11H23ZM4 11V13H1V11H4Z" fill="currentColor"></path></svg>' id=theme-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill=currentColor></path></svg></button><button aria-label="table of content" id=toc-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M3 4H21V6H3V4ZM3 11H15V13H3V11ZM3 18H21V20H3V18Z" fill=currentColor></path></svg></button></div></div></header><div id=wrapper><div id=blank></div><aside class=blur><nav><ul><li><a class=h2 href=#why-it-matters-that-pydantic-v2-is-written-in-rust>Why it matters that Pydantic v2 is written in Rust</a> <ul><li><a class=h3 href=#what-is-pydantic-and-why-would-you-use-it>What is Pydantic and why would you use it?</a><li><a class=h3 href=#pydantic-v2-a-new-core-crab>Pydantic v2: A new core ü¶Ä</a><li><a class=h3 href=#case-study-on-pydantic-v1-vs-v2>Case study on Pydantic v1 vs v2</a><li><a class=h3 href=#schema>Schema</a><li><a class=h3 href=#root-validator-v1-and-model-validator-v2>root_validator (v1) and model_validator (v2)</a><li><a class=h3 href=#timing-comparison>Timing comparison</a><li><a class=h3 href=#results>Results</a><li><a class=h3 href=#conclusions-and-broader-implications>Conclusions and broader implications</a><li><a class=h3 href=#code-and-data>Code and data</a></ul></ul></nav><button aria-label="back to top" id=back-to-top><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M11.9997 10.8284L7.04996 15.7782L5.63574 14.364L11.9997 8L18.3637 14.364L16.9495 15.7782L11.9997 10.8284Z" fill=currentColor></path></svg></button></aside><main><div><div data-check-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z" fill="currentColor"></path></svg>' data-copy-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill="currentColor"></path></svg>' id=copy-cfg style=display:none></div><article data-backlink-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M9.41421 8L18.0208 16.6066L16.6066 18.0208L8 9.41421V17H6V6H17V8H9.41421Z" fill="currentColor"></path></svg>' class=prose><h1>Obtain a 5x speedup for free by upgrading to Pydantic v2</h1><div id=post-info><div id=date><span id=publish>2023-07-01</span><span>Updated: <span id=updated>2023-11-29</span></span></div><div id=tags><a href=https://thedataquarry.github.io/tags/pydantic><span>#</span>pydantic</a><a href=https://thedataquarry.github.io/tags/rust><span>#</span>rust</a></div></div><h1 id=why-it-matters-that-pydantic-v2-is-written-in-rust>Why it matters that Pydantic v2 is written in Rust<a aria-label="Anchor link for: why-it-matters-that-pydantic-v2-is-written-in-rust" class=zola-anchor href=#why-it-matters-that-pydantic-v2-is-written-in-rust>#</a></h1><p>If you‚Äôve worked with any form of data wrangling in Python, you‚Äôve likely heard of <a rel="nofollow noreferrer" href=https://docs.pydantic.dev/latest/>Pydantic</a>. If not, welcome! In this post, I‚Äôll show an example of why Pydantic is so integral to the workflows of data scientists and engineers, and how just a few small changes to your existing code written in v1 can be changed as per v2, to obtain a 5x speedup, largely due to Pydantic‚Äôs internals being rewritten in Rust.<h2 id=what-is-pydantic-and-why-would-you-use-it>What is Pydantic and why would you use it?<a aria-label="Anchor link for: what-is-pydantic-and-why-would-you-use-it" class=zola-anchor href=#what-is-pydantic-and-why-would-you-use-it>#</a></h2><p>Yes, compiled language enthusiasts, we hear you. <em>Unlike</em> compiled languages (C, C++, Rust), Python is an interpreted, dynamically typed language where variables can change types during run time. This means that when you write Python code, especially for large code bases involving ETL & data transformations, it becomes necessary to test for a <em>lot</em> of edge cases. A whole class of errors (<code>TypeError</code>) gets introduced into your Python runtime, where data obtained downstream may not align with expectations based on logic you or other developers put in, further upstream.<p>Python 3.5 introduced <a rel="nofollow noreferrer" href=https://peps.python.org/pep-0484/>type hints</a>, which allows developers to declare what type a variable should be, prior to runtime. However, type hints are only marginally effective because they <strong>don‚Äôt enforce</strong> data types at runtime ‚Äì they‚Äôre only a <em>guide</em>, and not a guarantee that the data you pass around remains a certain type. What‚Äôs the solution to this? Enter Pydantic üòé.<p>As per <a rel="nofollow noreferrer" href=https://docs.pydantic.dev/latest/#why-use-pydantic>their docs</a>, Pydantic is a data parsing, transformation and validation library for Python that leverages the underlying information in type hints and adds additional checks and constraints via a <em>schema</em>. Any untrusted data obtained is transformed and validated to conform to the known schema during runtime.<p>If the incoming data isn‚Äôt of the expected type or quality, Pydantic very loudly and explicitly throws an informative error, helping developers more easily trace down bugs or missing data prior to major deployments in production. Using Pydantic reduces the number of tests required, eliminating entire classes of bugs, streamlining the development process and ensuring that complex Python workflows run more reliably in production.<p>Pydantic is a <a rel="nofollow noreferrer" href=https://pypistats.org/packages/pydantic>highly used</a> library and is downloaded >100 million times a month ‚Äì it is used by 20 of the 25 largest companies on the NASDAQ, as well as all the biggest tech companies in the world. Clearly, ensuring type stability and cleaner, more trustworthy data upstream, offers a TON of value and can save tremendous amounts of wasted compute time in production! When you think of the sheer volume of data being handled at the largest companies on earth (most of them involving Python, due to its heavy use in data science and ML), it makes sense why Pydantic has become so important in the PyData ecosystem of today.<h2 id=pydantic-v2-a-new-core-crab>Pydantic v2: A new core ü¶Ä<a aria-label="Anchor link for: pydantic-v2-a-new-core-crab" class=zola-anchor href=#pydantic-v2-a-new-core-crab>#</a></h2><p>Normally, the release of a new major version of a library is just water under the bridge, and life goes on as normal. However, it‚Äôs because of where exactly Pydantic sits in the value chain ‚Äì at the foundation of a host of data wrangling and ETL workflows ‚Äì and the fact that its core functionality is now written in a systems-language like Rust, that makes v2 so important.<p>If you think about it, modern software engineering and machine learning workflows rely on large batches or streams of data coming in, and it‚Äôs a well-known fact that data quality can impact multiple outcomes of a software product<sup class=footnote-reference><a href=#2>1</a></sup>, all the way from customer engagement to insight generation and, ultimately, revenue.<h3 id=why-rust>Why Rust?<a aria-label="Anchor link for: why-rust" class=zola-anchor href=#why-rust>#</a></h3><p>I‚Äôve already written about this in <a href=../rust-is-supercharging-python/>my other blog post</a> on how Rust has been transforming the PyData ecosystem. Rust, being a close-to-bare-metal systems language, allows developers to build highly performant and memory-safe tooling for Python users with a lot more ease than they could in other languages. This is done via <a rel="nofollow noreferrer" href=https://github.com/PyO3/pyo3>PyO3</a>, a tool that allows developer to create Rust bindings for the Python interpreter, fully leveraging the underlying power and expressivity of Rust.<p>Since 2022, PyO3 has been having more and more of an impact on the PyData ecosystem, and the lead developer of Pydantic, Samuel Colvin, has spoken<sup class=footnote-reference><a href=#3>2</a></sup> about the importance of the interplay between Python üêç and Rust ü¶Ä, and the kind of impact this can have on the PyData ecosystem in general.<p>In 2023, David Hewitt, a core maintainer of PyO3, a library that‚Äôs empowering a whole new generation of Python developers to write faster, more efficient packages for Python in Rust, began working at Pydantic, which further solidifies the importance of Rust in the PyData ecosystem.</p><script async charset=utf-8 src=https://platform.twitter.com/widgets.js></script><div class=twitter><center> <blockquote class=twitter-tweet><a href=https://twitter.com/pydantic/status/1671233172867256320></a></blockquote> </center></div><h3 id=how-does-pydantic-v2-do-its-magic>How does Pydantic v2 do its magic?<a aria-label="Anchor link for: how-does-pydantic-v2-do-its-magic" class=zola-anchor href=#how-does-pydantic-v2-do-its-magic>#</a></h3><p>As of v2, Pydantic is now divided into two packages:<ul><li><code>pydantic-core</code>: Contains Rust bindings for the core validation and serialization logic, and doesn‚Äôt have a user-facing interface<li><code>pydantic</code>: A pure Python, higher level, user-facing package</ul><p>When you write your validation logic in Python via Pydantic v2, you‚Äôre simply defining ‚Äúinstructions‚Äù that are pushed down to the <code>pydantic-core</code> Rust layer. Samuel Colvin, creator of Pydantic, explains<sup class=footnote-reference><a href=#4>3</a></sup> how a large part of the performance gains are achieved:<ul><li>Compiled Rust bindings means all the validations are happening <em>outside</em> of Python<li>Recursive function calls are made in Rust, which have very little additional overhead<li>Using a tree of small validators that call each other, making code easier to read and extend without harming performance</ul><figure><img loading=lazy src=pydantic-core.png></figure><h2 id=case-study-on-pydantic-v1-vs-v2>Case study on Pydantic v1 vs v2<a aria-label="Anchor link for: case-study-on-pydantic-v1-vs-v2" class=zola-anchor href=#case-study-on-pydantic-v1-vs-v2>#</a></h2><p>Okay, enough of background, let‚Äôs see some code!<blockquote class="callout warning"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M12.865 3.00017L22.3912 19.5002C22.6674 19.9785 22.5035 20.5901 22.0252 20.8662C21.8732 20.954 21.7008 21.0002 21.5252 21.0002H2.47266C1.92037 21.0002 1.47266 20.5525 1.47266 20.0002C1.47266 19.8246 1.51886 19.6522 1.60663 19.5002L11.1329 3.00017C11.4091 2.52187 12.0206 2.358 12.4989 2.63414C12.651 2.72191 12.7772 2.84815 12.865 3.00017ZM4.20471 19.0002H19.7932L11.9989 5.50017L4.20471 19.0002ZM10.9989 16.0002H12.9989V18.0002H10.9989V16.0002ZM10.9989 9.00017H12.9989V14.0002H10.9989V9.00017Z" fill=currentColor></path></svg></div><div class=content><p><strong>Information</strong><p>The aim of this section is to demonstrate how Pydantic v2, thanks to its core being written in Rust ü¶Ä, is at least <strong>5x faster</strong> than v1 ü§Ø. The performance gains come for <em>free</em>, just by upgrading to the newest version and changing a few lines of code üöÄ.</div></blockquote><h3 id=the-data>The data<a aria-label="Anchor link for: the-data" class=zola-anchor href=#the-data>#</a></h3><p>The example dataset we‚Äôll be working with is the <a rel="nofollow noreferrer" href=https://www.kaggle.com/datasets/zynicide/wine-reviews>wine reviews dataset</a> from Kaggle. It consists of 130k wine reviews from the Wine Enthusiast magazine, including the variety, location, winery, price, description, and some other metadata for each wine. Refer to the Kaggle source for more detailed information on the data and how it was scraped. The original data was downloaded as a single JSON file. For the purposes of this blog post, the data was then converted to newline-delimited JSON (.jsonl) format where each line of the file contains a valid JSON object.<p>An example JSON line is shown below.<pre class=language-json data-lang=json style=background:#2e3440;color:#d8dee9><code class=language-json data-lang=json><span>{
</span><span>    </span><span style=color:#a3be8c>"id"</span><span style=color:#eceff4>: </span><span style=color:#b48ead>40825</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"points"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"90"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"title"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Castello San Donato in Perano 2009 Riserva  (Chianti Classico)"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"description"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Made from a blend of 85% Sangiovese and 15% Merlot, this ripe wine delivers soft plum, black currants, clove and cracked pepper sensations accented with coffee and espresso notes. A backbone of firm tannins give structure. Drink now through 2019."</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"taster_name"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Kerin O'Keefe"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"taster_twitter_handle"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"@kerinokeefe"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"price"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"30.0"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"designation"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Riserva"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"variety"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Red Blend"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"region_1"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"null"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"region_2"</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>null</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"province"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Tuscany"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"country"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Italy"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"winery"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Castello San Donato in Perano"
</span><span>}
</span></code></pre><h3 id=the-benchmark>The benchmark<a aria-label="Anchor link for: the-benchmark" class=zola-anchor href=#the-benchmark>#</a></h3><p>This benchmark consists of the following data validation tasks:<ul><li>Ensure the <code>id</code> field always exists (this will be the primary key), and is an integer<li>Ensure the <code>points</code> field is an integer<li>Ensure the <code>price</code> field is a float<li>Ensure the <code>country</code> field always has a non-null value ‚Äì if it‚Äôs set as <code>null</code> or the <code>country</code> key doesn‚Äôt exist in the raw data, it <em>must</em> be set to <code>Unknown</code>. This is because the use case we defined will involve querying on <code>country</code> downstream<li>Remove fields like <code>designation</code>, <code>province</code>, <code>region_1</code> and <code>region_2</code> if they have the value <code>null</code> in the raw data ‚Äì these fields will not be queried on and we do not want to unnecessarily store null values downstream</ul><blockquote class="callout note"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM11 7H13V9H11V7ZM11 11H13V17H11V11Z" fill=currentColor></path></svg></div><div class=content><p><strong>Note</strong><p>All tasks described in this post are run on a 2022 M2 Macbook Pro. To get a clearer estimate on performance differences, we will wrap the validation checks in a loop and run them repetitively, <strong>over 10 cycles</strong>. The run times for each cycle are reported, along with the total run time for both versions.</div></blockquote><h4 id=note-on-timing>Note on timing<a aria-label="Anchor link for: note-on-timing" class=zola-anchor href=#note-on-timing>#</a></h4><p>Using a convenience library like <a rel="nofollow noreferrer" href=https://github.com/realpython/codetiming>codetiming</a> makes it easier to wrap the portions of the code we want to time without having to add/remove <code>time.time()</code> commands over and over.<h2 id=schema>Schema<a aria-label="Anchor link for: schema" class=zola-anchor href=#schema>#</a></h2><p>The schema file is at the root of the validation logic in Pydantic. The general practice is to use <a rel="nofollow noreferrer" href=https://docs.pydantic.dev/latest/usage/validators/>validators</a>, which are a kind of class method in Pydantic to transform or validate data and ensure it‚Äôs of the right type and format for downstream tasks. Using validators is <strong>far cleaner</strong> than writing custom functions that manipulate data (they would be riddled with ugly <code>if-else</code> statements or <code>isinstance</code> clauses, not to mention that they‚Äôd need added tests). The schema below implements the validation logic defined above.<div class=codeblock-with-filename><div class=filename>Pydantic v1</div><pre class=language-python data-lang=python data-linenos style=background:#2e3440;color:#d8dee9><code class=language-python data-lang=python><table><tbody><tr><td>1<td><span style=color:#81a1c1>from </span><span>pydantic </span><span style=color:#81a1c1>import </span><span>BaseModel</span><span style=color:#eceff4>, </span><span>root_validator
</span><tr><td>2<td><span>
</span><tr><td>3<td><span style=color:#81a1c1>class </span><span style=color:#8fbcbb>Wine</span><span>(</span><span style=color:#8fbcbb>BaseModel</span><span>):
</span><tr><td>4<td><span>    </span><span style=font-style:italic;color:#88c0d0>id</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>int
</span><tr><td>5<td><span>    points</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>int
</span><tr><td>6<td><span>    title</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str
</span><tr><td>7<td><span>    description</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><tr><td>8<td><span>    price</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>float | None
</span><tr><td>9<td><span>    variety</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><tr><td>10<td><span>    winery</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><tr><td>11<td><span>    designation</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><tr><td>12<td><span>    country</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><tr><td>13<td><span>    province</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><tr><td>14<td><span>    region_1</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><tr><td>15<td><span>    region_2</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><tr><td>16<td><span>    taster_name</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><tr><td>17<td><span>    taster_twitter_handle</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><tr><td>18<td><span>
</span><tr><td><mark style=background:#434c5e52>19</mark><td><mark style=background:#434c5e52><span>    </span><span style=color:#d08770>@</span><span>root_validator
</span></mark><tr><td>20<td><span>    </span><span style=color:#81a1c1>def </span><span style=color:#88c0d0>_remove_unknowns</span><span>(cls</span><span style=color:#eceff4>, </span><span>values):
</span><tr><td>21<td><span>        </span><span style=color:#a3be8c>"Set other fields that have the value 'null' as None so that we can throw it away"
</span><tr><td>22<td><span>        fields </span><span style=color:#81a1c1>= </span><span>[</span><span style=color:#a3be8c>"designation"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"province"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"region_1"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"region_2"</span><span>]
</span><tr><td>23<td><span>        </span><span style=color:#81a1c1>for </span><span>field </span><span style=color:#81a1c1>in </span><span>fields:
</span><tr><td>24<td><span>            </span><span style=color:#81a1c1>if not </span><span>values</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span>(field) </span><span style=color:#81a1c1>or </span><span>values</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span>(field) </span><span style=color:#81a1c1>== </span><span style=color:#a3be8c>"null"</span><span>:
</span><tr><td>25<td><span>                values[field] </span><span style=color:#81a1c1>= None
</span><tr><td>26<td><span>        </span><span style=color:#81a1c1>return </span><span>values
</span><tr><td>27<td><span>
</span><tr><td><mark style=background:#434c5e52>28</mark><td><mark style=background:#434c5e52><span>    </span><span style=color:#d08770>@</span><span>root_validator
</span></mark><tr><td>29<td><span>    </span><span style=color:#81a1c1>def </span><span style=color:#88c0d0>_fill_country_unknowns</span><span>(cls</span><span style=color:#eceff4>, </span><span>values):
</span><tr><td>30<td><span>        </span><span style=color:#a3be8c>"Fill in missing country values with 'Unknown', as we always want this field to be queryable"
</span><tr><td>31<td><span>        country </span><span style=color:#81a1c1>= </span><span>values</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span>(</span><span style=color:#a3be8c>"country"</span><span>)
</span><tr><td>32<td><span>        </span><span style=color:#81a1c1>if not </span><span>country </span><span style=color:#81a1c1>or </span><span>country </span><span style=color:#81a1c1>== </span><span style=color:#a3be8c>"null"</span><span>:
</span><tr><td>33<td><span>            values[</span><span style=color:#a3be8c>"country"</span><span>] </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>"Unknown"
</span><tr><td>34<td><span>        </span><span style=color:#81a1c1>return </span><span>values
</span><tr><td>35<td><span>
</span><tr><td><mark style=background:#434c5e52>36</mark><td><mark style=background:#434c5e52><span>    </span><span style=color:#d08770>@</span><span>root_validator
</span></mark><tr><td>37<td><span>    </span><span style=color:#81a1c1>def </span><span style=color:#88c0d0>_get_vineyard</span><span>(cls</span><span style=color:#eceff4>, </span><span>values):
</span><tr><td>38<td><span>        </span><span style=color:#a3be8c>"Rename designation to vineyard"
</span><tr><td>39<td><span>        vineyard </span><span style=color:#81a1c1>= </span><span>values</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>pop</span><span>(</span><span style=color:#a3be8c>"designation"</span><span style=color:#eceff4>, </span><span style=color:#81a1c1>None</span><span>)
</span><tr><td>40<td><span>        </span><span style=color:#81a1c1>if </span><span>vineyard:
</span><tr><td>41<td><span>            values[</span><span style=color:#a3be8c>"vineyard"</span><span>] </span><span style=color:#81a1c1>= </span><span>vineyard</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>strip</span><span>()
</span><tr><td>42<td><span>        </span><span style=color:#81a1c1>return </span><span>values
</span></table></code></pre></div><p>The following code in Pydantic v2 performs the same actions as the v1 version. Note the changed lines highlighted in the code below.<div class=codeblock-with-filename><div class=filename>Pydantic v2</div><pre class=language-python data-lang=python data-linenos style=background:#2e3440;color:#d8dee9><code class=language-python data-lang=python><table><tbody><tr><td>1<td><span style=color:#81a1c1>from </span><span>pydantic </span><span style=color:#81a1c1>import </span><span>BaseModel</span><span style=color:#eceff4>, </span><span>model_validator
</span><tr><td>2<td><span>
</span><tr><td>3<td><span style=color:#81a1c1>class </span><span style=color:#8fbcbb>Wine</span><span>(</span><span style=color:#8fbcbb>BaseModel</span><span>):
</span><tr><td>4<td><span>    </span><span style=font-style:italic;color:#88c0d0>id</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>int
</span><tr><td>5<td><span>    points</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>int
</span><tr><td>6<td><span>    title</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str
</span><tr><td>7<td><span>    description</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><tr><td>8<td><span>    price</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>float | None
</span><tr><td>9<td><span>    variety</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><tr><td>10<td><span>    winery</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><tr><td>11<td><span>    designation</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><tr><td>12<td><span>    country</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><tr><td>13<td><span>    province</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><tr><td>14<td><span>    region_1</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><tr><td>15<td><span>    region_2</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><tr><td>16<td><span>    taster_name</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><tr><td>17<td><span>    taster_twitter_handle</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><tr><td>18<td><span>
</span><tr><td><mark style=background:#434c5e52>19</mark><td><mark style=background:#434c5e52><span>    </span><span style=color:#d08770>@</span><span>model_validator(mode</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>"before"</span><span>)
</span></mark><tr><td>20<td><span>    </span><span style=color:#81a1c1>def </span><span style=color:#88c0d0>_remove_unknowns</span><span>(cls</span><span style=color:#eceff4>, </span><span>values):
</span><tr><td>21<td><span>        </span><span style=color:#a3be8c>"Set other fields that have the value 'null' as None so that we can throw it away"
</span><tr><td>22<td><span>        fields </span><span style=color:#81a1c1>= </span><span>[</span><span style=color:#a3be8c>"designation"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"province"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"region_1"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"region_2"</span><span>]
</span><tr><td>23<td><span>        </span><span style=color:#81a1c1>for </span><span>field </span><span style=color:#81a1c1>in </span><span>fields:
</span><tr><td>24<td><span>            </span><span style=color:#81a1c1>if not </span><span>values</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span>(field) </span><span style=color:#81a1c1>or </span><span>values</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span>(field) </span><span style=color:#81a1c1>== </span><span style=color:#a3be8c>"null"</span><span>:
</span><tr><td>25<td><span>                values[field] </span><span style=color:#81a1c1>= None
</span><tr><td>26<td><span>        </span><span style=color:#81a1c1>return </span><span>values
</span><tr><td>27<td><span>
</span><tr><td><mark style=background:#434c5e52>28</mark><td><mark style=background:#434c5e52><span>    </span><span style=color:#d08770>@</span><span>model_validator(mode</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>"before"</span><span>)
</span></mark><tr><td>29<td><span>    </span><span style=color:#81a1c1>def </span><span style=color:#88c0d0>_fill_country_unknowns</span><span>(cls</span><span style=color:#eceff4>, </span><span>values):
</span><tr><td>30<td><span>        </span><span style=color:#a3be8c>"Fill in missing country values with 'Unknown', as we always want this field to be queryable"
</span><tr><td>31<td><span>        country </span><span style=color:#81a1c1>= </span><span>values</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span>(</span><span style=color:#a3be8c>"country"</span><span>)
</span><tr><td>32<td><span>        </span><span style=color:#81a1c1>if not </span><span>country </span><span style=color:#81a1c1>or </span><span>country </span><span style=color:#81a1c1>== </span><span style=color:#a3be8c>"null"</span><span>:
</span><tr><td>33<td><span>            values[</span><span style=color:#a3be8c>"country"</span><span>] </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>"Unknown"
</span><tr><td>34<td><span>        </span><span style=color:#81a1c1>return </span><span>values
</span><tr><td>35<td><span>
</span><tr><td><mark style=background:#434c5e52>36</mark><td><mark style=background:#434c5e52><span>    </span><span style=color:#d08770>@</span><span>model_validator(mode</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>"before"</span><span>)
</span></mark><tr><td>37<td><span>    </span><span style=color:#81a1c1>def </span><span style=color:#88c0d0>_get_vineyard</span><span>(cls</span><span style=color:#eceff4>, </span><span>values):
</span><tr><td>38<td><span>        </span><span style=color:#a3be8c>"Rename designation to vineyard"
</span><tr><td>39<td><span>        vineyard </span><span style=color:#81a1c1>= </span><span>values</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>pop</span><span>(</span><span style=color:#a3be8c>"designation"</span><span style=color:#eceff4>, </span><span style=color:#81a1c1>None</span><span>)
</span><tr><td>40<td><span>        </span><span style=color:#81a1c1>if </span><span>vineyard:
</span><tr><td>41<td><span>            values[</span><span style=color:#a3be8c>"vineyard"</span><span>] </span><span style=color:#81a1c1>= </span><span>vineyard</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>strip</span><span>()
</span><tr><td>42<td><span>        </span><span style=color:#81a1c1>return </span><span>values
</span></table></code></pre></div><h2 id=root-validator-v1-and-model-validator-v2><code>root_validator</code> (v1) and <code>model_validator</code> (v2)<a aria-label="Anchor link for: root-validator-v1-and-model-validator-v2" class=zola-anchor href=#root-validator-v1-and-model-validator-v2>#</a></h2><ul><li>In Pydantic v2, <code>root_validator</code> is deprecated, and we instead use <code>model_validator</code> <ul><li>In a similar way, <code>validator</code> is deprecated and we instead use <code>field_validator</code> where we may need to validate specific fields (not used in this example)</ul><li>The keyword arguments to the <code>model_validator</code> differ from v1‚Äôs <code>root_validator</code> (and in my view, are more intuitive and readable) <ul><li><code>mode="before"</code> in v2 means that we are performing data transformations on the fields that already exist in the raw data, prior to validation</ul></ul><p>That‚Äôs it! With just these minor changes (<strong>everything else is kept the same</strong>) in the schema definition, we are now ready to test their performance!<h2 id=timing-comparison>Timing comparison<a aria-label="Anchor link for: timing-comparison" class=zola-anchor href=#timing-comparison>#</a></h2><p>Set up two separate Python virtual environments, one with Pydantic v2 installed, and another one with v1 installed. Each portion of the code base is explained in the following sections.<h3 id=read-in-data-as-a-list-of-dicts>Read in data as a list of dicts<a aria-label="Anchor link for: read-in-data-as-a-list-of-dicts" class=zola-anchor href=#read-in-data-as-a-list-of-dicts>#</a></h3><p>The raw data is stored in line-delimited JSON (gzipped) format, so it is first read in as a list of dicts. The lightweight serialization library <code>srsly</code> is used for this task: <code>pip install srsly</code><pre class=language-python data-lang=python style=background:#2e3440;color:#d8dee9><code class=language-python data-lang=python><span style=color:#81a1c1>from </span><span>pathlib </span><span style=color:#81a1c1>import </span><span>Path
</span><span style=color:#81a1c1>from </span><span>typing </span><span style=color:#81a1c1>import </span><span>Any
</span><span>
</span><span style=color:#81a1c1>import </span><span>srsly
</span><span>
</span><span style=color:#81a1c1>def </span><span style=color:#88c0d0>get_json_data</span><span>(data_dir</span><span style=color:#eceff4>: </span><span>Path</span><span style=color:#eceff4>, </span><span>filename</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str</span><span>) </span><span style=color:#eceff4>-> </span><span style=color:#81a1c1>list</span><span>[JsonBlob]:
</span><span>    </span><span style=color:#616e88>"""Get all line-delimited files from a directory with a given prefix"""
</span><span>    file_path </span><span style=color:#81a1c1>= </span><span>data_dir </span><span style=color:#81a1c1>/ </span><span>filename
</span><span>    data </span><span style=color:#81a1c1>= </span><span>srsly</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>read_gzip_jsonl</span><span>(file_path)
</span><span>    </span><span style=color:#81a1c1>return </span><span>data
</span><span>
</span><span>
</span><span style=color:#81a1c1>if </span><span>__name__ </span><span style=color:#81a1c1>== </span><span style=color:#a3be8c>"__main__"</span><span>:
</span><span>    </span><span style=color:#81a1c1>DATA_DIR = </span><span style=color:#88c0d0>Path</span><span>(</span><span style=color:#a3be8c>"../data"</span><span>)
</span><span>    </span><span style=color:#81a1c1>FILENAME = </span><span style=color:#a3be8c>"winemag-data-130k-v2.jsonl.gz"
</span><span>    data </span><span style=color:#81a1c1>= list</span><span>(</span><span style=color:#88c0d0>get_json_data</span><span>(</span><span style=color:#81a1c1>DATA_DIR</span><span style=color:#eceff4>, </span><span style=color:#81a1c1>FILENAME</span><span>))
</span><span>    </span><span style=color:#616e88># data is now a list of dicts
</span></code></pre><h3 id=define-validation-function>Define validation function<a aria-label="Anchor link for: define-validation-function" class=zola-anchor href=#define-validation-function>#</a></h3><ul><li>Define a function that imports the <code>Wine</code> schema defined above (separately for v1 and v2 of Pydantic).<li>The list of dicts that contain the raw data are unwrapped in the <code>Wine</code> validator class, which performs validation and type coercion<li>Note the change in syntax for dumping the validated data as a dict (in v1, the <code>dict()</code> method was used, but in v2, it‚Äôs renamed to <code>model_dump</code>). <ul><li>The <code>exclude_none=True</code> keyword argument to <code>model_dump</code> removes fields that have the value <code>None</code> ‚Äì this saves space and avoids us storing <code>None</code> values downstream</ul></ul><div class=codeblock-with-filename><div class=filename>Pydantic v1</div><pre class=language-python data-lang=python data-linenos style=background:#2e3440;color:#d8dee9><code class=language-python data-lang=python><table><tbody><tr><td>1<td><span style=color:#81a1c1>from </span><span>schemas </span><span style=color:#81a1c1>import </span><span>Wine
</span><tr><td>2<td><span>
</span><tr><td>3<td><span style=color:#81a1c1>def </span><span style=color:#88c0d0>validate</span><span>(data</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>list</span><span>[JsonBlob]) </span><span style=color:#eceff4>-> </span><span style=color:#81a1c1>list</span><span>[JsonBlob]:
</span><tr><td><mark style=background:#434c5e52>4</mark><td><mark style=background:#434c5e52><span>    validated_data </span><span style=color:#81a1c1>= </span><span>[</span><span style=color:#88c0d0>Wine</span><span>(</span><span style=color:#81a1c1>**</span><span>item)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>dict</span><span>(exclude_none</span><span style=color:#81a1c1>=True</span><span>) </span><span style=color:#81a1c1>for </span><span>item </span><span style=color:#81a1c1>in </span><span>data]
</span></mark><tr><td>5<td><span>    </span><span style=color:#81a1c1>return </span><span>validated_data
</span></table></code></pre></div><p>Note how the code is almost identical for v2, except for the change from <code>dict()</code> to <code>model_dump()</code>.<div class=codeblock-with-filename><div class=filename>Pydantic v2</div><pre class=language-python data-lang=python data-linenos style=background:#2e3440;color:#d8dee9><code class=language-python data-lang=python><table><tbody><tr><td>1<td><span style=color:#81a1c1>from </span><span>schemas </span><span style=color:#81a1c1>import </span><span>Wine
</span><tr><td>2<td><span>
</span><tr><td>3<td><span style=color:#81a1c1>def </span><span style=color:#88c0d0>validate</span><span>(data</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>list</span><span>[JsonBlob]) </span><span style=color:#eceff4>-> </span><span style=color:#81a1c1>list</span><span>[JsonBlob]:
</span><tr><td><mark style=background:#434c5e52>4</mark><td><mark style=background:#434c5e52><span>    validated_data </span><span style=color:#81a1c1>= </span><span>[</span><span style=color:#88c0d0>Wine</span><span>(</span><span style=color:#81a1c1>**</span><span>item)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>model_dump</span><span>(exclude_none</span><span style=color:#81a1c1>=True</span><span>) </span><span style=color:#81a1c1>for </span><span>item </span><span style=color:#81a1c1>in </span><span>data]
</span></mark><tr><td>5<td><span>    </span><span style=color:#81a1c1>return </span><span>validated_data
</span></table></code></pre></div><h3 id=define-a-run-function-that-wraps-a-timer>Define a run function that wraps a timer<a aria-label="Anchor link for: define-a-run-function-that-wraps-a-timer" class=zola-anchor href=#define-a-run-function-that-wraps-a-timer>#</a></h3><p>To time each validation cycle, we wrap the <code>run</code> function inside a <code>Timer</code> context manager as follows. Note that this requires that the <code>codetiming</code> library is installed: <code>pip install codetiming</code>.<pre class=language-python data-lang=python data-linenos style=background:#2e3440;color:#d8dee9><code class=language-python data-lang=python><table><tbody><tr><td>1<td><span style=color:#81a1c1>from </span><span>codetiming </span><span style=color:#81a1c1>import </span><span>Timer
</span><tr><td>2<td><span>
</span><tr><td>3<td><span style=color:#81a1c1>def </span><span style=color:#88c0d0>run</span><span>():
</span><tr><td>4<td><span>    </span><span style=color:#616e88>"""Wrapper function to time the validator over many runs"""
</span><tr><td>5<td><span>    </span><span style=color:#81a1c1>with </span><span style=color:#88c0d0>Timer</span><span>(name</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>"Single case"</span><span style=color:#eceff4>, </span><span>text</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>"</span><span style=color:#ebcb8b>{name}</span><span style=color:#a3be8c>: </span><span style=color:#ebcb8b>{seconds</span><span>:.3f</span><span style=color:#ebcb8b>}</span><span style=color:#a3be8c> sec"</span><span>):
</span><tr><td>6<td><span>        validated_data </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>validate</span><span>(data)
</span><tr><td>7<td><span>        </span><span style=font-style:italic;color:#88c0d0>print</span><span>(</span><span style=color:#81a1c1>f</span><span style=color:#a3be8c>"Validated </span><span>{</span><span style=font-style:italic;color:#88c0d0>len</span><span>(validated_data)}</span><span style=color:#a3be8c> records in cycle </span><span>{i </span><span style=color:#81a1c1>+ </span><span style=color:#b48ead>1</span><span>}</span><span style=color:#a3be8c> of </span><span>{num}</span><span style=color:#a3be8c>"</span><span>)
</span></table></code></pre><h3 id=run-in-a-loop>Run in a loop<a aria-label="Anchor link for: run-in-a-loop" class=zola-anchor href=#run-in-a-loop>#</a></h3><p>We can then call the <code>run()</code> method in a loop to perform validation 10 times, to see the average run time. To measure the total run time for all 10 cycles, wrap the loop itself inside another <code>Timer</code> block as follows:<pre class=language-python data-lang=python style=background:#2e3440;color:#d8dee9><code class=language-python data-lang=python><span>num </span><span style=color:#81a1c1>= </span><span style=color:#b48ead>10
</span><span style=color:#81a1c1>with </span><span style=color:#88c0d0>Timer</span><span>(name</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>"All cases"</span><span style=color:#eceff4>, </span><span>text</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>"</span><span style=color:#ebcb8b>{name}</span><span style=color:#a3be8c>: </span><span style=color:#ebcb8b>{seconds</span><span>:.3f</span><span style=color:#ebcb8b>}</span><span style=color:#a3be8c> sec"</span><span>):
</span><span>    </span><span style=color:#81a1c1>for </span><span>i </span><span style=color:#81a1c1>in </span><span style=font-style:italic;color:#88c0d0>range</span><span>(num):
</span><span>        </span><span style=color:#88c0d0>run</span><span>()
</span></code></pre><h2 id=results>Results<a aria-label="Anchor link for: results" class=zola-anchor href=#results>#</a></h2><blockquote class="callout note"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM11 7H13V9H11V7ZM11 11H13V17H11V11Z" fill=currentColor></path></svg></div><div class=content><p>For a total of 10 cycles (where each cycle validates the same ~130k records), Pydantic v2 performs ~1.3 million validations in roughly 6 seconds, while the exact same workflow in v1 took almost 30 seconds: that‚Äôs a <strong>5x improvement</strong>, for free!</div></blockquote><table><thead><tr><th>Run<th>Pydantic v1<th>Pydantic v2<tbody><tr><td>Cycle 1<td>2.952 sec<td>0.584 sec<tr><td>Cycle 2<td>2.944 sec<td>0.580 sec<tr><td>Cycle 3<td>2.952 sec<td>0.587 sec<tr><td>Cycle 4<td>2.946 sec<td>0.576 sec<tr><td>Cycle 5<td>2.925 sec<td>0.578 sec<tr><td>Cycle 6<td>2.926 sec<td>0.582 sec<tr><td>Cycle 7<td>2.927 sec<td>0.575 sec<tr><td>Cycle 8<td>2.921 sec<td>0.582 sec<tr><td>Cycle 9<td>2.950 sec<td>0.590 sec<tr><td>Cycle 10<td>2.926 sec<td>0.582 sec<tr><td><strong>Total</strong><td><strong>29.585 sec</strong><td><strong>6.032 sec</strong></table><h3 id=why-did-v2-perform-so-much-better>Why did v2 perform so much better?<a aria-label="Anchor link for: why-did-v2-perform-so-much-better" class=zola-anchor href=#why-did-v2-perform-so-much-better>#</a></h3><ul><li>The v1 validation logic involved looping through dictionary key/value pairs and performing type checks and replacements in Python<li>In v2 of Pydantic, all these operations, which are normally rather expensive in Python (due to its dynamic nature), are pushed down to the Rust level <ul><li>None of the loops in the validator expressions are actually run in Python, explaining why without any major code changes, we see a large gain in performance</ul></ul><p>In many real world scenarios, the validation logic implemented in Python (due to business needs) can get rather complex, so the fact that library developers can leverage the power of Rust and reuse code this way, is a huge deal.<h2 id=conclusions-and-broader-implications>Conclusions and broader implications<a aria-label="Anchor link for: conclusions-and-broader-implications" class=zola-anchor href=#conclusions-and-broader-implications>#</a></h2><p>The timing numbers shown in this case study were for <em>validation only</em>. In a full-blown ETL workflow in production, it‚Äôs likely that there are <em>many</em> such scripts working on data far larger than 1 million records. It‚Äôs easy to imagine that, when adding up the number of validations performed in Python at all the FAANG-scale companies (who really do use Pydantic in production), we would get a number in the <em>trillions</em>, purely due to the scale of data and the complexity of tasks being performed at these companies.<p>In 2019, Amazon Web Services (AWS) announced their official sponsorship for the Rust language. AWS is now among the leading contributors to the development of Rust, and for good reason: in 2022, they published a blog post highlighting how large-scale adoption of Rust at the core of compute-heavy operations can reduce energy usage in data centres worldwide<sup class=footnote-reference><a href=#5>4</a></sup> by almost <strong>50%</strong>! ü§Ø<p>As per data available in 2020<sup class=footnote-reference><a href=#6>5</a></sup>, data centres consume about 200 terawatt hours per year globally, which amounts to around 1% of the total energy consumed on our planet. It‚Äôs natural that with the frenzy of activity in AI and cloud computing these days, energy utilization in data centres will only grow with time, so any reduction in energy consumption via more efficient bare-metal operations has massive consequences.<blockquote class="callout tip"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M9.97308 18H11V13H13V18H14.0269C14.1589 16.7984 14.7721 15.8065 15.7676 14.7226C15.8797 14.6006 16.5988 13.8564 16.6841 13.7501C17.5318 12.6931 18 11.385 18 10C18 6.68629 15.3137 4 12 4C8.68629 4 6 6.68629 6 10C6 11.3843 6.46774 12.6917 7.31462 13.7484C7.40004 13.855 8.12081 14.6012 8.23154 14.7218C9.22766 15.8064 9.84103 16.7984 9.97308 18ZM10 20V21H14V20H10ZM5.75395 14.9992C4.65645 13.6297 4 11.8915 4 10C4 5.58172 7.58172 2 12 2C16.4183 2 20 5.58172 20 10C20 11.8925 19.3428 13.6315 18.2443 15.0014C17.624 15.7748 16 17 16 18.5V21C16 22.1046 15.1046 23 14 23H10C8.89543 23 8 22.1046 8 21V18.5C8 17 6.37458 15.7736 5.75395 14.9992Z" fill=currentColor></path></svg></div><div class=content><p>Projects like Pydantic that perform core lower-level operations in Rust while allowing higher-level developers to build rapidly can have a <strong>huge</strong> impact on reducing energy consumption worldwide.</div></blockquote><p>There are many other projects also going down the road of building faster, more efficient Python tooling on top of Rust, but projects like Pydantic, which were among the first to do so, will surely serve as an inspiration to the community at large. üí™<p>Hopefully this post will serve as an inspiration for you to begin exploring (and hopefully, learning) Rust! ü¶Ä üí™üèΩ<h2 id=code-and-data>Code and data<a aria-label="Anchor link for: code-and-data" class=zola-anchor href=#code-and-data>#</a></h2><p>The code and the data to reproduce these results are available <a rel="nofollow noreferrer" href=https://github.com/prrao87/pydantic-benchmarks>on GitHub</a>. Depending on the CPU your machine uses, your mileage may vary. Have fun and happy Pydant-ing! üòé<hr><div class=footnote-definition id=2><sup class=footnote-definition-label>1</sup><p>Data Quality in AI: Challenges, Importance & Best Practices, <a href="https://research.aimultiple.com/data-quality-ai/#:~:text=Data%20quality%20is%20crucial%20in,trust%20and%20confidence%20among%20users." rel="nofollow noreferrer">AIMultiple</a></div><div class=footnote-definition id=3><sup class=footnote-definition-label>2</sup><p>How Pydantic V2 leverages Rust‚Äôs Superpowers, <a rel="nofollow noreferrer" href=https://fosdem.org/2023/schedule/event/rust_how_pydantic_v2_leverages_rusts_superpowers/>FOSDEM ‚Äô23</a></div><div class=footnote-definition id=4><sup class=footnote-definition-label>3</sup><p>The Talk Python Live Stream #376, <a href="https://www.youtube.com/watch?v=URrUBgOFl6U" rel="nofollow noreferrer">Pydantic v2 plan</a></div><div class=footnote-definition id=5><sup class=footnote-definition-label>4</sup><p>Sustainability with Rust, <a rel="nofollow noreferrer" href=https://aws.amazon.com/blogs/opensource/sustainability-with-rust/>AWS Open Source Blog</a></div><div class=footnote-definition id=6><sup class=footnote-definition-label>5</sup><p>Global data centre energy demand by data centre type, 2010-2022, <a rel="nofollow noreferrer" href=https://www.iea.org/data-and-statistics/charts/global-data-centre-energy-demand-by-data-centre-type-2010-2022>iea.org</a></div></article><div class=giscus></div><script async crossorigin data-category=General data-category-id=DIC_kwDOKyWhTs4CbUSt data-emit-metadata=0 data-input-position=bottom data-lang=en data-loading=lazy data-mapping=pathname data-reactions-enabled=1 data-repo=thedataquarry/thedataquarry.github.io data-repo-id=R_kgDOKyWhTg data-strict=0 data-theme=preferred_color_scheme src=https://giscus.app/client.js></script></div><footer><div class=copyright><p>¬© 2024 Prashanth Rao</div><div class=credits>Powered by <a rel="noreferrer noopener" href=https://www.getzola.org target=_blank>zola</a> and <a rel="noreferrer noopener" href=https://github.com/isunjn/serene target=_blank>serene</a></div></footer></main></div><script src=/js/lightense.min.js></script><script src=/js/main.js></script>