<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="light dark" name=color-scheme><title>Neo4j for Pythonistas (1) | The Data Quarry</title><meta content="Neo4j for Pythonistas (1)" property=og:title><meta content="Prashanth Rao" name=author><meta content=en_US property=og:locale><meta content="Using Pydantic and async Python to build a graph in batch mode in Neo4j" name=description><meta content="Using Pydantic and async Python to build a graph in batch mode in Neo4j" property=og:description><link href=https://thedataquarry.github.io/posts/neo4j-python-1/ rel=canonical><meta content=https://thedataquarry.github.io/posts/neo4j-python-1/ property=og:url><meta content="The Data Quarry" property=og:site_name><meta content=https://thedataquarry.github.io/img/dataquarry-banner.png property=og:image><meta content=article property=og:type><meta content=2023-05-22T00:00:00+00:00 property=article:published_time><meta " content=summary_large_image name=twitter:card><meta content=https://thedataquarry.github.io/img/dataquarry-banner.png property=twitter:image><meta content="Neo4j for Pythonistas (1)" property=twitter:title><meta content=@tech_optimist name=twitter:site><meta content="Using Pydantic and async Python to build a graph in batch mode in Neo4j" name=description><title>Neo4j for Pythonistas (1)</title><link href=/img/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/img/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/img/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><style>body{--primary-color:#376dd9;--primary-pale-color:#698bcf1c;--inline-code-color:#444;--text-color:#444;--text-pale-color:#545967;--bg-color:#fff;--highlight-mark-color:#5f75b045;--callout-note-color:#3e70d6;--callout-important-color:#7a46cd;--callout-warning-color:#d3822b;--callout-alert-color:#d43f3f;--callout-question-color:#3089b5;--callout-tip-color:#35a06b;--main-font:"IBMPlexSans",ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--code-font:"IBMPlexMono",ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--homepage-max-width:750px;--main-max-width:750px;--avatar-size:175px;--paragraph-font-size:16px;--paragraph-line-height:1.5em;--aside-font-size:16px;--img-border-radius:4px;--inline-code-border-radius:2px}body.dark{--primary-color:#689afd;--primary-pale-color:#93acdd1c;--inline-code-color:#d2d2d2;--text-color:#ddd;--text-pale-color:#a0a0a0;--bg-color:#202124;--highlight-mark-color:#5f75b045;--callout-note-color:#698bcf;--callout-important-color:#9374c5;--callout-warning-color:#c99054;--callout-alert-color:#d35757;--callout-question-color:#5091b2;--callout-tip-color:#3ea06f}</style><link href=/main.css rel=stylesheet><script async data-website-id=01228822-c189-4b8a-93ba-733d045bf346 src=https://analytics.eu.umami.is/script.js></script><body class=post><script>if(localStorage.getItem('theme')=='dark'){document.body.classList.add('dark');const a=document.querySelector('link#hl');if(a)a.href='/hl-dark.css'}</script><header class=blur><div id=header-wrapper><nav><a href=/>The Data Quarry</a><button aria-label="toggle expand" class=separator id=toggler>::</button><span class="wrap left fold">{</span><a href=/posts>blog</a><span class="wrap-separator fold">,</span><a class=fold href=/talks>talks</a><span class="wrap-separator fold">,</span><a class=fold href=/projects>projects</a><span class="wrap right fold">} ;</span></nav><div id=btns><a rel="noreferrer noopener" aria-label=GitHub href=https://github.com/prrao87 target=_blank> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12" fill=currentColor></path></svg> </a><a rel="noreferrer noopener" aria-label=Twitter href=https://twitter.com/tech_optimist target=_blank> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>Twitter</title><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z" fill=currentColor></path></svg> </a><a rel="noreferrer noopener" aria-label=LinkedIn href=https://www.linkedin.com/in/prrao87 target=_blank> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z" fill=currentColor></path></svg> </a><a aria-label="Buy me a coffee" rel="noreferrer noopener" href=https://www.buymeacoffee.com/prrao87 target=_blank> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>Buy Me A Coffee</title><path d="M20.216 6.415l-.132-.666c-.119-.598-.388-1.163-1.001-1.379-.197-.069-.42-.098-.57-.241-.152-.143-.196-.366-.231-.572-.065-.378-.125-.756-.192-1.133-.057-.325-.102-.69-.25-.987-.195-.4-.597-.634-.996-.788a5.723 5.723 0 00-.626-.194c-1-.263-2.05-.36-3.077-.416a25.834 25.834 0 00-3.7.062c-.915.083-1.88.184-2.75.5-.318.116-.646.256-.888.501-.297.302-.393.77-.177 1.146.154.267.415.456.692.58.36.162.737.284 1.123.366 1.075.238 2.189.331 3.287.37 1.218.05 2.437.01 3.65-.118.299-.033.598-.073.896-.119.352-.054.578-.513.474-.834-.124-.383-.457-.531-.834-.473-.466.074-.96.108-1.382.146-1.177.08-2.358.082-3.536.006a22.228 22.228 0 01-1.157-.107c-.086-.01-.18-.025-.258-.036-.243-.036-.484-.08-.724-.13-.111-.027-.111-.185 0-.212h.005c.277-.06.557-.108.838-.147h.002c.131-.009.263-.032.394-.048a25.076 25.076 0 013.426-.12c.674.019 1.347.067 2.017.144l.228.031c.267.04.533.088.798.145.392.085.895.113 1.07.542.055.137.08.288.111.431l.319 1.484a.237.237 0 01-.199.284h-.003c-.037.006-.075.01-.112.015a36.704 36.704 0 01-4.743.295 37.059 37.059 0 01-4.699-.304c-.14-.017-.293-.042-.417-.06-.326-.048-.649-.108-.973-.161-.393-.065-.768-.032-1.123.161-.29.16-.527.404-.675.701-.154.316-.199.66-.267 1-.069.34-.176.707-.135 1.056.087.753.613 1.365 1.37 1.502a39.69 39.69 0 0011.343.376.483.483 0 01.535.53l-.071.697-1.018 9.907c-.041.41-.047.832-.125 1.237-.122.637-.553 1.028-1.182 1.171-.577.131-1.165.2-1.756.205-.656.004-1.31-.025-1.966-.022-.699.004-1.556-.06-2.095-.58-.475-.458-.54-1.174-.605-1.793l-.731-7.013-.322-3.094c-.037-.351-.286-.695-.678-.678-.336.015-.718.3-.678.679l.228 2.185.949 9.112c.147 1.344 1.174 2.068 2.446 2.272.742.12 1.503.144 2.257.156.966.016 1.942.053 2.892-.122 1.408-.258 2.465-1.198 2.616-2.657.34-3.332.683-6.663 1.024-9.995l.215-2.087a.484.484 0 01.39-.426c.402-.078.787-.212 1.074-.518.455-.488.546-1.124.385-1.766zm-1.478.772c-.145.137-.363.201-.578.233-2.416.359-4.866.54-7.308.46-1.748-.06-3.477-.254-5.207-.498-.17-.024-.353-.055-.47-.18-.22-.236-.111-.71-.054-.995.052-.26.152-.609.463-.646.484-.057 1.046.148 1.526.22.577.088 1.156.159 1.737.212 2.48.226 5.002.19 7.472-.14.45-.06.899-.13 1.345-.21.399-.072.84-.206 1.08.206.166.281.188.657.162.974a.544.544 0 01-.169.364zm-6.159 3.9c-.862.37-1.84.788-3.109.788a5.884 5.884 0 01-1.569-.217l.877 9.004c.065.78.717 1.38 1.5 1.38 0 0 1.243.065 1.658.065.447 0 1.786-.065 1.786-.065.783 0 1.434-.6 1.499-1.38l.94-9.95a3.996 3.996 0 00-1.322-.238c-.826 0-1.491.284-2.26.613z" fill=currentColor></path></svg> </a><button aria-label="theme switch" data-moon-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill="currentColor"></path></svg>' data-sun-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12C18 15.3137 15.3137 18 12 18ZM12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM11 1H13V4H11V1ZM11 20H13V23H11V20ZM3.51472 4.92893L4.92893 3.51472L7.05025 5.63604L5.63604 7.05025L3.51472 4.92893ZM16.9497 18.364L18.364 16.9497L20.4853 19.0711L19.0711 20.4853L16.9497 18.364ZM19.0711 3.51472L20.4853 4.92893L18.364 7.05025L16.9497 5.63604L19.0711 3.51472ZM5.63604 16.9497L7.05025 18.364L4.92893 20.4853L3.51472 19.0711L5.63604 16.9497ZM23 11V13H20V11H23ZM4 11V13H1V11H4Z" fill="currentColor"></path></svg>' id=theme-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill=currentColor></path></svg></button><button aria-label="table of content" id=toc-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M3 4H21V6H3V4ZM3 11H15V13H3V11ZM3 18H21V20H3V18Z" fill=currentColor></path></svg></button></div></div></header><div id=wrapper><div id=blank></div><aside class=blur><nav><ul><li><a class=h2 href=#use-pydantic-and-async-python-to-build-a-graph-in-neo4j>Use Pydantic and async Python to build a graph in Neo4j</a><li><a class=h2 href=#the-data>The data</a><li><a class=h2 href=#the-graph-data-model>The graph data model</a> <ul><li><a class=h3 href=#where-graphs-really-shine>Where graphs really shine</a></ul><li><a class=h2 href=#data-ingestion-into-neo4j>Data ingestion into Neo4j</a> <ul><li><a class=h3 href=#read-the-data-in-chunks>Read the data in chunks</a><li><a class=h3 href=#validate-the-data>Validate the data</a><li><a class=h3 href=#define-build-query>Define build query</a><li><a class=h3 href=#option-1-sync-loader>Option 1: Sync loader</a><li><a class=h3 href=#option-2-async-loader>Option 2: Async loader</a></ul><li><a class=h2 href=#inspect-the-graph-via-the-neo4j-browser>Inspect the graph via the Neo4j browser</a><li><a class=h2 href=#conclusions>Conclusions</a><li><a class=h2 href=#code>Code</a></ul></nav><button aria-label="back to top" id=back-to-top><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M11.9997 10.8284L7.04996 15.7782L5.63574 14.364L11.9997 8L18.3637 14.364L16.9495 15.7782L11.9997 10.8284Z" fill=currentColor></path></svg></button></aside><main><div><div data-check-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z" fill="currentColor"></path></svg>' data-copy-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill="currentColor"></path></svg>' id=copy-cfg style=display:none></div><article data-backlink-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M9.41421 8L18.0208 16.6066L16.6066 18.0208L8 9.41421V17H6V6H17V8H9.41421Z" fill="currentColor"></path></svg>' class=prose><h1>Neo4j for Pythonistas (1)</h1><div id=post-info><div id=date><span id=publish>2023-05-22</span></div><div id=tags><a href=https://thedataquarry.github.io/tags/neo4j><span>#</span>neo4j</a><a href=https://thedataquarry.github.io/tags/async><span>#</span>async</a><a href=https://thedataquarry.github.io/tags/pydantic><span>#</span>pydantic</a><a href=https://thedataquarry.github.io/tags/graph-db><span>#</span>graph-db</a></div></div><h2 id=use-pydantic-and-async-python-to-build-a-graph-in-neo4j>Use Pydantic and async Python to build a graph in Neo4j<a aria-label="Anchor link for: use-pydantic-and-async-python-to-build-a-graph-in-neo4j" class=zola-anchor href=#use-pydantic-and-async-python-to-build-a-graph-in-neo4j>#</a></h2><p>Neo4j has been among the worldâ€™s <a rel="nofollow noreferrer" href=https://www.endava.com/en/blog/Engineering/2021/Following-the-patterns-the-rise-of-neo4j-and-graph-databases>most popular graph databases</a> for a while now, and I really enjoy working with it, and graphs in general. A quick Google search reveals <em>a lot</em> of blog posts and tutorials that show how to bulk-load data into Neo4j via Cypher, Neo4jâ€™s query language, or <a rel="nofollow noreferrer" href=https://neo4j.com/labs/apoc/>APOC</a> (Awesome Procedures on Cypher). If youâ€™re a Python engineer like me (because, ugh, Java ğŸ˜–), and are looking to use Python all the way to ingest large amounts of data into Neo4j in the most efficient way possible, read on!<p>But first, letâ€™s take a step back, and ask ourselves, when APOC and Cypher can do the job, why involve Python at all?<ul><li>You may already have other data-handling and analysis code written in Python, so switching to another language like Java or bash scripts for Neo4j can be a chore.<li>Using a data validation framework like <a rel="nofollow noreferrer" href=https://docs.pydantic.dev/latest/>Pydantic</a> allows you to increase the robustness of the ETL process, while staying within the world of Python and not have to glue together tools written in multiple languages.<li>Async code that performs I/O can be <em>fast</em>. Most database Python clients these days implement asynchronous clients to communicate with databases in a non-blocking manner, and <a rel="nofollow noreferrer" href=https://neo4j.com/docs/python-manual/current/concurrency/>Neo4j is no exception</a>.<li>Pythonâ€™s <code>asyncio</code> API has evolved a lot since its early days, and itâ€™s actually now quite easy to use, with minimal changes in code from the sync version.</ul><p>Combining data validation via Pydantic with async data ingestion can make for fast, efficient and readable Python code that can be maintained by future engineers without having to deal with a mess of glue code. With that in mind, letâ€™s get started with an example!<h2 id=the-data>The data<a aria-label="Anchor link for: the-data" class=zola-anchor href=#the-data>#</a></h2><p>Weâ€™ll be working with <a rel="nofollow noreferrer" href=https://www.kaggle.com/datasets/zynicide/wine-reviews>this wine reviews dataset from Kaggle</a>. It consists of 130k wine reviews from the Wine Enthusiast magazine, including the variety, location, winery, price, description, and some other metadata for each wine. Refer to the Kaggle source for more detailed information on the data and how it was scraped. The original data was downloaded as a single JSON file. For the purposes of this blog post, the data was then converted to newline-delimited JSON (<code>.jsonl</code>) format where each line of the file contains a valid JSON object.<p>An example JSON line is shown below.<pre class=language-json data-lang=json style=background:#2e3440;color:#d8dee9><code class=language-json data-lang=json><span>{
</span><span>    </span><span style=color:#a3be8c>"points"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"90"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"title"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Castello San Donato in Perano 2009 Riserva  (Chianti Classico)"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"description"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Made from a blend of 85% Sangiovese and 15% Merlot, this ripe wine delivers soft plum, black currants, clove and cracked pepper sensations accented with coffee and espresso notes. A backbone of firm tannins give structure. Drink now through 2019."</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"taster_name"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Kerin O'Keefe"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"taster_twitter_handle"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"@kerinokeefe"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"price"</span><span style=color:#eceff4>: </span><span style=color:#b48ead>30</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"designation"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Riserva"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"variety"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Red Blend"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"region_1"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Chianti Classico"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"region_2"</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>null</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"province"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Tuscany"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"country"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Italy"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"winery"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Castello San Donato in Perano"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"id"</span><span style=color:#eceff4>: </span><span style=color:#b48ead>40825
</span><span>}
</span></code></pre><h2 id=the-graph-data-model>The graph data model<a aria-label="Anchor link for: the-graph-data-model" class=zola-anchor href=#the-graph-data-model>#</a></h2><p>The first key step is conceptualizing a data model for the graph. This primarily depends on the kinds of questions weâ€™re trying to answer. In this dataset, each JSON blob contains information about one particular wine, but, conceptually, how are the wines <em>themselves</em> connected to each other?<p>Inspecting the JSON sample above, we can see that there is not only a rating and price information for each wine, but also location information (country, province, region, etc.). Each wine is also tasted by a reviewer, who is a person in the real world with a Twitter handle.<h3 id=where-graphs-really-shine>Where graphs really shine<a aria-label="Anchor link for: where-graphs-really-shine" class=zola-anchor href=#where-graphs-really-shine>#</a></h3><p>The reason that graph databases are <em>really</em> useful in certain situations is best illustrated with an example. Imagine youâ€™re building a query API for wine enthusiasts that follow wine reviewers on Twitter. Suppose these end users are interested the following question:<blockquote class="callout question"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM11 15H13V17H11V15ZM13 13.3551V14H11V12.5C11 11.9477 11.4477 11.5 12 11.5C12.8284 11.5 13.5 10.8284 13.5 10C13.5 9.17157 12.8284 8.5 12 8.5C11.2723 8.5 10.6656 9.01823 10.5288 9.70577L8.56731 9.31346C8.88637 7.70919 10.302 6.5 12 6.5C13.933 6.5 15.5 8.067 15.5 10C15.5 11.5855 14.4457 12.9248 13 13.3551Z" fill=currentColor></path></svg></div><div class=content><p><strong>Question</strong><p><em>Which wine varieties have been most often tasted by my favourite reviewer, Roger Voss, and what countries are those wines from?</em></div></blockquote><p>This seems reasonable enough. But the problem is, our dataset is in the form of individual JSON blobs (as shown above), where each wine reviewerâ€™s name and Twitter handle is associated with a <em>single</em> wine, and the reviewerâ€™s name appears many, many times over the entire dataset. A conventional NoSQL data store (like MongoDB) would require an aggregation query <a rel="nofollow noreferrer" href=https://www.mongodb.com/docs/manual/core/aggregation-pipeline/>built as a pipeline</a> to answer this question, where it would first calculate the number of wines tasted by a person, apply the necessary grouping clauses to gather the wine variety and the country of origin, and finally return the answer. Not only is this approach computationally expensive as the dataset gets larger and larger, itâ€™s also <em>exceptionally unintuitive</em> to us as human beings to reason about.<p>Our human minds tend to see the real world as hierarchies of concepts and entities, and graphs, due to their inherent â€œconnectedâ€ nature, make it very easy to reason about the data model that can help us answer a given question. With this in mind, the following graph model makes sense.<figure><img loading=lazy src=data_model.png></figure><p>We can view each JSON blob as a <code>Wine</code> node, that connects to a <code>Person</code> node, where the <code>Person</code> is a taster. In addition, each wine is also connected to a <code>Country</code> node and a <code>Province</code> node, with each type of location indicating where the wine originates. In addition, a <code>Province</code> can be located in a <code>Country</code>, but not the other way around. The above data model encapsulates all of these real-world relationships nicely, capturing both the <em>nature</em> and the <em>direction</em> of the relationship, and as an added bonus, makes querying a lot easier as well.<p>If the data is modelled this way, the above mentioned Cypher query in Neo4j answers the original question in just a few lines of code:<div class=codeblock-with-filename><div class=filename>cypher</div><pre class=language-sql data-lang=sql style=background:#2e3440;color:#d8dee9><code class=language-sql data-lang=sql><span>MATCH (wine:Wine)</span><span style=color:#81a1c1>-</span><span>[:TASTED_BY]</span><span style=color:#81a1c1>-></span><span>(taster:Person {tasterName: </span><span style=color:#a3be8c>"Roger Voss"</span><span>})
</span><span style=color:#81a1c1>WITH</span><span> wine, taster
</span><span>MATCH (wine)</span><span style=color:#81a1c1>-</span><span>[r:IS_FROM_COUNTRY]</span><span style=color:#81a1c1>-></span><span>(country:Country)
</span><span>RETURN
</span><span>  taster.tasterName </span><span style=color:#81a1c1>AS</span><span> tasterName,
</span><span>  wine.variety </span><span style=color:#81a1c1>AS</span><span> wineVariety,
</span><span>  </span><span style=color:#88c0d0>count</span><span>(r) </span><span style=color:#81a1c1>AS</span><span> winesTasted,
</span><span>  country.countryName </span><span style=color:#81a1c1>AS</span><span> country
</span><span style=color:#81a1c1>ORDER BY</span><span> winesTasted </span><span style=color:#81a1c1>DESC</span><span>, tasterName </span><span style=color:#81a1c1>LIMIT </span><span style=color:#b48ead>5
</span></code></pre></div><p>The result would look something like this:<pre class=language-sh data-lang=sh style=background:#2e3440;color:#d8dee9><code class=language-sh data-lang=sh><span style=color:#88c0d0>â•’â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â••
</span><span style=color:#88c0d0>â”‚tasterName</span><span>  â”‚wineVariety               â”‚winesTastedâ”‚country   â”‚
</span><span style=color:#88c0d0>â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•¡
</span><span style=color:#88c0d0>â”‚</span><span style=color:#a3be8c>"Roger Voss"</span><span style=color:#88c0d0>â”‚</span><span style=color:#a3be8c>"Bordeaux-style Red Blend"</span><span style=color:#88c0d0>â”‚4702</span><span>       â”‚</span><span style=color:#a3be8c>"France"</span><span>  â”‚
</span><span style=color:#88c0d0>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
</span><span style=color:#88c0d0>â”‚</span><span style=color:#a3be8c>"Roger Voss"</span><span style=color:#88c0d0>â”‚</span><span style=color:#a3be8c>"Chardonnay"</span><span>              â”‚2724       â”‚</span><span style=color:#a3be8c>"France"</span><span>  â”‚
</span><span style=color:#88c0d0>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
</span><span style=color:#88c0d0>â”‚</span><span style=color:#a3be8c>"Roger Voss"</span><span style=color:#88c0d0>â”‚</span><span style=color:#a3be8c>"Portuguese Red"</span><span>          â”‚2462       â”‚</span><span style=color:#a3be8c>"Portugal"</span><span>â”‚
</span><span style=color:#88c0d0>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
</span><span style=color:#88c0d0>â”‚</span><span style=color:#a3be8c>"Roger Voss"</span><span style=color:#88c0d0>â”‚</span><span style=color:#a3be8c>"Pinot Noir"</span><span>              â”‚1827       â”‚</span><span style=color:#a3be8c>"France"</span><span>  â”‚
</span><span style=color:#88c0d0>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
</span><span style=color:#88c0d0>â”‚</span><span style=color:#a3be8c>"Roger Voss"</span><span style=color:#88c0d0>â”‚</span><span style=color:#a3be8c>"RosÃ©"</span><span>                    â”‚1555       â”‚</span><span style=color:#a3be8c>"France"</span><span>  â”‚
</span><span style=color:#88c0d0>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></code></pre><p>We can see that Roger Voss is a hugely prolific wine taster! And a <a rel="nofollow noreferrer" href=https://www.winemag.com/2013/09/19/wes-roger-voss-wins-prestigious-bordeaux-award/>quick Google search reveals the same</a> â€“ Between 2009-2013, Roger had tasted over 3,000 Bordeaux-style red wines! And our dataset in this blog post is from 2017, by which time he managed to taste over 4,700 of them! ğŸ¤¯<p>In just a few lines of Cypher, we were able to answer a query that might have taken quite a bit more lines (of less-readable JSON) in another database like MongoDB.<h2 id=data-ingestion-into-neo4j>Data ingestion into Neo4j<a aria-label="Anchor link for: data-ingestion-into-neo4j" class=zola-anchor href=#data-ingestion-into-neo4j>#</a></h2><p>With that bit of background out of the way, letâ€™s look at how to build such a graph in Neo4j using Python. As mentioned before, the following ETL best practices are baked into this process:<ul><li>Data quality: The data is validated via <a rel="nofollow noreferrer" href=https://docs.pydantic.dev/latest/>Pydantic</a> to ensure that the types align with what we expect during querying<li>Performance: The Cypher queries that actually perform the merging operations are written with efficiency, quality and scalability in mind</ul><h3 id=read-the-data-in-chunks>Read the data in chunks<a aria-label="Anchor link for: read-the-data-in-chunks" class=zola-anchor href=#read-the-data-in-chunks>#</a></h3><p>To get the best performance (as the <a rel="nofollow noreferrer" href=https://neo4j.com/docs/python-manual/current/performance/>Neo4j official Cypher docs</a>), we read the data in batches of 10k-25k records, and make use of <code>WITH</code> and <code>UNWIND</code> clauses in Cypher to expand a given list of JSON blobs into individual records before ingesting them into Neo4j.<blockquote class="callout tip"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M9.97308 18H11V13H13V18H14.0269C14.1589 16.7984 14.7721 15.8065 15.7676 14.7226C15.8797 14.6006 16.5988 13.8564 16.6841 13.7501C17.5318 12.6931 18 11.385 18 10C18 6.68629 15.3137 4 12 4C8.68629 4 6 6.68629 6 10C6 11.3843 6.46774 12.6917 7.31462 13.7484C7.40004 13.855 8.12081 14.6012 8.23154 14.7218C9.22766 15.8064 9.84103 16.7984 9.97308 18ZM10 20V21H14V20H10ZM5.75395 14.9992C4.65645 13.6297 4 11.8915 4 10C4 5.58172 7.58172 2 12 2C16.4183 2 20 5.58172 20 10C20 11.8925 19.3428 13.6315 18.2443 15.0014C17.624 15.7748 16 17 16 18.5V21C16 22.1046 15.1046 23 14 23H10C8.89543 23 8 22.1046 8 21V18.5C8 17 6.37458 15.7736 5.75395 14.9992Z" fill=currentColor></path></svg></div><div class=content><p><strong>Tip</strong><p>For best performance, always aim to pass a large chunk of JSON blobs (i.e., in Python-speak, a <em>list of dicts</em>) to your ingestion function and <code>UNWIND</code> them in Cypher, rather than passing each JSON blob individually. This minimizes the I/O overhead between Python and Neo4j.</div></blockquote><p>The following code does this:<div class=codeblock-with-filename><div class=filename>python</div><pre class=language-python data-lang=python style=background:#2e3440;color:#d8dee9><code class=language-python data-lang=python><span style=color:#81a1c1>import </span><span>srsly
</span><span>
</span><span style=color:#81a1c1>def </span><span style=color:#88c0d0>chunk_iterable</span><span>(item_list</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>list</span><span>[JsonBlob]</span><span style=color:#eceff4>, </span><span>chunksize</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>int</span><span>) </span><span style=color:#eceff4>-> </span><span>Iterator[</span><span style=color:#81a1c1>list</span><span>[JsonBlob]]:
</span><span>    </span><span style=color:#616e88>"""
</span><span style=color:#616e88>    Break a large iterable into an iterable of smaller iterables
</span><span style=color:#616e88>    """
</span><span>    </span><span style=color:#81a1c1>for </span><span>i </span><span style=color:#81a1c1>in </span><span style=font-style:italic;color:#88c0d0>range</span><span>(</span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=font-style:italic;color:#88c0d0>len</span><span>(item_list)</span><span style=color:#eceff4>, </span><span>chunksize):
</span><span>        </span><span style=color:#81a1c1>yield </span><span>item_list[i </span><span style=color:#eceff4>: </span><span>i </span><span style=color:#81a1c1>+ </span><span>chunksize]
</span><span>
</span><span>
</span><span style=color:#81a1c1>def </span><span style=color:#88c0d0>get_json_data</span><span>(data_dir</span><span style=color:#eceff4>: </span><span>Path</span><span style=color:#eceff4>, </span><span>filename</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str</span><span>) </span><span style=color:#eceff4>-> </span><span style=color:#81a1c1>list</span><span>[JsonBlob]:
</span><span>    </span><span style=color:#616e88>"""Read in data from a JSONL file using srsly"""
</span><span>    file_path </span><span style=color:#81a1c1>= </span><span>data_dir </span><span style=color:#81a1c1>/ </span><span>filename
</span><span>    </span><span style=color:#81a1c1>if not </span><span>file_path</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_file</span><span>():
</span><span>        </span><span style=color:#81a1c1>raise </span><span style=color:#8fbcbb>FileNotFoundError</span><span>(</span><span style=color:#81a1c1>f</span><span style=color:#a3be8c>"No valid .jsonl file found in `</span><span>{data_dir}</span><span style=color:#a3be8c>`"</span><span>)
</span><span>    </span><span style=color:#81a1c1>else</span><span>:
</span><span>        data </span><span style=color:#81a1c1>= </span><span>srsly</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>read_gzip_jsonl</span><span>(file_path)
</span><span>    </span><span style=color:#81a1c1>return </span><span>data
</span><span>
</span><span>
</span><span>data </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>get_json_data</span><span>(</span><span style=color:#a3be8c>"/path_to_data/"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"winemag-data-130k-v2.jsonl"</span><span>)
</span><span>chunked_data </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>chunk_iterable</span><span>(data</span><span style=color:#eceff4>, </span><span>CHUNKSIZE</span><span style=color:#81a1c1>=</span><span style=color:#b48ead>10_000</span><span>)
</span></code></pre></div><p>This snippet shows how to read data from a <code>.jsonl.gz</code> file using <a rel="nofollow noreferrer" href=https://github.com/explosion/srsly>srsly</a>, an efficient and light-weight JSON serialization/deserialization Python library. The data from <code>winemag-data-130k-v2.jsonl</code> is read in and chunked into batches of size 10,000. That is, each chunk contains a list of 10,000 individual wine reviews, all the way up to 130k reviews.<h3 id=validate-the-data>Validate the data<a aria-label="Anchor link for: validate-the-data" class=zola-anchor href=#validate-the-data>#</a></h3><p>A Pydantic schema is created to ensure specific fields exists and that the data is of the expected type prior to passing it to the Neo4j graph.<blockquote class="callout important"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM11 15H13V17H11V15ZM11 7H13V13H11V7Z" fill=currentColor></path></svg></div><div class=content><p><strong>Info</strong><p>Even though Neo4j doesnâ€™t enforce schemas, itâ€™s generally a good practice to specify a schema via an external framework like Pydantic, with the appropriate data types in a production scenario so that there are no unintended bugs during ingestion, or while querying the data.</div></blockquote><p>As can be seen below, we state via the Pydantic schema that the fields <code>id</code>, <code>points</code> and <code>title</code> are required fields, and in case they are absent in the data, Pydantic will raise an error, not allowing the record to be ingested to the database.<div class=codeblock-with-filename><div class=filename>python</div><pre class=language-python data-lang=python style=background:#2e3440;color:#d8dee9><code class=language-python data-lang=python><span style=color:#81a1c1>from </span><span>pydantic </span><span style=color:#81a1c1>import </span><span>BaseModel</span><span style=color:#eceff4>, </span><span>Field</span><span style=color:#eceff4>, </span><span>validator
</span><span>
</span><span>
</span><span style=color:#81a1c1>class </span><span style=color:#8fbcbb>Wine</span><span>(</span><span style=color:#8fbcbb>BaseModel</span><span>):
</span><span>    </span><span style=font-style:italic;color:#88c0d0>id</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>int
</span><span>    points</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>int
</span><span>    title</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str
</span><span>    description</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><span>    price</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>float | None
</span><span>    variety</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><span>    winery</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><span>    country</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><span>    province</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><span>    region_1</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><span>    region_2</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><span>    </span><span style=color:#616e88># Rename the `designation` field to `vineyard` so it's more intuitive to end user
</span><span>    vineyard</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None = </span><span style=color:#88c0d0>Field</span><span>(alias</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>"designation"</span><span>)
</span><span>    taster_name</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><span>    taster_twitter_handle</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None
</span><span>
</span><span>    </span><span style=color:#d08770>@</span><span>validator(</span><span style=color:#a3be8c>"country"</span><span style=color:#eceff4>, </span><span>pre</span><span style=color:#81a1c1>=True</span><span>)
</span><span>    </span><span style=color:#81a1c1>def </span><span style=color:#88c0d0>validate_country</span><span>(cls</span><span style=color:#eceff4>, </span><span>value</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str | None</span><span>) </span><span style=color:#eceff4>-> </span><span style=color:#81a1c1>str</span><span>:
</span><span>        </span><span style=color:#616e88># Ensure we have a non-null country value
</span><span>        </span><span style=color:#81a1c1>if </span><span>value </span><span style=color:#81a1c1>is None</span><span>:
</span><span>            </span><span style=color:#81a1c1>return </span><span style=color:#a3be8c>"Unknown"
</span><span>        </span><span style=color:#81a1c1>return </span><span>value
</span></code></pre></div><h3 id=define-build-query>Define build query<a aria-label="Anchor link for: define-build-query" class=zola-anchor href=#define-build-query>#</a></h3><p>The next step is to define a build query that <code>UNWIND</code>s the list of dicts into individual records that represent the nodes and edges in the graph.<div class=codeblock-with-filename><div class=filename>cypher</div><pre class=language-sql data-lang=sql style=background:#2e3440;color:#d8dee9><code class=language-sql data-lang=sql><span>UNWIND $data </span><span style=color:#81a1c1>AS</span><span> record
</span><span>MERGE (wine:Wine {wineID: record.id})
</span><span>    </span><span style=color:#81a1c1>SET</span><span> wine </span><span style=color:#81a1c1>+=</span><span> {
</span><span>        points: record.points,
</span><span>        title: record.title,
</span><span>        description: record.description,
</span><span>        price: record.price,
</span><span>        variety: record.variety,
</span><span>        winery: record.winery,
</span><span>        vineyard: record.vineyard,
</span><span>        region_1: record.region_1,
</span><span>        region_2: record.region_2
</span><span>    }
</span><span style=color:#81a1c1>WITH</span><span> record, wine
</span><span>    </span><span style=color:#81a1c1>WHERE </span><span>record.taster_name </span><span style=color:#81a1c1>IS NOT NULL
</span><span>    MERGE (taster:Person {tasterName: record.taster_name})
</span><span>        </span><span style=color:#81a1c1>SET</span><span> taster </span><span style=color:#81a1c1>+=</span><span> {tasterTwitterHandle: record.taster_twitter_handle}
</span><span>    MERGE (wine)</span><span style=color:#81a1c1>-</span><span>[:TASTED_BY]</span><span style=color:#81a1c1>-></span><span>(taster)
</span><span style=color:#81a1c1>WITH</span><span> record, wine
</span><span>    MERGE (country:Country {countryName: record.country})
</span><span>    MERGE (wine)</span><span style=color:#81a1c1>-</span><span>[:IS_FROM_COUNTRY]</span><span style=color:#81a1c1>-></span><span>(country)
</span><span style=color:#81a1c1>WITH</span><span> record, wine, country
</span><span style=color:#81a1c1>WHERE </span><span>record.province </span><span style=color:#81a1c1>IS NOT NULL
</span><span>    MERGE (province:Province {provinceName: record.province})
</span><span>    MERGE (wine)</span><span style=color:#81a1c1>-</span><span>[:IS_FROM_PROVINCE]</span><span style=color:#81a1c1>-></span><span>(province)
</span><span style=color:#81a1c1>WITH</span><span> record, wine, country, province
</span><span>    </span><span style=color:#81a1c1>WHERE </span><span>record.province </span><span style=color:#81a1c1>IS NOT NULL AND </span><span>record.country </span><span style=color:#81a1c1>IS NOT NULL
</span><span>    MERGE (province)</span><span style=color:#81a1c1>-</span><span>[:IS_LOCATED_IN]</span><span style=color:#81a1c1>-></span><span>(country)
</span></code></pre></div><p>This build query, stored as a parameterized Cypher query via the Neo4j Python client, does the following:<ul><li><code>UNWIND</code> a list of 10,000 records into a sequence of â€œrowsâ€ that can be ingested into Neo4j much more efficiently than by passing each row individually<li><code>MERGE</code> each wine as a <code>:Wine</code> node along with its metadata <ul><li>The <code>MERGE</code> keyword is used as opposed to the <code>CREATE</code> keyword to avoid creating duplicates (in case two wines with the same <code>id</code> fields exist)</ul><li><code>MERGE</code> each wineâ€™s taster as a <code>:Person</code> node, along with the tasterâ€™s name and Twitter handle <ul><li><code>MERGE</code> the edge between the wine and its taster</ul><li><code>MERGE</code> each wineâ€™s country of origin <ul><li><code>MERGE</code> the edge between the wine and its country of origin</ul><li><code>MERGE</code> each wineâ€™s province of origin <ul><li><code>MERGE</code> the edge between the wine and its province of origin</ul><li><code>MERGE</code> the edge between a province and the country itâ€™s in</ul><p>The above sequence of steps in the build query will correspond nicely with the <a href=https://thedataquarry.github.io/posts/neo4j-python-1/#the-graph-data-model>graph data model defined above</a>!<h3 id=option-1-sync-loader>Option 1: Sync loader<a aria-label="Anchor link for: option-1-sync-loader" class=zola-anchor href=#option-1-sync-loader>#</a></h3><p>The simplest way to wrap all this functionality in a usable function is to define a <code>main</code> function via the Neo4j Python client as follows:<div class=codeblock-with-filename><div class=filename>python</div><pre class=language-python data-lang=python style=background:#2e3440;color:#d8dee9><code class=language-python data-lang=python><span>
</span><span style=color:#81a1c1>def </span><span style=color:#88c0d0>create_indexes_and_constraints</span><span>(session</span><span style=color:#eceff4>: </span><span>Session) </span><span style=color:#eceff4>-> </span><span style=color:#81a1c1>None</span><span>:
</span><span>    queries </span><span style=color:#81a1c1>= </span><span>[
</span><span>        </span><span style=color:#616e88># constraints
</span><span>        </span><span style=color:#a3be8c>"CREATE </span><span style=color:#81a1c1>CONSTRAINT</span><span style=color:#a3be8c> countryName IF NOT </span><span style=color:#81a1c1>EXISTS</span><span style=color:#a3be8c> FOR (c:Country) REQUIRE </span><span>c</span><span style=color:#a3be8c>.</span><span>countryName</span><span style=color:#a3be8c> IS UNIQUE "</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"CREATE </span><span style=color:#81a1c1>CONSTRAINT</span><span style=color:#a3be8c> wineID IF NOT </span><span style=color:#81a1c1>EXISTS</span><span style=color:#a3be8c> FOR (w:Wine) REQUIRE </span><span>w</span><span style=color:#a3be8c>.</span><span>wineID</span><span style=color:#a3be8c> IS UNIQUE "</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#616e88># indexes
</span><span>        </span><span style=color:#a3be8c>"</span><span style=color:#81a1c1>CREATE INDEX </span><span style=color:#a3be8c>provinceName IF NOT EXISTS </span><span style=color:#88c0d0>FOR</span><span style=color:#a3be8c> (p:Province) ON (</span><span>p</span><span style=color:#a3be8c>.</span><span>provinceName</span><span style=color:#a3be8c>) "</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"</span><span style=color:#81a1c1>CREATE INDEX </span><span style=color:#a3be8c>tasterName IF NOT EXISTS </span><span style=color:#88c0d0>FOR</span><span style=color:#a3be8c> (p:Person) ON (</span><span>p</span><span style=color:#a3be8c>.</span><span>tasterName</span><span style=color:#a3be8c>) "</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"CREATE FULLTEXT INDEX searchText IF NOT </span><span style=color:#81a1c1>EXISTS</span><span style=color:#a3be8c> FOR (w:Wine) ON EACH [</span><span>w</span><span style=color:#a3be8c>.</span><span>title</span><span style=color:#a3be8c>, </span><span>w</span><span style=color:#a3be8c>.</span><span>description</span><span style=color:#a3be8c>, </span><span>w</span><span style=color:#a3be8c>.</span><span>variety</span><span style=color:#a3be8c>] "</span><span style=color:#eceff4>,
</span><span>    ]
</span><span>    </span><span style=color:#81a1c1>for </span><span>query </span><span style=color:#81a1c1>in </span><span>queries:
</span><span>         session</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>run</span><span>(query)
</span><span>
</span><span>
</span><span style=color:#81a1c1>def </span><span style=color:#88c0d0>ingest_data</span><span>(session</span><span style=color:#eceff4>: </span><span>Session</span><span style=color:#eceff4>, </span><span>validated_data</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>list</span><span>[JsonBlob]) </span><span style=color:#eceff4>-> </span><span style=color:#81a1c1>None</span><span>:
</span><span>    </span><span style=color:#81a1c1>for </span><span>data </span><span style=color:#81a1c1>in </span><span>validated_data:
</span><span>        ids </span><span style=color:#81a1c1>= </span><span>[item[</span><span style=color:#a3be8c>"id"</span><span>] </span><span style=color:#81a1c1>for </span><span>item </span><span style=color:#81a1c1>in </span><span>data]
</span><span>        </span><span style=color:#81a1c1>try</span><span>:
</span><span>            session</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>execute_write</span><span>(build_query</span><span style=color:#eceff4>, </span><span>data)
</span><span>            </span><span style=font-style:italic;color:#88c0d0>print</span><span>(</span><span style=color:#81a1c1>f</span><span style=color:#a3be8c>"Processed ids in range </span><span>{</span><span style=font-style:italic;color:#88c0d0>min</span><span>(ids)}</span><span style=color:#a3be8c>-</span><span>{</span><span style=font-style:italic;color:#88c0d0>max</span><span>(ids)}</span><span style=color:#a3be8c>"</span><span>)
</span><span>        </span><span style=color:#81a1c1>except </span><span style=color:#8fbcbb>Exception </span><span style=color:#81a1c1>as </span><span>e:
</span><span>            </span><span style=font-style:italic;color:#88c0d0>print</span><span>(</span><span style=color:#81a1c1>f</span><span style=color:#a3be8c>"</span><span>{e}</span><span style=color:#a3be8c>: Failed to ingest IDs in range </span><span>{</span><span style=font-style:italic;color:#88c0d0>min</span><span>(ids)}</span><span style=color:#a3be8c>-</span><span>{</span><span style=font-style:italic;color:#88c0d0>max</span><span>(ids)}</span><span style=color:#a3be8c>"</span><span>)
</span><span>
</span><span>
</span><span style=color:#81a1c1>def </span><span style=color:#88c0d0>main</span><span>(data</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>list</span><span>[JsonBlob]) </span><span style=color:#eceff4>-> </span><span style=color:#81a1c1>None</span><span>:
</span><span>     </span><span style=color:#81a1c1>with </span><span>GraphDatabase</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>driver</span><span>(</span><span style=color:#81a1c1>URI</span><span style=color:#eceff4>, </span><span>auth</span><span style=color:#81a1c1>=</span><span>(</span><span style=color:#81a1c1>NEO4J_USER</span><span style=color:#eceff4>, </span><span style=color:#81a1c1>NEO4J_PASSWORD</span><span>)) </span><span style=color:#81a1c1>as </span><span>driver:
</span><span>         </span><span style=color:#81a1c1>with </span><span>driver</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>session</span><span>(database</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>"neo4j"</span><span>) </span><span style=color:#81a1c1>as </span><span>session:
</span><span>            </span><span style=color:#616e88># Create indexes and constraints
</span><span>            </span><span style=color:#88c0d0>create_indexes_and_constraints</span><span>(session)
</span><span>            </span><span style=color:#616e88># Ingest the data into Neo4j
</span><span>            </span><span style=font-style:italic;color:#88c0d0>print</span><span>(</span><span style=color:#a3be8c>"Validating data..."</span><span>)
</span><span>            validated_data </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>validate</span><span>(data</span><span style=color:#eceff4>, </span><span>Wine</span><span style=color:#eceff4>, </span><span>exclude_none</span><span style=color:#81a1c1>=True</span><span>)
</span><span>            </span><span style=color:#616e88># Break the data into chunks
</span><span>            chunked_data </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>chunk_iterable</span><span>(validated_data</span><span style=color:#eceff4>, </span><span>CHUNKSIZE</span><span style=color:#81a1c1>=</span><span style=color:#b48ead>10_000</span><span>)
</span><span>            </span><span style=font-style:italic;color:#88c0d0>print</span><span>(</span><span style=color:#a3be8c>"Ingesting data..."</span><span>)
</span><span>            </span><span style=color:#81a1c1>for </span><span>chunk </span><span style=color:#81a1c1>in </span><span>chunked_data:
</span><span>                ids </span><span style=color:#81a1c1>= </span><span>[item[</span><span style=color:#a3be8c>"id"</span><span>] </span><span style=color:#81a1c1>for </span><span>item </span><span style=color:#81a1c1>in </span><span>chunk]
</span><span>                </span><span style=color:#81a1c1>try</span><span>:
</span><span>                    session</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>execute_write</span><span>(build_query</span><span style=color:#eceff4>, </span><span>chunk)
</span><span>                    </span><span style=font-style:italic;color:#88c0d0>print</span><span>(</span><span style=color:#81a1c1>f</span><span style=color:#a3be8c>"Processed ids in range </span><span>{</span><span style=font-style:italic;color:#88c0d0>min</span><span>(ids)}</span><span style=color:#a3be8c>-</span><span>{</span><span style=font-style:italic;color:#88c0d0>max</span><span>(ids)}</span><span style=color:#a3be8c>"</span><span>)
</span><span>                </span><span style=color:#81a1c1>except </span><span style=color:#8fbcbb>Exception </span><span style=color:#81a1c1>as </span><span>e:
</span><span>                    </span><span style=font-style:italic;color:#88c0d0>print</span><span>(</span><span style=color:#81a1c1>f</span><span style=color:#a3be8c>"</span><span>{e}</span><span style=color:#a3be8c>: Failed to ingest IDs in range </span><span>{</span><span style=font-style:italic;color:#88c0d0>min</span><span>(ids)}</span><span style=color:#a3be8c>-</span><span>{</span><span style=font-style:italic;color:#88c0d0>max</span><span>(ids)}</span><span style=color:#a3be8c>"</span><span>)
</span></code></pre></div><p>In the above code, we open a regular (sync) <code>GraphDatabase</code> driver and a <code>session</code> object via their own context managers, so that the session and database driver exit cleanly upon completion. Note that a custom <code>validate</code> function is also defined as follows:<div class=codeblock-with-filename><div class=filename>python</div><pre class=language-python data-lang=python style=background:#2e3440;color:#d8dee9><code class=language-python data-lang=python><span style=color:#81a1c1>def </span><span style=color:#88c0d0>validate</span><span>(data</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>list</span><span>[JsonBlob]</span><span style=color:#eceff4>, </span><span>exclude_none</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>bool = False</span><span>) </span><span style=color:#eceff4>-> </span><span style=color:#81a1c1>list</span><span>[JsonBlob]:
</span><span>    validated_data </span><span style=color:#81a1c1>= </span><span>[</span><span style=color:#88c0d0>Wine</span><span>(</span><span style=color:#81a1c1>**</span><span>item)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>dict</span><span>(exclude_none</span><span style=color:#81a1c1>=</span><span>exclude_none) </span><span style=color:#81a1c1>for </span><span>item </span><span style=color:#81a1c1>in </span><span>data]
</span><span>    </span><span style=color:#81a1c1>return </span><span>validated_data
</span></code></pre></div><p>This function unpacks each blob of JSON (which is a valid Python dict) into the Pydantic model, which validates it and throws an error if the data doesnâ€™t conform to the schema specification. If all is well, the data is once again returned as a valid list of dicts for the next steps.<p>The following key steps are performed in sequence:<ol><li>Create appropriate indexes and constraints to speed up ingestion into Neo4j, as per the <code>create_indexes_and_constraints</code> function<li>Validate the entire dataset of 130k records in Pydantic via the<li>Chunk up the data into lists of 10k records<li>Iterate through each chunk<li>Use the sessionâ€™s <code>execute_write</code> method to handle and manage transactions with Neo4j, and pass the build query to this object <ul><li>The build query unwinds the batch and handles the rest of the work using Cypher</ul></ol><h4 id=sync-run-time-for-full-data-ingestion>Sync run time for full data ingestion<a aria-label="Anchor link for: sync-run-time-for-full-data-ingestion" class=zola-anchor href=#sync-run-time-for-full-data-ingestion>#</a></h4><blockquote class="callout note"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM11 7H13V9H11V7ZM11 11H13V17H11V11Z" fill=currentColor></path></svg></div><div class=content><p>The timing numbers shown below are from an M2 Macbook Pro, running Python 3.11 and Neo4j 5.7..0 via Docker.</div></blockquote><div class=codeblock-with-filename><div class=filename>bash</div><pre class=language-bash data-lang=bash style=background:#2e3440;color:#d8dee9><code class=language-bash data-lang=bash><span style=color:#88c0d0>$</span><span> python bulk_ingest_sync.py
</span><span style=color:#88c0d0>Validating</span><span> data...
</span><span style=color:#88c0d0>Elapsed</span><span> time: 2.9791 seconds
</span><span style=color:#88c0d0>Ingesting</span><span> data...
</span><span style=color:#88c0d0>Processed</span><span> ids in range 1-10000
</span><span style=color:#88c0d0>Processed</span><span> ids in range 10001-20000
</span><span style=color:#88c0d0>Processed</span><span> ids in range 20001-30000
</span><span style=color:#88c0d0>Processed</span><span> ids in range 30001-40000
</span><span style=color:#88c0d0>Processed</span><span> ids in range 40001-50000
</span><span style=color:#88c0d0>Processed</span><span> ids in range 50001-60000
</span><span style=color:#88c0d0>Processed</span><span> ids in range 60001-70000
</span><span style=color:#88c0d0>Processed</span><span> ids in range 70001-80000
</span><span style=color:#88c0d0>Processed</span><span> ids in range 80001-90000
</span><span style=color:#88c0d0>Processed</span><span> ids in range 90001-100000
</span><span style=color:#88c0d0>Processed</span><span> ids in range 100001-110000
</span><span style=color:#88c0d0>Processed</span><span> ids in range 110001-120000
</span><span style=color:#88c0d0>Processed</span><span> ids in range 120001-129971
</span><span style=color:#88c0d0>Elapsed</span><span> time: 6.2240 seconds
</span><span style=color:#88c0d0>Finished</span><span> execution!
</span></code></pre></div><p>And thatâ€™s it! The standard sync Neo4j Python client was used to effectively read, validate and ingest the data into Neo4j, using just Python, all within roughly 9.5 seconds! Note that the the actual data ingestion took about 6.5 seconds on average across 3 runs, and data validation (for all 130K records) in Pydantic took ~3 seconds.<h3 id=option-2-async-loader>Option 2: Async loader<a aria-label="Anchor link for: option-2-async-loader" class=zola-anchor href=#option-2-async-loader>#</a></h3><p>An alternative way to ingest the data into Neo4j is to use the async client, which applies Pythonâ€™s <code>async</code>/<code>await</code> syntax to execute code in a non-blocking manner. All it requires is a few small changes to the existing code. Simply switch the existing Neo4j functions (including the build query one) to use the <code>async</code>/<code>await</code> syntax as follows.<div class=codeblock-with-filename><div class=filename>python</div><pre class=language-python data-lang=python style=background:#2e3440;color:#d8dee9><code class=language-python data-lang=python><span style=color:#81a1c1>async def </span><span style=color:#88c0d0>create_indexes_and_constraints</span><span>(session</span><span style=color:#eceff4>: </span><span>AsyncSession) </span><span style=color:#eceff4>-> </span><span style=color:#81a1c1>None</span><span>:
</span><span>    queries </span><span style=color:#81a1c1>= </span><span>[
</span><span>        </span><span style=color:#616e88># Define constraints and indexes queries the same way as the sync function
</span><span>    ] 
</span><span>    </span><span style=color:#81a1c1>for </span><span>query </span><span style=color:#81a1c1>in </span><span>queries:
</span><span>         </span><span style=color:#81a1c1>await </span><span>session</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>run</span><span>(query)
</span><span>
</span><span>
</span><span style=color:#81a1c1>async def </span><span style=color:#88c0d0>build_query</span><span>(tx</span><span style=color:#eceff4>: </span><span>AsyncManagedTransaction</span><span style=color:#eceff4>, </span><span>data</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>list</span><span>[JsonBlob]) </span><span style=color:#eceff4>-> </span><span style=color:#81a1c1>None</span><span>:
</span><span>    </span><span style=color:#616e88># Same build query as the sync one
</span><span>    query </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>"""
</span><span style=color:#a3be8c>        UNWIND $data AS record
</span><span style=color:#a3be8c>        ...
</span><span style=color:#a3be8c>        ...
</span><span style=color:#a3be8c>    """
</span><span>    </span><span style=color:#81a1c1>await </span><span>tx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>run</span><span>(query</span><span style=color:#eceff4>, </span><span>data</span><span style=color:#81a1c1>=</span><span>data)
</span></code></pre></div><p>Each transaction with Neo4j is awaited, just like you would any other async function in Python. Then, the <code>main</code> function is modified as follows.<div class=codeblock-with-filename><div class=filename>python</div><pre class=language-python data-lang=python style=background:#2e3440;color:#d8dee9><code class=language-python data-lang=python><span style=color:#81a1c1>async def </span><span style=color:#88c0d0>main</span><span>(data</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>list</span><span>[JsonBlob]) </span><span style=color:#eceff4>-> </span><span style=color:#81a1c1>None</span><span>:
</span><span>     </span><span style=color:#81a1c1>async with </span><span>AsyncGraphDatabase</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>driver</span><span>(</span><span style=color:#81a1c1>URI</span><span style=color:#eceff4>, </span><span>auth</span><span style=color:#81a1c1>=</span><span>(</span><span style=color:#81a1c1>NEO4J_USER</span><span style=color:#eceff4>, </span><span style=color:#81a1c1>NEO4J_PASSWORD</span><span>)) </span><span style=color:#81a1c1>as </span><span>driver:
</span><span>         </span><span style=color:#81a1c1>async with </span><span>driver</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>session</span><span>(database</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>"neo4j"</span><span>) </span><span style=color:#81a1c1>as </span><span>session:
</span><span>            </span><span style=color:#616e88># Create indexes and constraints
</span><span>            </span><span style=color:#81a1c1>await </span><span style=color:#88c0d0>create_indexes_and_constraints</span><span>(session)
</span><span>            </span><span style=color:#616e88># Ingest the data into Neo4j
</span><span>            </span><span style=font-style:italic;color:#88c0d0>print</span><span>(</span><span style=color:#a3be8c>"Validating data..."</span><span>)
</span><span>            validated_data </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>validate</span><span>(data</span><span style=color:#eceff4>, </span><span>Wine</span><span style=color:#eceff4>, </span><span>exclude_none</span><span style=color:#81a1c1>=True</span><span>)
</span><span>            </span><span style=color:#616e88># Break the data into chunks
</span><span>            chunked_data </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>chunk_iterable</span><span>(validated_data</span><span style=color:#eceff4>, </span><span>CHUNKSIZE</span><span style=color:#81a1c1>=</span><span style=color:#b48ead>10_000</span><span>)
</span><span>            </span><span style=font-style:italic;color:#88c0d0>print</span><span>(</span><span style=color:#a3be8c>"Ingesting data..."</span><span>)
</span><span>            </span><span style=color:#81a1c1>for </span><span>chunk </span><span style=color:#81a1c1>in </span><span>chunked_data:
</span><span>                </span><span style=color:#616e88># Awaiting each chunk in a loop isn't ideal, but it's easiest this way when working with graphs!
</span><span>                </span><span style=color:#616e88># Merging edges on top of nodes concurrently can lead to race conditions. Neo4j doesn't allow this,
</span><span>                </span><span style=color:#616e88># and prevents the user from merging relationships on nodes that might not exist yet, for good reason.
</span><span>                ids </span><span style=color:#81a1c1>= </span><span>[item[</span><span style=color:#a3be8c>"id"</span><span>] </span><span style=color:#81a1c1>for </span><span>item </span><span style=color:#81a1c1>in </span><span>chunk]
</span><span>                </span><span style=color:#81a1c1>try</span><span>:
</span><span>                    </span><span style=color:#81a1c1>await </span><span>session</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>execute_write</span><span>(build_query</span><span style=color:#eceff4>, </span><span>chunk)
</span><span>                    </span><span style=font-style:italic;color:#88c0d0>print</span><span>(</span><span style=color:#81a1c1>f</span><span style=color:#a3be8c>"Processed ids in range </span><span>{</span><span style=font-style:italic;color:#88c0d0>min</span><span>(ids)}</span><span style=color:#a3be8c>-</span><span>{</span><span style=font-style:italic;color:#88c0d0>max</span><span>(ids)}</span><span style=color:#a3be8c>"</span><span>)
</span><span>                </span><span style=color:#81a1c1>except </span><span style=color:#8fbcbb>Exception </span><span style=color:#81a1c1>as </span><span>e:
</span><span>                    </span><span style=font-style:italic;color:#88c0d0>print</span><span>(</span><span style=color:#81a1c1>f</span><span style=color:#a3be8c>"</span><span>{e}</span><span style=color:#a3be8c>: Failed to ingest IDs in range </span><span>{</span><span style=font-style:italic;color:#88c0d0>min</span><span>(ids)}</span><span style=color:#a3be8c>-</span><span>{</span><span style=font-style:italic;color:#88c0d0>max</span><span>(ids)}</span><span style=color:#a3be8c>"</span><span>)
</span></code></pre></div><p>By just adding a few await keywords, and replacing <code>def</code> with <code>async def</code>, we have clean, readable code that can communicate with the Neo4j database asynchronously! The async <code>main</code> function is then simply invoked with an <code>asyncio.run(main())</code> command. ğŸš€<h4 id=async-run-time-for-full-data-ingestion>Async run time for full data ingestion<a aria-label="Anchor link for: async-run-time-for-full-data-ingestion" class=zola-anchor href=#async-run-time-for-full-data-ingestion>#</a></h4><div class=codeblock-with-filename><div class=filename>bash</div><pre class=language-bash data-lang=bash style=background:#2e3440;color:#d8dee9><code class=language-bash data-lang=bash><span style=color:#88c0d0>$</span><span> python bulk_ingest_async.py
</span><span style=color:#88c0d0>Validating</span><span> data...
</span><span style=color:#88c0d0>Elapsed</span><span> time: 2.9732 seconds
</span><span style=color:#88c0d0>Ingesting</span><span> data...
</span><span style=color:#88c0d0>Processed</span><span> ids in range 1-10000
</span><span style=color:#88c0d0>Processed</span><span> ids in range 10001-20000
</span><span style=color:#88c0d0>Processed</span><span> ids in range 20001-30000
</span><span style=color:#88c0d0>Processed</span><span> ids in range 30001-40000
</span><span style=color:#88c0d0>Processed</span><span> ids in range 40001-50000
</span><span style=color:#88c0d0>Processed</span><span> ids in range 50001-60000
</span><span style=color:#88c0d0>Processed</span><span> ids in range 60001-70000
</span><span style=color:#88c0d0>Processed</span><span> ids in range 70001-80000
</span><span style=color:#88c0d0>Processed</span><span> ids in range 80001-90000
</span><span style=color:#88c0d0>Processed</span><span> ids in range 90001-100000
</span><span style=color:#88c0d0>Processed</span><span> ids in range 100001-110000
</span><span style=color:#88c0d0>Processed</span><span> ids in range 110001-120000
</span><span style=color:#88c0d0>Processed</span><span> ids in range 120001-129971
</span><span style=color:#88c0d0>Elapsed</span><span> time: 6.0603 seconds
</span><span style=color:#88c0d0>Finished</span><span> execution!
</span></code></pre></div><p>Just like in the sync case, the Pydantic validation for 130k records completes in ~3 sec, while the async data ingestion completes in ~6 seconds, giving us a roughly 9 second run time. Generally speaking, a coroutine-based async approach as shown above vastly outperforms the sync approach, but in this particular scenario, the async API offers only a marginal improvement. This is likely because, Neo4j doesnâ€™t asynchronously merge nodes/edges independently of one another to avoid race conditions in which the client may attempt to merge an edge to a node that doesnâ€™t yet exist in the graph.<blockquote class="callout question"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM11 15H13V17H11V15ZM13 13.3551V14H11V12.5C11 11.9477 11.4477 11.5 12 11.5C12.8284 11.5 13.5 10.8284 13.5 10C13.5 9.17157 12.8284 8.5 12 8.5C11.2723 8.5 10.6656 9.01823 10.5288 9.70577L8.56731 9.31346C8.88637 7.70919 10.302 6.5 12 6.5C13.933 6.5 15.5 8.067 15.5 10C15.5 11.5855 14.4457 12.9248 13 13.3551Z" fill=currentColor></path></svg></div><div class=content><p><strong>Question</strong><p><strong>Why use the async API?</strong><br> Although the performance difference in ingesting the full dataset between the sync and async APIs was negligible in this case, itâ€™s likely that in a real setting with a much larger dataset, there will be less overhead in communicating with the database, and if using Neo4j alongside an async-friendly framework with FastAPI, it helps to use the async API across the whole code base for readability and ease of maintenance.</div></blockquote><h2 id=inspect-the-graph-via-the-neo4j-browser>Inspect the graph via the Neo4j browser<a aria-label="Anchor link for: inspect-the-graph-via-the-neo4j-browser" class=zola-anchor href=#inspect-the-graph-via-the-neo4j-browser>#</a></h2><p>Check that all the nodes and edges are ingested into the graph as follows.<pre class=language-sql data-lang=sql style=background:#2e3440;color:#d8dee9><code class=language-sql data-lang=sql><span>MATCH (n) RETURN DISTINCT LABELS(n) </span><span style=color:#81a1c1>AS</span><span> nodeType, </span><span style=color:#88c0d0>COUNT</span><span>(n) </span><span style=color:#81a1c1>as</span><span> nodeCount
</span></code></pre><p>This returns the per-label count of nodes in the graph.<pre class=language-sh data-lang=sh style=background:#2e3440;color:#d8dee9><code class=language-sh data-lang=sh><span style=color:#88c0d0>â•’â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â••
</span><span style=color:#88c0d0>â”‚nodeType</span><span>    â”‚nodeCountâ”‚
</span><span style=color:#88c0d0>â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•¡
</span><span style=color:#88c0d0>â”‚[</span><span style=color:#a3be8c>"Wine"</span><span style=color:#88c0d0>]</span><span>    â”‚129971   â”‚
</span><span style=color:#88c0d0>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
</span><span style=color:#88c0d0>â”‚[</span><span style=color:#a3be8c>"Province"</span><span style=color:#88c0d0>]â”‚420</span><span>      â”‚
</span><span style=color:#88c0d0>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
</span><span style=color:#88c0d0>â”‚[</span><span style=color:#a3be8c>"Person"</span><span style=color:#88c0d0>]</span><span>  â”‚19       â”‚
</span><span style=color:#88c0d0>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
</span><span style=color:#88c0d0>â”‚[</span><span style=color:#a3be8c>"Country"</span><span style=color:#88c0d0>]</span><span> â”‚44       â”‚
</span><span style=color:#88c0d0>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></code></pre><p>Great! All the wine reviews (with each node representing a wine and its metadata) were ingested into the graph! We have 420 provinces around the world from which the wines originate, as well as 44 countries of origin in this dataset. There are also 19 human tasters.<p>Hereâ€™s another Cypher query showing the top-rated Italian wine varieties tasted by our pro, Roger Voss.<pre class=language-sql data-lang=sql style=background:#2e3440;color:#d8dee9><code class=language-sql data-lang=sql><span>MATCH (wine:Wine)</span><span style=color:#81a1c1>-</span><span>[:IS_FROM_COUNTRY]</span><span style=color:#81a1c1>-></span><span>(country:Country)
</span><span style=color:#81a1c1>WHERE </span><span>country.countryName </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>"Italy"
</span><span style=color:#81a1c1>WITH</span><span> wine, country
</span><span>MATCH (wine:Wine)</span><span style=color:#81a1c1>-</span><span>[:TASTED_BY]</span><span style=color:#81a1c1>-></span><span>(taster:Person)
</span><span style=color:#81a1c1>WHERE </span><span>taster.tasterName </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>"Roger Voss"
</span><span>RETURN
</span><span>    wine.wineID </span><span style=color:#81a1c1>AS</span><span> wineID,
</span><span>    wine.variety </span><span style=color:#81a1c1>AS</span><span> variety
</span><span>    wine.points </span><span style=color:#81a1c1>AS</span><span> points,
</span><span>    wine.title </span><span style=color:#81a1c1>AS</span><span> title
</span><span style=color:#81a1c1>ORDER BY</span><span> points </span><span style=color:#81a1c1>DESC LIMIT </span><span style=color:#b48ead>5
</span></code></pre><p>The following result is obtained:<pre class=language-sh data-lang=sh style=background:#2e3440;color:#d8dee9><code class=language-sh data-lang=sh><span style=color:#88c0d0>â•’â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â••
</span><span style=color:#88c0d0>â”‚wineIDâ”‚variety</span><span>     â”‚pointsâ”‚title                                                  â”‚
</span><span style=color:#88c0d0>â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¡
</span><span style=color:#88c0d0>â”‚81398</span><span> â”‚</span><span style=color:#a3be8c>"Sangiovese"</span><span>â”‚95    â”‚</span><span style=color:#a3be8c>"Talenti 1997  Brunello di Montalcino"</span><span>                 â”‚
</span><span style=color:#88c0d0>â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
</span><span style=color:#88c0d0>â”‚81399</span><span> â”‚</span><span style=color:#a3be8c>"Sangiovese"</span><span>â”‚94    â”‚</span><span style=color:#a3be8c>"Tenuta di Sesta 1997  Brunello di Montalcino"</span><span>         â”‚
</span><span style=color:#88c0d0>â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
</span><span style=color:#88c0d0>â”‚125783â”‚</span><span style=color:#a3be8c>"Tocai"</span><span>     â”‚93    â”‚</span><span style=color:#a3be8c>"Mario Schiopetto 2001 Tocai (Collio)"</span><span>                 â”‚
</span><span style=color:#88c0d0>â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
</span><span style=color:#88c0d0>â”‚81404</span><span> â”‚</span><span style=color:#a3be8c>"Sangiovese"</span><span>â”‚93    â”‚</span><span style=color:#a3be8c>"Biondi Santi 1997 Il Greppo  (Brunello di Montalcino)"</span><span>â”‚
</span><span style=color:#88c0d0>â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
</span><span style=color:#88c0d0>â”‚81403</span><span> â”‚</span><span style=color:#a3be8c>"Sangiovese"</span><span>â”‚93    â”‚</span><span style=color:#a3be8c>"La Gerla 1997  Brunello di Montalcino"</span><span>                â”‚
</span><span style=color:#88c0d0>â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></code></pre><p>The graph schema modelled is also easy to output in Neo4j:<pre class=language-sql data-lang=sql style=background:#2e3440;color:#d8dee9><code class=language-sql data-lang=sql><span>CALL db.schema.visualization
</span></code></pre><figure><img loading=lazy src=schema.svg></figure><p>This is exactly the same as the sketch <a href=https://thedataquarry.github.io/posts/neo4j-python-1/#the-graph-data-model>shown earlier</a>.<h2 id=conclusions>Conclusions<a aria-label="Anchor link for: conclusions" class=zola-anchor href=#conclusions>#</a></h2><p>Whew, there was a lot covered in this post! As described, itâ€™s quite simple to build an efficient and maintainable bulk-insert workflow for Neo4j using just Python as the gluing language. Either the sync or async APIs of the <a rel="nofollow noreferrer" href=https://github.com/neo4j/neo4j-python-driver>Neo4j Python client</a> can be used. This official client, maintained by the folks at Neo4j, is under continuous development and is actively maintained, so hopefully, this post gave a useful introduction on how to use it effectively.<p>In a future post, Iâ€™ll describe how I typically build custom query APIs using FastAPI on top of the Neo4j graph, to provide results to front end client downstream. Till next time!<h2 id=code>Code<a aria-label="Anchor link for: code" class=zola-anchor href=#code>#</a></h2><p>All code shown in this post <a rel="nofollow noreferrer" href=https://github.com/prrao87/neo4j-python-fastapi>is available on GitHub</a>.</article><div class=giscus></div><script async crossorigin data-category=General data-category-id=DIC_kwDOKyWhTs4CbUSt data-emit-metadata=0 data-input-position=bottom data-lang=en data-loading=lazy data-mapping=pathname data-reactions-enabled=1 data-repo=thedataquarry/thedataquarry.github.io data-repo-id=R_kgDOKyWhTg data-strict=0 data-theme=preferred_color_scheme src=https://giscus.app/client.js></script></div><footer><div class=copyright><p>Â© 2024 Prashanth Rao</div><div class=credits>Powered by <a rel="noreferrer noopener" href=https://www.getzola.org target=_blank>zola</a> and <a rel="noreferrer noopener" href=https://github.com/isunjn/serene target=_blank>serene</a></div></footer></main></div><script src=/js/lightense.min.js></script><script src=/js/main.js></script>