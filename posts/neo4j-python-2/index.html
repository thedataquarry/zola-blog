<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="light dark" name=color-scheme><title>Neo4j for Pythonistas (2) | The Data Quarry</title><meta content="Neo4j for Pythonistas (2)" property=og:title><meta content="Prashanth Rao" name=author><meta content=en_US property=og:locale><meta content="Build a REST API on top of a Neo4j graph" name=description><meta content="Build a REST API on top of a Neo4j graph" property=og:description><link href=https://thedataquarry.github.io/posts/neo4j-python-2/ rel=canonical><meta content=https://thedataquarry.github.io/posts/neo4j-python-2/ property=og:url><meta content="The Data Quarry" property=og:site_name><meta content=https://thedataquarry.github.io/img/dataquarry-banner.png property=og:image><meta content=article property=og:type><meta content=2023-06-04T00:00:00+00:00 property=article:published_time><meta " content=summary_large_image name=twitter:card><meta content=https://thedataquarry.github.io/img/dataquarry-banner.png property=twitter:image><meta content="Neo4j for Pythonistas (2)" property=twitter:title><meta content=@tech_optimist name=twitter:site><meta content="Build a REST API on top of a Neo4j graph" name=description><title>Neo4j for Pythonistas (2)</title><link href=/img/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/img/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/img/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><style>body{--primary-color:#376dd9;--primary-pale-color:#698bcf1c;--inline-code-color:#444;--text-color:#444;--text-pale-color:#545967;--bg-color:#fff;--highlight-mark-color:#5f75b045;--callout-note-color:#3e70d6;--callout-important-color:#7a46cd;--callout-warning-color:#d3822b;--callout-alert-color:#d43f3f;--callout-question-color:#3089b5;--callout-tip-color:#35a06b;--main-font:"IBMPlexSans",ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--code-font:"IBMPlexMono",ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--homepage-max-width:750px;--main-max-width:750px;--avatar-size:175px;--paragraph-font-size:16px;--paragraph-line-height:1.5em;--aside-font-size:16px;--img-border-radius:4px;--inline-code-border-radius:2px}body.dark{--primary-color:#689afd;--primary-pale-color:#93acdd1c;--inline-code-color:#d2d2d2;--text-color:#ddd;--text-pale-color:#a0a0a0;--bg-color:#202124;--highlight-mark-color:#5f75b045;--callout-note-color:#698bcf;--callout-important-color:#9374c5;--callout-warning-color:#c99054;--callout-alert-color:#d35757;--callout-question-color:#5091b2;--callout-tip-color:#3ea06f}</style><link href=/main.css rel=stylesheet><script async data-website-id=01228822-c189-4b8a-93ba-733d045bf346 src=https://analytics.eu.umami.is/script.js></script><body class=post><script>if(localStorage.getItem('theme')=='dark'){document.body.classList.add('dark');const a=document.querySelector('link#hl');if(a)a.href='/hl-dark.css'}</script><header class=blur><div id=header-wrapper><nav><a href=/>The Data Quarry</a><button aria-label="toggle expand" class=separator id=toggler>::</button><span class="wrap left fold">{</span><a href=/posts>blog</a><span class="wrap-separator fold">,</span><a class=fold href=/talks>talks</a><span class="wrap-separator fold">,</span><a class=fold href=/projects>projects</a><span class="wrap right fold">} ;</span></nav><div id=btns><a rel="noreferrer noopener" aria-label=GitHub href=https://github.com/prrao87 target=_blank> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12" fill=currentColor></path></svg> </a><a rel="noreferrer noopener" aria-label=Twitter href=https://twitter.com/tech_optimist target=_blank> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>Twitter</title><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z" fill=currentColor></path></svg> </a><a rel="noreferrer noopener" aria-label=LinkedIn href=https://www.linkedin.com/in/prrao87 target=_blank> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z" fill=currentColor></path></svg> </a><a aria-label="Buy me a coffee" rel="noreferrer noopener" href=https://www.buymeacoffee.com/prrao87 target=_blank> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>Buy Me A Coffee</title><path d="M20.216 6.415l-.132-.666c-.119-.598-.388-1.163-1.001-1.379-.197-.069-.42-.098-.57-.241-.152-.143-.196-.366-.231-.572-.065-.378-.125-.756-.192-1.133-.057-.325-.102-.69-.25-.987-.195-.4-.597-.634-.996-.788a5.723 5.723 0 00-.626-.194c-1-.263-2.05-.36-3.077-.416a25.834 25.834 0 00-3.7.062c-.915.083-1.88.184-2.75.5-.318.116-.646.256-.888.501-.297.302-.393.77-.177 1.146.154.267.415.456.692.58.36.162.737.284 1.123.366 1.075.238 2.189.331 3.287.37 1.218.05 2.437.01 3.65-.118.299-.033.598-.073.896-.119.352-.054.578-.513.474-.834-.124-.383-.457-.531-.834-.473-.466.074-.96.108-1.382.146-1.177.08-2.358.082-3.536.006a22.228 22.228 0 01-1.157-.107c-.086-.01-.18-.025-.258-.036-.243-.036-.484-.08-.724-.13-.111-.027-.111-.185 0-.212h.005c.277-.06.557-.108.838-.147h.002c.131-.009.263-.032.394-.048a25.076 25.076 0 013.426-.12c.674.019 1.347.067 2.017.144l.228.031c.267.04.533.088.798.145.392.085.895.113 1.07.542.055.137.08.288.111.431l.319 1.484a.237.237 0 01-.199.284h-.003c-.037.006-.075.01-.112.015a36.704 36.704 0 01-4.743.295 37.059 37.059 0 01-4.699-.304c-.14-.017-.293-.042-.417-.06-.326-.048-.649-.108-.973-.161-.393-.065-.768-.032-1.123.161-.29.16-.527.404-.675.701-.154.316-.199.66-.267 1-.069.34-.176.707-.135 1.056.087.753.613 1.365 1.37 1.502a39.69 39.69 0 0011.343.376.483.483 0 01.535.53l-.071.697-1.018 9.907c-.041.41-.047.832-.125 1.237-.122.637-.553 1.028-1.182 1.171-.577.131-1.165.2-1.756.205-.656.004-1.31-.025-1.966-.022-.699.004-1.556-.06-2.095-.58-.475-.458-.54-1.174-.605-1.793l-.731-7.013-.322-3.094c-.037-.351-.286-.695-.678-.678-.336.015-.718.3-.678.679l.228 2.185.949 9.112c.147 1.344 1.174 2.068 2.446 2.272.742.12 1.503.144 2.257.156.966.016 1.942.053 2.892-.122 1.408-.258 2.465-1.198 2.616-2.657.34-3.332.683-6.663 1.024-9.995l.215-2.087a.484.484 0 01.39-.426c.402-.078.787-.212 1.074-.518.455-.488.546-1.124.385-1.766zm-1.478.772c-.145.137-.363.201-.578.233-2.416.359-4.866.54-7.308.46-1.748-.06-3.477-.254-5.207-.498-.17-.024-.353-.055-.47-.18-.22-.236-.111-.71-.054-.995.052-.26.152-.609.463-.646.484-.057 1.046.148 1.526.22.577.088 1.156.159 1.737.212 2.48.226 5.002.19 7.472-.14.45-.06.899-.13 1.345-.21.399-.072.84-.206 1.08.206.166.281.188.657.162.974a.544.544 0 01-.169.364zm-6.159 3.9c-.862.37-1.84.788-3.109.788a5.884 5.884 0 01-1.569-.217l.877 9.004c.065.78.717 1.38 1.5 1.38 0 0 1.243.065 1.658.065.447 0 1.786-.065 1.786-.065.783 0 1.434-.6 1.499-1.38l.94-9.95a3.996 3.996 0 00-1.322-.238c-.826 0-1.491.284-2.26.613z" fill=currentColor></path></svg> </a><button aria-label="theme switch" data-moon-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill="currentColor"></path></svg>' data-sun-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12C18 15.3137 15.3137 18 12 18ZM12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM11 1H13V4H11V1ZM11 20H13V23H11V20ZM3.51472 4.92893L4.92893 3.51472L7.05025 5.63604L5.63604 7.05025L3.51472 4.92893ZM16.9497 18.364L18.364 16.9497L20.4853 19.0711L19.0711 20.4853L16.9497 18.364ZM19.0711 3.51472L20.4853 4.92893L18.364 7.05025L16.9497 5.63604L19.0711 3.51472ZM5.63604 16.9497L7.05025 18.364L4.92893 20.4853L3.51472 19.0711L5.63604 16.9497ZM23 11V13H20V11H23ZM4 11V13H1V11H4Z" fill="currentColor"></path></svg>' id=theme-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill=currentColor></path></svg></button><button aria-label="table of content" id=toc-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M3 4H21V6H3V4ZM3 11H15V13H3V11ZM3 18H21V20H3V18Z" fill=currentColor></path></svg></button></div></div></header><div id=wrapper><div id=blank></div><aside class=blur><nav><ul><li><a class=h2 href=#build-a-restful-api-on-top-of-a-neo4j-graph>Build a RESTful API on top of a Neo4j graph</a> <ul><li><a class=h3 href=#why-build-a-rest-api>Why build a REST API?</a></ul><li><a class=h2 href=#a-quick-recap-on-the-data>A quick recap on the data</a><li><a class=h2 href=#building-the-rest-api>Building the REST API</a> <ul><li><a class=h3 href=#run-the-api-and-database-via-docker>Run the API and database via Docker</a><li><a class=h3 href=#create-an-async-lifespan>Create an async lifespan</a><li><a class=h3 href=#create-routers>Create routers</a><li><a class=h3 href=#attach-endpoints-in-the-router-to-main-py>Attach endpoints in the router to main.py</a><li><a class=h3 href=#test-endpoint>Test endpoint</a><li><a class=h3 href=#extend-the-api>Extend the API</a><li><a class=h3 href=#api-docs>API docs</a></ul><li><a class=h2 href=#conclusions>Conclusions</a> <ul><li><a class=h3 href=#benefits-of-fastapi-and-apis-in-general>Benefits of FastAPI and APIs in general</a><li><a class=h3 href=#a-common-downside-to-rest-apis>A common downside to REST APIs</a></ul><li><a class=h2 href=#code>Code</a><li><a class=h2 href=#additional-learning>Additional learning</a></ul></nav><button aria-label="back to top" id=back-to-top><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M11.9997 10.8284L7.04996 15.7782L5.63574 14.364L11.9997 8L18.3637 14.364L16.9495 15.7782L11.9997 10.8284Z" fill=currentColor></path></svg></button></aside><main><div><div data-check-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z" fill="currentColor"></path></svg>' data-copy-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill="currentColor"></path></svg>' id=copy-cfg style=display:none></div><article data-backlink-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M9.41421 8L18.0208 16.6066L16.6066 18.0208L8 9.41421V17H6V6H17V8H9.41421Z" fill="currentColor"></path></svg>' class=prose><h1>Neo4j for Pythonistas (2)</h1><div id=post-info><div id=date><span id=publish>2023-06-04</span></div><div id=tags><a href=https://thedataquarry.github.io/tags/neo4j><span>#</span>neo4j</a><a href=https://thedataquarry.github.io/tags/async><span>#</span>async</a><a href=https://thedataquarry.github.io/tags/graph-db><span>#</span>graph-db</a></div></div><h2 id=build-a-restful-api-on-top-of-a-neo4j-graph>Build a RESTful API on top of a Neo4j graph<a aria-label="Anchor link for: build-a-restful-api-on-top-of-a-neo4j-graph" class=zola-anchor href=#build-a-restful-api-on-top-of-a-neo4j-graph>#</a></h2><p>This is the second part of a series on Neo4j for Pythonistas, in which we will go through an end-to-end workflow to build and analyze graph data in Neo4j using Python. <a rel="nofollow noreferrer" href=https://prrao87.github.io/posts/neo4j-python-1/>Part 1 of this series</a> covered what the data was, how it was validated in Pydantic, and how it was ingested into Neo4j. If all of that is familiar to you, read on!<blockquote class="callout note"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM11 7H13V9H11V7ZM11 11H13V17H11V11Z" fill=currentColor></path></svg></div><div class=content><p>If you like reading code and want to directly see the FastAPI codebase for this post, go to <code>src/api</code> <a rel="nofollow noreferrer" href=https://github.com/prrao87/neo4j-python-fastapi/tree/main>in the source repo</a>.</div></blockquote><h3 id=why-build-a-rest-api>Why build a REST API?<a aria-label="Anchor link for: why-build-a-rest-api" class=zola-anchor href=#why-build-a-rest-api>#</a></h3><p>Data engineers typically build data-handling and ETL pipelines to ingest large amounts of data into a database. However, for the true value of the data to be realized, it’s also important that the data is made available to end users (i.e., “consumers”) in the most convenient way possible. In most cases, the consumer would be a front-end or full stack developer responsible for building a client-facing application for a business case. An API layer that sits between the database (server) and the front end (client) application is ideally suited for this purpose – it allows a database/backend engineer to ensure that the data being stored is being queried, and most importantly, <em>served</em> to the client as necessary to deliver the most value to the business unit that builds the application.<figure><img loading=lazy src=api_design.jpeg></figure><h2 id=a-quick-recap-on-the-data>A quick recap on the data<a aria-label="Anchor link for: a-quick-recap-on-the-data" class=zola-anchor href=#a-quick-recap-on-the-data>#</a></h2><p>As described in <a rel="nofollow noreferrer" href=https://thedataquarry.com/posts/neo4j-python-1/>part 1 of this series</a>, we’re working with a dataset of 130k wine reviews ingested as a graph into Neo4j. A sample wine review is shown below.<pre class=language-json data-lang=json style=background:#2e3440;color:#d8dee9><code class=language-json data-lang=json><span>{
</span><span>    </span><span style=color:#a3be8c>"points"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"90"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"title"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Castello San Donato in Perano 2009 Riserva  (Chianti Classico)"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"description"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Made from a blend of 85% Sangiovese and 15% Merlot, this ripe wine delivers soft plum, black currants, clove and cracked pepper sensations accented with coffee and espresso notes. A backbone of firm tannins give structure. Drink now through 2019."</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"taster_name"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Kerin O'Keefe"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"taster_twitter_handle"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"@kerinokeefe"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"price"</span><span style=color:#eceff4>: </span><span style=color:#b48ead>30</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"designation"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Riserva"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"variety"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Red Blend"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"region_1"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Chianti Classico"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"region_2"</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>null</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"province"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Tuscany"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"country"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Italy"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"winery"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Castello San Donato in Perano"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"id"</span><span style=color:#eceff4>: </span><span style=color:#b48ead>40825
</span><span>}
</span></code></pre><p>The graph data model used is a simple one, for the purposes of this blog post.<figure><img loading=lazy src=schema.svg></figure><p>A <code>:Wine</code> is from a province and a country, with the province itself belonging to a country. In addition, a <code>:Person</code> (who is a wine reviewer) tastes each wine and rates it for the review.<h2 id=building-the-rest-api>Building the REST API<a aria-label="Anchor link for: building-the-rest-api" class=zola-anchor href=#building-the-rest-api>#</a></h2><p>Once the data is ingested into Neo4j (see <a rel="nofollow noreferrer" href=https://thedataquarry.com/posts/neo4j-python-1/>part 1</a> regarding sync and async methods to ingest data via Python), we can proceed to build an API layer on top of the database. As is most common these days, <a rel="nofollow noreferrer" href=https://fastapi.tiangolo.com>FastAPI</a> is the framework used to build performance, async-friendly APIs in Python. Note that all code in the following sections is available <a rel="nofollow noreferrer" href=https://github.com/prrao87/neo4j-python-fastapi>here</a>.<h3 id=run-the-api-and-database-via-docker>Run the API and database via Docker<a aria-label="Anchor link for: run-the-api-and-database-via-docker" class=zola-anchor href=#run-the-api-and-database-via-docker>#</a></h3><p>The <code>docker-compose.yml</code> <a rel="nofollow noreferrer" href=https://github.com/prrao87/neo4j-python-fastapi>provided</a> initiates two separate services that run in their own containers: one that runs Neo4j, and another one that serves a REST API (written in FastAPI) on top of the database.<pre class=language-sh data-lang=sh style=background:#2e3440;color:#d8dee9><code class=language-sh data-lang=sh><span style=color:#88c0d0>docker</span><span> compose up -d
</span></code></pre><p>This compose file starts a persistent-volume Neo4j database with credentials specified in <code>.env</code>. Both containers can communicate with one another with the common network that they share, on the exact port numbers specified in the environment file.<p>The services can be stopped at any time using the following command.<pre class=language-sh data-lang=sh style=background:#2e3440;color:#d8dee9><code class=language-sh data-lang=sh><span style=color:#88c0d0>docker</span><span> compose down
</span></code></pre><p>Opening <code>http://localhost:8000</code> should display a message as shown below on the browser.<pre class=language-json data-lang=json style=background:#2e3440;color:#d8dee9><code class=language-json data-lang=json><span style=color:#a3be8c>"message"</span><span>: </span><span style=color:#a3be8c>"REST API for querying Neo4j database of 130k wine reviews from the Wine Enthusiast magazine"
</span></code></pre><p>We’re all set to build out our Neo4j database connection!<h3 id=create-an-async-lifespan>Create an async lifespan<a aria-label="Anchor link for: create-an-async-lifespan" class=zola-anchor href=#create-an-async-lifespan>#</a></h3><p>FastAPI <code>0.95.0</code> introduced a cleaner, simpler interface to set up async interfaces to databases. This is done by using the <code>asynccontextmanager</code> decorator available as part of the <code>contextlib</code> standard library in Python.<div class=codeblock-with-filename><div class=filename>python</div><pre class=language-python data-lang=python style=background:#2e3440;color:#d8dee9><code class=language-python data-lang=python><span style=color:#81a1c1>from </span><span>contextlib </span><span style=color:#81a1c1>import </span><span>asynccontextmanager
</span><span>
</span><span style=color:#d08770>@</span><span>asynccontextmanager
</span><span style=color:#81a1c1>async def </span><span style=color:#88c0d0>lifespan</span><span>(app</span><span style=color:#eceff4>: </span><span>FastAPI) </span><span style=color:#eceff4>-> </span><span>AsyncGenerator[</span><span style=color:#81a1c1>None</span><span>, </span><span style=color:#81a1c1>None</span><span>]:
</span><span>    </span><span style=color:#616e88>"""Async context manager for Neo4j connection."""
</span><span>    </span><span style=color:#81a1c1>URI = </span><span style=color:#a3be8c>"bolt://neo4j:7687"
</span><span>    </span><span style=color:#81a1c1>AUTH = </span><span>(</span><span style=color:#a3be8c>"neo4j"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"password"</span><span>)
</span><span>    </span><span style=color:#81a1c1>async with </span><span>AsyncGraphDatabase</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>driver</span><span>(</span><span style=color:#81a1c1>URI</span><span style=color:#eceff4>, </span><span>auth</span><span style=color:#81a1c1>=AUTH</span><span>) </span><span style=color:#81a1c1>as </span><span>driver:
</span><span>        </span><span style=color:#81a1c1>async with </span><span>driver</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>session</span><span>(database</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>"neo4j"</span><span>) </span><span style=color:#81a1c1>as </span><span>session:
</span><span>            app</span><span style=color:#81a1c1>.</span><span>session </span><span style=color:#81a1c1>= </span><span>session
</span><span>            </span><span style=font-style:italic;color:#88c0d0>print</span><span>(</span><span style=color:#a3be8c>"Successfully connected to wine reviews Neo4j DB"</span><span>)
</span><span>            </span><span style=color:#81a1c1>yield
</span><span>            </span><span style=font-style:italic;color:#88c0d0>print</span><span>(</span><span style=color:#a3be8c>"Successfully closed wine reviews Neo4j connection"</span><span>)
</span><span>
</span><span>
</span><span>app </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>FastAPI</span><span>(lifespan</span><span style=color:#81a1c1>=</span><span>lifespan)
</span><span>
</span><span style=color:#616e88># Define routes below
</span><span style=color:#616e88># ...
</span></code></pre></div><p>Note that the URI for the Neo4j browser isn’t <code>localhost</code> as is normally the case we specify <code>bolt://neo4j:7687</code> in this case. This basically says “Connect to the <code>neo4j</code> container using the Bolt protocol via port 7687”. This is because, as per <a rel="nofollow noreferrer" href=https://thedataquarry.com/posts/neo4j-python-1/>part 1</a> of this series, we initiated the database via Docker. The <a rel="nofollow noreferrer" href=https://github.com/prrao87/neo4j-python-fastapi/blob/main/docker-compose.yml><code>docker-compose.yml</code></a> file shows how we composed two separate services: one for the Neo4j database, and another for the FastAPI server, both running in their own containers within a shared network <code>wine</code>. The container running the FastAPI service is named <code>neo4j</code>, which is why the URI is specified the way it is.<blockquote class="callout note"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM11 7H13V9H11V7ZM11 11H13V17H11V11Z" fill=currentColor></path></svg></div><div class=content><p><strong>Note</strong><p>In earlier versions of FastAPI (prior to <code>v0.95.0</code>), it was common to define an event-based logic for managing database connections, using the <code>@app.on_event("startup")</code> and <code>@app.on_event("shutdown")</code> decorators <a rel="nofollow noreferrer" href=https://fastapi.tiangolo.com/advanced/events/#startup-event>as described in the docs</a>. However, this has since been deprecated, and the <code>lifespan</code> object is the recommended method to manage DB connections in FastAPI, especially for asynchronous connections.</div></blockquote><h3 id=create-routers>Create routers<a aria-label="Anchor link for: create-routers" class=zola-anchor href=#create-routers>#</a></h3><p><a rel="nofollow noreferrer" href=https://fastapi.tiangolo.com/tutorial/bigger-applications/>As mentioned in the FastAPI docs</a>, there are multiple ways to structure your application directories. There’s no one “right” way to structure a large application with multiple end points, but, after some experimenting, I find that the structure shown below works really well for a variety of use cases, allowing for easy extensibility by myself or other developers.<pre class=language-sh data-lang=sh style=background:#2e3440;color:#d8dee9><code class=language-sh data-lang=sh><span style=color:#88c0d0>└──</span><span> src
</span><span>    </span><span style=color:#88c0d0>└──</span><span> api
</span><span>        </span><span style=color:#88c0d0>├──</span><span> routers
</span><span>        </span><span style=color:#81a1c1>|    </span><span style=color:#88c0d0>└──</span><span> rest.py
</span><span>        </span><span style=color:#88c0d0>├──</span><span> schemas
</span><span>        </span><span style=color:#81a1c1>|    </span><span style=color:#88c0d0>└──</span><span> wine.py
</span><span>        </span><span style=color:#88c0d0>├──</span><span> __init__.py
</span><span>        </span><span style=color:#88c0d0>└──</span><span> main.py
</span></code></pre><p>In FastAPI terminology, a “route” is a pathway to a set of endpoints that answer specific kinds of queries – these are grouped together and stored under the <code>routers</code> directory. FastAPI relies on Pydantic for model validation, so, just like in the case with data ingestion, we specify a REST schema in the <code>schemas</code> directory.<p>The <code>rest.py</code> router file contains the following general layout.<pre class=language-python data-lang=python style=background:#2e3440;color:#d8dee9><code class=language-python data-lang=python><span style=color:#81a1c1>from </span><span>fastapi </span><span style=color:#81a1c1>import </span><span>APIRouter</span><span style=color:#eceff4>, </span><span>HTTPException</span><span style=color:#eceff4>, </span><span>Query</span><span style=color:#eceff4>, </span><span>Request
</span><span style=color:#81a1c1>from </span><span>neo4j </span><span style=color:#81a1c1>import </span><span>AsyncManagedTransaction
</span><span style=color:#81a1c1>from </span><span>src</span><span style=color:#81a1c1>.</span><span>schemas</span><span style=color:#81a1c1>.</span><span>response </span><span style=color:#81a1c1>import </span><span>ResponseModel
</span><span>
</span><span>router </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>APIRouter</span><span>()
</span><span>
</span><span style=color:#616e88># --- Routes ---
</span><span>
</span><span style=color:#d08770>@</span><span>router</span><span style=color:#81a1c1>.</span><span>get(</span><span style=color:#a3be8c>"/search"</span><span style=color:#eceff4>, </span><span>response_model</span><span style=color:#81a1c1>=</span><span>ResponseModel)
</span><span style=color:#81a1c1>async def </span><span style=color:#88c0d0>search_by_keywords</span><span>(
</span><span>    request</span><span style=color:#eceff4>: </span><span>Request</span><span style=color:#eceff4>,
</span><span>    terms</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str</span><span style=color:#eceff4>,
</span><span>    max_price</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>float = </span><span style=color:#b48ead>100</span><span style=color:#eceff4>.</span><span style=color:#b48ead>0
</span><span>) </span><span style=color:#eceff4>-> </span><span style=color:#81a1c1>list</span><span>[ResponseModel] </span><span style=color:#81a1c1>| None</span><span>:
</span><span>    session </span><span style=color:#81a1c1>= </span><span>request</span><span style=color:#81a1c1>.</span><span>app</span><span style=color:#81a1c1>.</span><span>session
</span><span>    result </span><span style=color:#81a1c1>= await </span><span>session</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>execute_read</span><span>(_search_by_keywords</span><span style=color:#eceff4>, </span><span>terms</span><span style=color:#eceff4>, </span><span>max_price)
</span><span>    </span><span style=color:#81a1c1>if not </span><span>result:
</span><span>        </span><span style=color:#81a1c1>raise </span><span style=color:#88c0d0>HTTPException</span><span>(
</span><span>            status_code</span><span style=color:#81a1c1>=</span><span style=color:#b48ead>404</span><span style=color:#eceff4>,
</span><span>            detail</span><span style=color:#81a1c1>=f</span><span style=color:#a3be8c>"No wine with the provided terms '</span><span>{terms}</span><span style=color:#a3be8c>' found in database - please try again"</span><span style=color:#eceff4>,
</span><span>        )
</span><span>    </span><span style=color:#81a1c1>return </span><span>result
</span><span>
</span><span>
</span><span style=color:#616e88># --- Neo4j query funcs ---
</span><span>
</span><span style=color:#81a1c1>async def </span><span style=color:#88c0d0>_search_by_keywords</span><span>(
</span><span>    tx</span><span style=color:#eceff4>: </span><span>AsyncManagedTransaction</span><span style=color:#eceff4>,
</span><span>    terms</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>str</span><span style=color:#eceff4>,
</span><span>    price</span><span style=color:#eceff4>: </span><span style=color:#81a1c1>float</span><span style=color:#eceff4>,
</span><span>) </span><span style=color:#eceff4>-> </span><span style=color:#81a1c1>list</span><span>[FullTextSearch] </span><span style=color:#81a1c1>| None</span><span>:
</span><span>    query </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>"""
</span><span style=color:#a3be8c>        CALL db.index.fulltext.queryNodes("searchText", $terms) YIELD node AS wine, score
</span><span style=color:#a3be8c>        WITH DISTINCT wine, score
</span><span style=color:#a3be8c>            MATCH (wine)-[:IS_FROM_COUNTRY]->(c:Country)
</span><span style=color:#a3be8c>            WHERE wine.price <= $price
</span><span style=color:#a3be8c>        RETURN
</span><span style=color:#a3be8c>            c.countryName AS country,
</span><span style=color:#a3be8c>            wine.wineID AS wineID,
</span><span style=color:#a3be8c>            wine.points AS points,
</span><span style=color:#a3be8c>            wine.title AS title,
</span><span style=color:#a3be8c>            wine.description AS description,
</span><span style=color:#a3be8c>            coalesce(wine.price, "Not available") AS price,
</span><span style=color:#a3be8c>            wine.variety AS variety,
</span><span style=color:#a3be8c>            wine.winery AS winery
</span><span style=color:#a3be8c>        ORDER BY score DESC, points DESC LIMIT 5
</span><span style=color:#a3be8c>    """
</span><span>    response </span><span style=color:#81a1c1>= await </span><span>tx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>run</span><span>(query</span><span style=color:#eceff4>, </span><span>terms</span><span style=color:#81a1c1>=</span><span>terms</span><span style=color:#eceff4>, </span><span>price</span><span style=color:#81a1c1>=</span><span>price)
</span><span>    result </span><span style=color:#81a1c1>= await </span><span>response</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>data</span><span>()
</span><span>    </span><span style=color:#81a1c1>if </span><span>result:
</span><span>        </span><span style=color:#81a1c1>return </span><span>[</span><span style=color:#88c0d0>FullTextSearch</span><span>(</span><span style=color:#81a1c1>**</span><span>r) </span><span style=color:#81a1c1>for </span><span>r </span><span style=color:#81a1c1>in </span><span>result]
</span><span>    </span><span style=color:#81a1c1>return None
</span></code></pre><p>Note the clear separation between the <em>endpoint</em> logic and the <em>query</em> logic. The initial portion of the file <code>rest.py</code> contains the definition of the endpoint query parameters, and the read query is executed via the FastAPI request’s database session object. Because FastAPI itself relies on Pydantic, a response model must be specified. For this example, the same directory that hosts the Pydantic schema for data ingestion is reused, but in practice, the schema directory from which the response model is called can reside at the same level as <code>main.py</code>.<p>The latter portion of <code>rest.py</code> contains the an example full text search query that queries the Neo4j database’s full text index with the user’s keyword terms.<p>More endpoints can be added this way, depending on the kinds of questions the end user may want to ask of the database.<h3 id=attach-endpoints-in-the-router-to-main-py>Attach endpoints in the router to <code>main.py</code><a aria-label="Anchor link for: attach-endpoints-in-the-router-to-main-py" class=zola-anchor href=#attach-endpoints-in-the-router-to-main-py>#</a></h3><p>We can then attach the endpoints in the router defined in <code>rest.py</code> to the FastAPI server in <code>main.py</code> below the lifespan object specification as follows:<pre class=language-py data-lang=py style=background:#2e3440;color:#d8dee9><code class=language-py data-lang=py><span>
</span><span>app </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>FastAPI</span><span>(lifespan</span><span style=color:#81a1c1>=</span><span>lifespan)
</span><span>
</span><span style=color:#616e88># Attach routes
</span><span>app</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>include_router</span><span>(rest</span><span style=color:#81a1c1>.</span><span>router</span><span style=color:#eceff4>, </span><span>prefix</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>"/v1/rest"</span><span style=color:#eceff4>, </span><span>tags</span><span style=color:#81a1c1>=</span><span>[</span><span style=color:#a3be8c>"rest"</span><span>])
</span></code></pre><p>As per the statement above, we serve the endpoints for the REST API with the route prefix <code>/v1/rest</code>, so the endpoint can be reached at the following URL:<pre style=background:#2e3440;color:#d8dee9><code><span>https://localhost:8000/v1/rest/search
</span></code></pre><blockquote class="callout tip"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M9.97308 18H11V13H13V18H14.0269C14.1589 16.7984 14.7721 15.8065 15.7676 14.7226C15.8797 14.6006 16.5988 13.8564 16.6841 13.7501C17.5318 12.6931 18 11.385 18 10C18 6.68629 15.3137 4 12 4C8.68629 4 6 6.68629 6 10C6 11.3843 6.46774 12.6917 7.31462 13.7484C7.40004 13.855 8.12081 14.6012 8.23154 14.7218C9.22766 15.8064 9.84103 16.7984 9.97308 18ZM10 20V21H14V20H10ZM5.75395 14.9992C4.65645 13.6297 4 11.8915 4 10C4 5.58172 7.58172 2 12 2C16.4183 2 20 5.58172 20 10C20 11.8925 19.3428 13.6315 18.2443 15.0014C17.624 15.7748 16 17 16 18.5V21C16 22.1046 15.1046 23 14 23H10C8.89543 23 8 22.1046 8 21V18.5C8 17 6.37458 15.7736 5.75395 14.9992Z" fill=currentColor></path></svg></div><div class=content><p><strong>Tip</strong><p>It’s good practice to set a prefix to the router, for e.g., <code>/v1/rest</code> to indicate the version of the API and the fact that it’s a REST API. The version number specifies to users and developers which version of the API they are calling (in case there are breaking changes in the future).</div></blockquote><h3 id=test-endpoint>Test endpoint<a aria-label="Anchor link for: test-endpoint" class=zola-anchor href=#test-endpoint>#</a></h3><p>Pass a simple search query with the terms <code>tuscany red</code> with a max price of 50 to a cURL request as follows.<div class=codeblock-with-filename><div class=filename>bash</div><pre class=language-sh data-lang=sh style=background:#2e3440;color:#d8dee9><code class=language-sh data-lang=sh><span style=color:#88c0d0>curl</span><span> -X </span><span style=color:#a3be8c>'GET' </span><span style=color:#81a1c1>\
</span><span>  </span><span style=color:#a3be8c>'http://localhost:8000/v1/rest/search?terms=tuscany%20red&max_price=50'
</span></code></pre></div><p>The search terms and filter specified in the request are converted to a working Cypher query in the FastAPI router file. The query runs and retrieves results from a full text search index (that looks for these keywords in the title and variety of the sample).<pre class=language-json data-lang=json style=background:#2e3440;color:#d8dee9><code class=language-json data-lang=json><span>[
</span><span>    {
</span><span>        </span><span style=color:#a3be8c>"wineID"</span><span style=color:#eceff4>: </span><span style=color:#b48ead>66393</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"country"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Italy"</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"title"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Capezzana 1999 Ghiaie Della Furba Red (Tuscany)"</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"description"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Very much a baby, this is one big, bold, burly Cab-Merlot-Syrah blend that's filled to the brim with extracted plum fruit, bitter chocolate and earth. It takes a long time in the glass for it to lose its youthful, funky aromatics, and on the palate things are still a bit scattered. But in due time things will settle and integrate"</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"points"</span><span style=color:#eceff4>: </span><span style=color:#b48ead>90</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"price"</span><span style=color:#eceff4>: </span><span style=color:#b48ead>49</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"variety"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Red Blend"</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"winery"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Capezzana"
</span><span>    }</span><span style=color:#eceff4>,
</span><span>    {
</span><span>        </span><span style=color:#a3be8c>"wineID"</span><span style=color:#eceff4>: </span><span style=color:#b48ead>40960</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"country"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Italy"</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"title"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Fattoria di Grignano 2011 Pietramaggio Red (Toscana)"</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"description"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Here's a simple but well made red from Tuscany that has floral aromas of violet and rose with berry notes. The palate offers bright cherry, red currant and a touch of spice. Pair this with pasta dishes or grilled vegetables."</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"points"</span><span style=color:#eceff4>: </span><span style=color:#b48ead>86</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"price"</span><span style=color:#eceff4>: </span><span style=color:#b48ead>11</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"variety"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Red Blend"</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"winery"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Fattoria di Grignano"
</span><span>    }</span><span style=color:#eceff4>,
</span><span>    {
</span><span>        </span><span style=color:#a3be8c>"wineID"</span><span style=color:#eceff4>: </span><span style=color:#b48ead>73595</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"country"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Italy"</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"title"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"I Giusti e Zanza 2011 Belcore Red (Toscana)"</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"description"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"With aromas of violet, tilled soil and red berries, this blend of Sangiovese and Merlot recalls sunny Tuscany. It's loaded with wild cherry flavors accented by white pepper, cinnamon and vanilla. The palate is uplifted by vibrant acidity and fine tannins."</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"points"</span><span style=color:#eceff4>: </span><span style=color:#b48ead>89</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"price"</span><span style=color:#eceff4>: </span><span style=color:#b48ead>27</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"variety"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Red Blend"</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"winery"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"I Giusti e Zanza"
</span><span>    }
</span><span>]
</span></code></pre><p>Not bad! This example correctly returns some highly rated Tuscan red wines along with their price and country of origin, Italy.<h3 id=extend-the-api>Extend the API<a aria-label="Anchor link for: extend-the-api" class=zola-anchor href=#extend-the-api>#</a></h3><p>With this design, the REST API can be easily extended to add more functionality and endpoints as needed. It’s generally good practice to organize endpoints that are related to a particular functionality in a single file, and then reference the router by its name in <code>main.py</code>.<ul><li>The <code>schemas</code> directory houses the Pydantic schemas, both for the data input as well as for the endpoint outputs <ul><li>As the data model gets more complex, we can add more files and separate the ingestion logic from the API logic here</ul><li>The <code>api/routers</code> directory contains the endpoint routes so that we can provide additional endpoint that answer more business questions <ul><li>For e.g.: “What are the top rated wines from Argentina?”<li>In general, it makes sense to organize specific business use cases into their own router files</ul><li>The <code>api/main.py</code> file collects all the routes and schemas to run the API</ul><h3 id=api-docs>API docs<a aria-label="Anchor link for: api-docs" class=zola-anchor href=#api-docs>#</a></h3><p>The great thing about FastAPI is that you get API docs for free, via the OpenAPI spec. With the Docker containers up and running, navigate to <code>localhost:8000/docs</code> to see the existing endpoints defined in this example.<figure><img loading=lazy src=api_docs.png></figure><h2 id=conclusions>Conclusions<a aria-label="Anchor link for: conclusions" class=zola-anchor href=#conclusions>#</a></h2><p>Building a FastAPI app on top of a Neo4j database can be a lot of fun, once you know the basics! Although a lot of the content in this post requires a bit of prior knowledge of how APIs work, the REST spec, etc., it’s easy to appreciate why exposing the data in your graph database via a REST API makes a lot of sense. Developing using Docker also makes the entire process much more reproducible and easier to debug.<h3 id=benefits-of-fastapi-and-apis-in-general>Benefits of FastAPI and APIs in general<a aria-label="Anchor link for: benefits-of-fastapi-and-apis-in-general" class=zola-anchor href=#benefits-of-fastapi-and-apis-in-general>#</a></h3><ul><li><strong>Ease of transmission</strong>: The API acts as a bridge between the query layer (Cypher) and the user (front-end), so your end users don’t need to know any Cypher to get the data they want!<li><strong>Scalability</strong>: As the number of users sending queries to the graph increases, frameworks like FastAPI efficiently handle async connections, best utilizing your CPU resources in a non-blocking manner<li><strong>Security</strong>: Rather than exposing the database to anybody out there, FastAPI provides <a rel="nofollow noreferrer" href=https://fastapi.tiangolo.com/tutorial/middleware/>middleware options</a> and <a rel="nofollow noreferrer" href=https://fastapi.tiangolo.com/tutorial/security/>authentication methods</a> to control who gets access to the data<li><strong>Control</strong>: The consumer of the data only sees what you, the backend engineer expose to them! For example, if we do not want to expose the name of a person to the consumer, we can set up the endpoint that way in the API layer upfront.</ul><h3 id=a-common-downside-to-rest-apis>A common downside to REST APIs<a aria-label="Anchor link for: a-common-downside-to-rest-apis" class=zola-anchor href=#a-common-downside-to-rest-apis>#</a></h3><p>A common problem with RESTful APIs is that, in case a user wants a subset or a superset of the data exposed by an endpoint, they cannot change the request in a way that lets them fetch only what they want. As a result, it’s common for RESTful endpoints to over-fetch data that the user doesn’t need, or under-fetch data that they might need, and the only way to address this need is for the backend developer to define a new endpoint.<p>To address this issue, a different kind of API called <a rel="nofollow noreferrer" href=https://stablekernel.com/article/advantages-and-disadvantages-of-graphql/>GraphQL</a> was introduced. I’ll plan on covering this in a future blog post.<h2 id=code>Code<a aria-label="Anchor link for: code" class=zola-anchor href=#code>#</a></h2><p>All code for this post is available <a rel="nofollow noreferrer" href=https://github.com/prrao87/neo4j-python-fastapi>on GitHub</a>.<h2 id=additional-learning>Additional learning<a aria-label="Anchor link for: additional-learning" class=zola-anchor href=#additional-learning>#</a></h2><p>Here are some nice tutorials that helped me get up and running with Docker and FastAPI.<ol><li>“Learn how to set up a great dev environment in Docker”, Patrick Loeber, <a href="https://www.youtube.com/watch?v=0H2miBK_gAk&t=1s" rel="nofollow noreferrer">YouTube</a><li>Intro tutorial by Sebastian Ramirez, <a rel="nofollow noreferrer" href=https://fastapi.tiangolo.com/lo/tutorial/>FastAPI docs</a></ol></article><div class=giscus></div><script async crossorigin data-category=General data-category-id=DIC_kwDOKyWhTs4CbUSt data-emit-metadata=0 data-input-position=bottom data-lang=en data-loading=lazy data-mapping=pathname data-reactions-enabled=1 data-repo=thedataquarry/thedataquarry.github.io data-repo-id=R_kgDOKyWhTg data-strict=0 data-theme=preferred_color_scheme src=https://giscus.app/client.js></script></div><footer><div class=copyright><p>© 2024 Prashanth Rao</div><div class=credits>Powered by <a rel="noreferrer noopener" href=https://www.getzola.org target=_blank>zola</a> and <a rel="noreferrer noopener" href=https://github.com/isunjn/serene target=_blank>serene</a></div></footer></main></div><script src=/js/lightense.min.js></script><script src=/js/main.js></script>